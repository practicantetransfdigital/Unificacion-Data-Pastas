<script>
    let n2Reports = [];

    let currentUser = {
        cedula: '',
        nombre: '',
        rol: '',
        proceso_user: '',
        correo: '',
        empresa: ''
    };

    let consolidadoData = {
    n2: [],
    tarjetas: [],
    maquinas: [],
    ciclos: []
    };

    let tarjetasData = [];
    let selectedFilesN2 = [];
    let accionCausaActual = null;

       function handleLogin(event) {
        event.preventDefault();
        
        const cedula = document.getElementById('cedulaInput').value.trim();
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginBtnSpinner = document.getElementById('loginBtnSpinner');
        const loginError = document.getElementById('loginError');
        
        if (!cedula) {
            showLoginError('Por favor ingrese su c√©dula');
            return;
        }
        
        // Mostrar spinner
        loginBtn.disabled = true;
        loginBtnText.style.display = 'none';
        loginBtnSpinner.style.display = 'inline-block';
        loginError.style.display = 'none';
        
        // Validar c√©dula con el backend
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    // Obtener el nombre del usuario
                    google.script.run
                        .withSuccessHandler(function(userData) {
                            if (userData.success) {
                                currentUser.cedula = cedula;
                                currentUser.nombre = userData.nombre;
                                currentUser.rol = result.rol || '';
                                currentUser.proceso_user = result.proceso_user || '';
                                currentUser.correo = result.correo || '';
                                currentUser.empresa = result.empresa || '';
                                
                                // Guardar sesi√≥n en localStorage
                                localStorage.setItem('userSession', JSON.stringify(currentUser));
                                loadLeaders()
                                // Mostrar la aplicaci√≥n
                                showApp();
                                showAlert("success", "Sesi√≥n iniciada", "Bienvenido al sistema"); 
                            } else {
                                showLoginError('No se pudo obtener la informaci√≥n del usuario');
                                resetLoginButton();
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error al obtener nombre:', error);
                            showLoginError('Error al obtener informaci√≥n del usuario');
                            resetLoginButton();
                        })
                        .getNombreByCedula(cedula);
                } else {
                    showLoginError('C√©dula no encontrada. Verifique e intente nuevamente.');
                    resetLoginButton();
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error en login:', error);
                showLoginError('Error al validar la c√©dula. Intente nuevamente.');
                resetLoginButton();
            })
            .validarCedula(cedula);
    }
    
    function showLoginError(message) {
        const loginError = document.getElementById('loginError');
        loginError.textContent = message;
        loginError.style.display = 'block';
    }
    
    function resetLoginButton() {
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginBtnSpinner = document.getElementById('loginBtnSpinner');
        
        loginBtn.disabled = false;
        loginBtnText.style.display = 'inline';
        loginBtnSpinner.style.display = 'none';
    }
    
    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.nombre;
        console.log(currentUser)

        showReportForm('tarjeta');

        document.querySelectorAll('.report-btn').forEach(btn => {
              btn.classList.remove('active'); // quitar active de todos
        });
        const btnTA = document.querySelector('.report-btn[onclick*="tarjeta"]');
        if (btnTA) btnTA.classList.add('active');

        const nombreCedulaInput = document.getElementById('nombreCedula');
        if (nombreCedulaInput) {
            nombreCedulaInput.value = `${currentUser.nombre}`;
            nombreCedulaInput.readOnly = true;
    }

        const nombreMecanicoInput = document.getElementById('nombreMecanico');
        if (nombreMecanicoInput) {
            nombreMecanicoInput.value = `${currentUser.nombre}`;
            nombreMecanicoInput.readOnly = true;
    }
  }
    
function handleLogout() {
    // üîπ Elimina la sesi√≥n
    localStorage.removeItem('userSession');
    currentUser = { cedula: '', nombre: '', rol: '', proceso_user: '', correo: '', empresa: ''};

    // üîπ Resetear variables globales
    if (typeof n2Reports !== "undefined") n2Reports = [];
    if (typeof leadersData !== "undefined") leadersData = [];
    if (typeof tarjetas !== "undefined") tarjetas = [];

    // üîπ Resetear formularios
    document.querySelectorAll("form").forEach(form => form.reset());

    // üîπ Ocultar todos los formularios din√°micos
    document.querySelectorAll(".report-form").forEach(form => {
        form.style.display = "none";
        form.classList.remove("active");
    });

    // üîπ Resetear botones de reportes
    document.querySelectorAll(".report-btn").forEach(btn => {
        btn.classList.remove("active");
    });

    // üîπ Vaciar contenedores de reportes
    document.querySelectorAll(".cards-container").forEach(container => {
        container.innerHTML = "";
    });

    // üîπ Resetear contadores
    document.querySelectorAll("[id$='-count']").forEach(countEl => {
        countEl.textContent = "0";
    });

    // üîπ Resetear b√∫squeda
    const searchInput = document.getElementById("liderSearch");
    if (searchInput) searchInput.value = "";

    const searchResults = document.getElementById("searchResults");
    if (searchResults) searchResults.style.display = "none";

    // üîπ Oculta la app y vuelve a mostrar el login
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('cedulaInput').value = '';
    document.getElementById('loginError').style.display = 'none';

    // üîπ Reset bot√≥n de login
    resetLoginButton();

    // üîπ Alerta de confirmaci√≥n
    showAlert("success", "Sesi√≥n cerrada", "Has salido del sistema"); 
}
    
    function checkSession() {
        const savedSession = localStorage.getItem('userSession');
        
        if (savedSession) {
            try {
                currentUser = JSON.parse(savedSession);
                showApp();
            } catch (error) {
                console.error('Error al recuperar sesi√≥n:', error);
                localStorage.removeItem('userSession');
            }
        }
    }

function showPage(pageId, event) {
    // Ocultar todas las p√°ginas
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Remover clase active de todos los nav-tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar p√°gina seleccionada
    const pageEl = document.getElementById(pageId);
    if (pageEl) pageEl.classList.add('active');

    // L√≥gica mejorada para marcar tab activo
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Si es una p√°gina del dropdown, marcar el dropdown como activo
        if (pageId === 'consolidado' || pageId === 'realizar-reporte') {
            const reportesDropdown = document.getElementById('reportesDropdownToggle');
            if (reportesDropdown) reportesDropdown.classList.add('active');
        } else if (pageId === 'n2' || pageId === 'tarjetas' || pageId === 'anormalidades' || pageId === 'ciclos') {
            const gestionDropdown = document.getElementById('gestionDropdownToggle');
            if (gestionDropdown) gestionDropdown.classList.add('active');
        } else {
            // Fallback: buscar el bot√≥n nav-tab que contiene el pageId
            const fallbackTab = document.querySelector(`.nav-tab[onclick*="${pageId}"]`);
            if (fallbackTab) fallbackTab.classList.add('active');
        }
    }
    
    // Cerrar dropdowns cuando se selecciona una opci√≥n
    if (pageId === 'consolidado' || pageId === 'realizar-reporte') {
        hideReportesDropdown();
    }
    if (pageId === 'n2' || pageId === 'tarjetas' || pageId === 'anormalidades' || pageId === 'ciclos') {
        hideGestionDropdown();
    }
    
    // Cargar datos seg√∫n la p√°gina (tu c√≥digo existente)
    if (pageId === 'n2') {
        loadN2Reports();
        loadCommentsCount();
    }
    if (pageId === 'tarjetas') {
        loadTarjetasReports();
    }
    if (pageId === 'anormalidades') {
        loadMaquinasReports();
    }
    if (pageId === 'ciclos') {
        loadCiclosMejora();
    }
    if (pageId === 'consolidado') {
        loadConsolidadoReports();
    }
}

function showReportForm(formType, event) {
    // Ocultar todos los formularios
    document.querySelectorAll('.report-form').forEach(form => {
        form.classList.remove('active');
        form.style.display = "none";
    });

    // Quitar la clase activa de todos los botones
    document.querySelectorAll('.report-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Mostrar el formulario seleccionado
    const form = document.getElementById('form-' + formType);
    if (form) {
        form.classList.add('active');
        form.style.display = "block";
    }

    // Marcar el bot√≥n clicado como activo
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // fallback: intenta seleccionar el button cuyo onclick contenga "'formType'"
        const fallbackBtn = document.querySelector(`.report-btn[onclick*="'${formType}'"]`) 
                         || document.querySelector(`.report-btn[onclick*="${formType}"]`);
        if (fallbackBtn) fallbackBtn.classList.add('active');
    }

    // Si el formulario es la tarjeta, establece la fecha de creaci√≥n
    const fechaField = document.getElementById('fechaCreacionTarjeta');
    if (fechaField) setFechaCreacionTarjeta();
}

    let leadersData = [];

    // Load leaders from Google Sheets
    function loadLeaders() {
        google.script.run
            .withSuccessHandler(function(leaders) {
                leadersData = leaders;
                populateLeadersDropdown(leaders);
                console.log('Leaders loaded:', leadersData.length);
            })
            .withFailureHandler(handleError)
            .getLeaders();
    }

    function populateLeadersDropdown(leaders) {
        const select = document.getElementById('liderResponsable');
        if (select) {
            select.innerHTML = '<option value="">L√≠der responsable</option>';
            
            leaders.forEach(leader => {
                const option = document.createElement('option');
                option.value = leader.cedula;
                option.textContent = `${leader.nombre} - ${leader.cedula}`;
                select.appendChild(option);
            });
        }
    }

function searchLeaders(query) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const searchTerm = query.toLowerCase();

    const filteredLeaders = leadersData.filter(leader => {
        const texto = leader.info ? leader.info.toLowerCase() : "";
        return texto.includes(searchTerm);
    });

    displaySearchResults(filteredLeaders);
}

function displaySearchResults(leaders) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (leaders.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        resultsContainer.innerHTML = leaders.map(leader => `
            <div class="search-result-item" onclick="selectLeader('${leader.info}')">
                <div class="search-result-name">${leader.info}</div>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}


function selectLeader(info) {
    document.getElementById('liderSearch').value = info; 
    document.getElementById('selectedLeaderCedula').value = info; 
    document.getElementById('searchResults').style.display = 'none';
}


    function showSearchResults() {
        const query = document.getElementById('liderSearch').value;
        if (query.length >= 2) {
            searchLeaders(query);
        }
    }

    document.addEventListener('click', function(event) {
        const searchContainer = document.querySelector('.search-container');
        if (searchContainer && !searchContainer.contains(event.target)) {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
        }
    });

function loadN2Reports() {
  showLoadingSpinner();
  
  google.script.run
    .withSuccessHandler(function(reports) {
      console.log('[FRONTEND] getN2Reports devolvi√≥:', reports, Array.isArray(reports));
      displayN2Reports(reports);
      loadCommentsCount();
    })
    .withFailureHandler(function(err) {
      console.error('[FRONTEND] Error al llamar getN2Reports:', err);
      handleN2Error(err);
    })
    .getN2Reports();
}

    function showLoadingSpinner() {
        const containers = document.querySelectorAll('.cards-container');
        containers.forEach(container => {
            container.innerHTML = '<div class="loading-spinner">Cargando reportes...</div>';
        });
    }

function displayN2Reports(reports) {
    console.log('[v0] Reports received from backend:', reports);
    
    if (!Array.isArray(reports)) {
        reports = [];
    }

    // üîπ Aqu√≠ guardamos todos los reportes para poder buscarlos despu√©s
    n2Reports = reports;  

    console.log('[v0] Guardados en n2Reports:', n2Reports.length);

    // Limpiar contenedores
    const containers = document.querySelectorAll('.cards-container');
    containers.forEach(container => {
        container.innerHTML = '';
    });

    // Agrupar y mostrar...
    const reportsByStatus = {
        'Pendiente': [],
        'En Progreso': [],
        'En Revision': [],
        'Completado': []
    };

    reports.forEach(report => {
        const status = report.estado || 'Pendiente';
        if (reportsByStatus[status]) {
            reportsByStatus[status].push(report);
        }
    });

    Object.entries(reportsByStatus).forEach(([status, statusReports]) => {
        const containerId = status.toLowerCase().replace(' ', '-') + '-cards';
        const countId = status.toLowerCase().replace(' ', '-') + '-count';
        
        const container = document.getElementById(containerId);
        const countElement = document.getElementById(countId);
        
        if (container && countElement) {
            countElement.textContent = statusReports.length;
            
            if (statusReports.length === 0) {
                container.innerHTML = `
                    <div class="empty-column">
                        <span>No hay reportes</span>
                    </div>
                `;
            } else {
                statusReports.forEach(report => {
                    container.appendChild(createReportCard(report));
                });
            }
        }
    });
}

function updateReportCounts() {
  const statuses = ['Pendiente', 'En Progreso', 'En Revision', 'Completado'];

  statuses.forEach(status => {
    const containerId = status.toLowerCase().replace(' ', '-') + '-cards';
    const countId = status.toLowerCase().replace(' ', '-') + '-count';

    const container = document.getElementById(containerId);
    const countElement = document.getElementById(countId);

    if (container && countElement) {
      // üîπ Cuenta solo las tarjetas visibles
      const visibleCards = container.querySelectorAll('.report-card:not([style*="display: none"])');
      countElement.textContent = visibleCards.length;
    }
  });
}

function createReportCard(report) {
    const card = document.createElement('div');
    card.className = 'report-card';
    card.setAttribute('data-report-id', report.id);

    let dueDateClass = '';
    let dueDateText = '';
    let editButton = '';

    if (report.estado !== 'Completado') {
        const dueDate = new Date(report.fechaSolucion);
        const today = new Date();

        today.setHours(0, 0, 0, 0);
        dueDate.setHours(0, 0, 0, 0);

        const diffTime = dueDate - today;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        dueDateText = formatDate(dueDate);

        if (diffDays < 0) {
            dueDateClass = 'overdue';
            dueDateText += ' (Vencido)';
        } else if (diffDays === 0) {
            dueDateClass = 'due-today';
            dueDateText += ' (Vence hoy)';
        } else if (diffDays <= 3) {
            dueDateClass = 'due-soon';
            dueDateText += ` (Faltan ${diffDays} d√≠as)`;
        }

        editButton = `
            <button 
                class="edit-date-btn" 
                title="Editar fecha"
                onclick="showChangeDateModal('${report.id}', '${report.fechaSolucion}')"
                style="background:none; border:none; cursor:pointer; margin-left:6px; color:#1E88E5; vertical-align:middle;"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9" />
                    <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                </svg>
            </button>
        `;
    } else {
        dueDateText = formatDate(new Date(report.fechaSolucion));
    }

    const cardHTML = [
        '<div class="card-header">',
        '<span class="card-id">' + (report.id || '') + '</span>',
        '<span class="card-date">' + (formatDate(report.fechaRegistro) || '') + '</span>',
        '</div>',
        '<div class="card-description">' + (report.liderResponsable || '') + '</div>',
        '<div class="card-title">' + (report.proceso || '') + '</div>',
        '<div class="card-description">' + (report.zonaProceso || '') + '</div>',
        '<div class="card-description">' + (report.anormalidad || '') + '</div>',
        '<div class="card-images" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;margin-bottom:15px;"></div>',
        '<div class="card-meta">',
        '<span class="card-process">' + (report.procesoResponsable || '') + '</span>',
        '<span class="card-due-date ' + dueDateClass + '">' + dueDateText + editButton + '</span>',
        '<span class="comment-count" id="comment-count-' + report.id + '" style="color:black; border-radius:8px; padding:2px 6px; font-size:12px; margin-left:8px;">0</span>',
        '</div>',
        '<div class="card-actions">',
        '<button class="card-action-btn" onclick="viewReportDetails(\'' + report.id + '\')">Ver</button>',
        '<button class="card-action-btn" onclick="showCommentsModal(\'' + report.id + '\')">Comentarios</button>',
        '<button class="card-action-btn" onclick="showChangeResponsibleModal(\'' + report.id + '\')">Reasignar</button>',
        '<button class="card-action-btn" onclick="changeReportStatus(\'' + report.id + '\')">Cambiar Estado</button>',
        '</div>'
    ].join('');

    card.innerHTML = cardHTML;
    card.innerHTML = cardHTML;
    const imagesContainer = card.querySelector('.card-images');

    if (report.fotos && report.fotos.length > 0) {
        console.log("üñºÔ∏è Fotos disponibles (Base64):", report.fotos.length);
        
        // ‚úÖ GUARDAR COPIA LOCAL DE LAS FOTOS
        const fotosLocal = [...report.fotos];
        
        report.fotos.forEach((fotoBase64, i) => {
            const img = document.createElement('img');
            img.alt = 'Foto ' + (i + 1);
            img.className = 'card-img-thumb';

            img.src = fotoBase64;

            // Estilos
            img.style.width = '70px';
            img.style.height = '70px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '1px solid #ccc';
            img.style.cursor = 'pointer';
            img.style.margin = '2px';
            img.style.transition = 'transform 0.2s ease';

            // ‚úÖ FUNCI√ìN MEJORADA - Usar closure para capturar la foto correcta
            const setupImageClick = (fotoData) => {
                img.addEventListener('click', function() {
                    console.log("üñ±Ô∏è Clic en imagen - Expandir");
                    expandImage(fotoData);
                });
            };

            // Llamar la funci√≥n con la foto correspondiente
            setupImageClick(fotosLocal[i]);

            // Efectos hover
            img.addEventListener('mouseover', function() {
                this.style.transform = 'scale(1.1)';
            });
            img.addEventListener('mouseout', function() {
                this.style.transform = 'scale(1)';
            });

            imagesContainer.appendChild(img);
        });
    }

    return card;
}

// Inicializar dropzone para N2
function initializeN2Dropzone() {
    const dropZoneN2 = document.getElementById('dropZoneN2');
    const fileInputN2 = document.getElementById('fileInputN2');
    const previewContainerN2 = document.getElementById('previewContainerN2');

    if (!dropZoneN2) {
        console.log("‚ùå dropZoneN2 no encontrado");
        return;
    }

    // Evento clic: abre selector de archivos
    dropZoneN2.addEventListener('click', () => fileInputN2.click());

    // Arrastrar y soltar
    dropZoneN2.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZoneN2.classList.add('dragover');
    });

    dropZoneN2.addEventListener('dragleave', () => {
        dropZoneN2.classList.remove('dragover');
    });

    dropZoneN2.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZoneN2.classList.remove('dragover');
        handleFilesN2(e.dataTransfer.files);
    });

    fileInputN2.addEventListener('change', (e) => handleFilesN2(e.target.files));
}

// Manejo de archivos para N2
function handleFilesN2(files) {
    for (let file of files) {
        if (!file.type.startsWith('image/')) continue;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // ‚úÖ Esto deber√≠a ser Base64 como data:image/jpeg;base64,...
            selectedFilesN2.push(e.target.result);
            console.log("üì∏ Archivo convertido a Base64:", e.target.result.substring(0, 50) + "...");
            
            const div = document.createElement('div');
            div.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = e.target.result; // ‚úÖ Usar Base64 directamente
            img.alt = 'preview';
            
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = '√ó';
            button.onclick = function() {
                removeImageN2(e.target.result);
            };
            
            div.appendChild(img);
            div.appendChild(button);
            document.getElementById('previewContainerN2').appendChild(div);
        };
        reader.readAsDataURL(file); // ‚úÖ Esto convierte a Base64
    }
}

// Quitar una imagen de la vista previa N2
function removeImageN2(base64) {
    selectedFilesN2 = selectedFilesN2.filter(img => img !== base64);
    const container = document.getElementById('previewContainerN2');
    const items = container.getElementsByClassName('preview-item');
    
    for (let item of items) {
        if (item.querySelector('img').src === base64) {
            item.remove();
            break;
        }
    }
}

// Limpiar zona de im√°genes N2
function limpiarDropZoneN2() {
    selectedFilesN2 = [];
    const previewContainer = document.getElementById('previewContainerN2');
    if (previewContainer) previewContainer.innerHTML = '';
    const dropZone = document.getElementById('dropZoneN2');
    if (dropZone) dropZone.innerHTML = '<p>Arrastra tus im√°genes aqu√≠ o haz clic para seleccionarlas</p>';
}

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function handleN2Error(error) {
        console.error('Error loading N2 reports:', error);
        const containers = document.querySelectorAll('.cards-container');
        containers.forEach(container => {
            container.innerHTML = `
                <div class="empty-column">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span>Error al cargar reportes</span>
                </div>
            `;
        });
        showAlert('error', 'Error', 'No se pudieron cargar los reportes: ' + error.message);
    }

    function viewReportDetails(reportId) {
        const report = n2Reports.find(r => r.id === reportId);
        if (report) {
showAlert('info', `Reporte ${reportId}`, 
    `<br><strong>Proceso:</strong> ${report.proceso}\n <br><br>
    <strong>L√≠der:</strong> ${report.liderResponsable}\n <br><br>
    <strong>Anormalidad:</strong> ${report.anormalidad}\n <br><br>
    <strong>Proceso Responsable:</strong> ${report.procesoResponsable}\n <br><br>
    <strong>Fecha Soluci√≥n:</strong> ${formatDate(report.fechaSolucion)}\n <br><br>
    <strong>Estado:</strong> ${report.estado}`, 
    8000);

        }
    }

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, s => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]
  ));
}

function showCommentsModal(reportId) {
  // Eliminar modal existente si ya hay uno
  const existingModal = document.getElementById('commentModal');
  if (existingModal) existingModal.remove();

  // Overlay (igual que el de "Cambiar Estado")
  const overlay = document.createElement('div');
  overlay.id = 'commentModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  // Contenedor del modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

  modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600; margin:0;">
      <i class="fa-regular fa-comments"></i> Comentarios del reporte
    </h2>

    <div id="commentsList" style="
      max-height:240px; overflow:auto; border:1px solid #e2e8f0;
      border-radius:8px; padding:0.75rem; background:#f8fafc;
    ">
      <div style="text-align:center; color:#94a3b8;">Cargando comentarios...</div>
    </div>

    <textarea id="newComment" placeholder="Escribe tu comentario..." rows="3"
      style="width:100%; padding:0.75rem; border:1px solid #cbd5e1; border-radius:8px; resize:vertical;"></textarea>

    <div style="display:flex; justify-content:flex-end; gap:0.75rem;">
      <button id="cancelComment" style="
        padding:0.5rem 1rem; border:1px solid #cbd5e1;
        border-radius:8px; cursor:pointer; background:#fff;
      ">Cancelar</button>

      <button id="saveComment" style="
        padding:0.5rem 1rem; border:none; background:#3b82f6;
        color:#fff; border-radius:8px; cursor:pointer;
      ">Guardar</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const commentsList = modal.querySelector('#commentsList');
  const textarea = modal.querySelector('#newComment');
  const saveBtn = modal.querySelector('#saveComment');

  // === Funci√≥n para cargar comentarios ===
  function loadComments() {
    google.script.run
      .withSuccessHandler(comments => {
        if (!comments || comments.length === 0) {
          commentsList.innerHTML = `<div style="color:#94a3b8;">No hay comentarios todav√≠a</div>`;
          return;
        }

        commentsList.innerHTML = comments.map(c => `
          <div style="padding:0.5rem 0; border-bottom:1px solid #e2e8f0;">
            <div style="font-weight:600; color:#0f172a; font-size:13px;">${escapeHtml(c.autor)}</div>
            <div style="font-size:12px; color:#94a3b8;">${escapeHtml(c.fecha)}</div>
            <div style="margin-top:4px; font-size:14px; color:#334155;">${escapeHtml(c.comentario)}</div>
          </div>
        `).join('');
        commentsList.scrollTop = commentsList.scrollHeight;
      })
      .withFailureHandler(err => {
        console.error(err);
        commentsList.innerHTML = `<div style="color:#ef4444;">Error al cargar comentarios</div>`;
      })
      .getCommentsForReport(reportId);
  }

  // === Cargar comentarios iniciales ===
  loadComments();
  loadCommentsCount(); // actualiza contadores globalmente


  // === Bot√≥n Cancelar ===
  modal.querySelector('#cancelComment').addEventListener('click', () => overlay.remove());

  // === Bot√≥n Guardar ===
  saveBtn.addEventListener('click', () => {
    const comment = textarea.value.trim();
    if (!comment) {
      showAlert('warning', 'Campo vac√≠o', 'Debes escribir un comentario');
      return;
    }

    // Obtener autor desde el cliente
    const autor = (typeof currentUser !== 'undefined' && (currentUser.nombre || currentUser.cedula))
      ? (currentUser.nombre || currentUser.cedula)
      : 'Usuario desconocido';

    // Desactivar bot√≥n mientras guarda
    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', 'Comentario agregado', 'Se guard√≥ correctamente');
        textarea.value = '';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
        loadComments(); // recargar comentarios
        loadCommentsCount(); // actualiza contadores globalmente
      })
      .withFailureHandler(err => {
        console.error(err);
        showAlert('error', 'Error', 'No se pudo guardar el comentario');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      })
      .addCommentToReport(reportId, comment, autor);
  });

  // === Cerrar al hacer clic fuera ===
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.remove();
  });
}

function showChangeResponsibleModal(reportId) {
  const existingModal = document.getElementById('responsibleModal');
  if (existingModal) existingModal.remove();

  const overlay = document.createElement('div');
  overlay.id = 'responsibleModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

  modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600;">
      <i class="fa-regular fa-user"></i> Reasignar Responsable
    </h2>

    <div class="search-container" style="position:relative; width:100%;">
      <input type="text" 
        id="liderSearch" 
        class="search-input" 
        placeholder="Buscar por c√©dula o nombre..."
        autocomplete="off"
        required
        style="width:100%; padding:0.6rem 0.8rem; border:1px solid #cbd5e1; border-radius:8px; font-size:14px;">

      <div id="searchResults" 
        class="search-results" 
        style="
          position:absolute; 
          top:105%; left:0; right:0; 
          background:white; 
          border:1px solid #cbd5e1; 
          border-radius:8px; 
          max-height:220px; 
          overflow-y:auto; 
          z-index:10001;
          display:none;
          box-shadow:0 4px 12px rgba(0,0,0,0.1);
        ">
      </div>

      <input type="hidden" id="selectedLeaderCedula" name="liderResponsable">
    </div>

    <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
      <button id="cancelReassign" 
        style="padding:0.5rem 1rem; border:1px solid #cbd5e1; border-radius:8px; cursor:pointer;">
        Cancelar
      </button>
      <button id="saveReassign" 
        style="padding:0.5rem 1rem; border:none; background:#3b82f6; color:#fff; border-radius:8px; cursor:pointer;">
        Guardar
      </button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const input = modal.querySelector('#liderSearch');
  const resultsContainer = modal.querySelector('#searchResults');
  const hiddenInput = modal.querySelector('#selectedLeaderCedula');

  let selectedCedula = '';

  input.addEventListener('input', () => {
    const query = input.value.trim().toLowerCase();

    if (!query || query.length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }

    const filtered = leadersData.filter(l =>
      (l.info && l.info.toLowerCase().includes(query))
    );

    if (filtered.length === 0) {
      resultsContainer.innerHTML = '<div style="padding:8px;">No se encontraron resultados</div>';
      resultsContainer.style.display = 'block';
      return;
    }

    resultsContainer.innerHTML = filtered.map(l => `
      <div class="search-result-item"
        data-cedula="${l.info}"  // ‚úÖ Aqu√≠ usamos l.info en lugar de l.cedula
        style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;"
        onmouseover="this.style.background='#f1f5f9'"
        onmouseout="this.style.background='white'">
        ${l.info}
      </div>
    `).join('');

    resultsContainer.querySelectorAll('.search-result-item').forEach((item, index) => {
      item.addEventListener('click', () => {
        const leader = filtered[index];
        // ‚úÖ Guardamos el string completo (nombre + c√©dula) que est√° en l.info
        selectedCedula = leader.info;
        hiddenInput.value = leader.info;
        input.value = leader.info;
        resultsContainer.style.display = 'none';
        
        console.log('L√≠der seleccionado:', leader.info);
      });
    });

    resultsContainer.style.display = 'block';
  });

  resultsContainer.addEventListener('mousedown', e => e.preventDefault());

  modal.querySelector('#cancelReassign').addEventListener('click', () => overlay.remove());

  modal.querySelector('#saveReassign').addEventListener('click', () => {
    const cedula = selectedCedula || hiddenInput.value.trim();
    
    if (!cedula) {
      showAlert('warning', 'Campo vac√≠o', 'Debes seleccionar un responsable');
      return;
    }

    console.log('Enviando al servidor:', cedula);

    overlay.remove();
    showAlert('info', 'Actualizando...', 'Reasignando responsable...', 2000);

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', '√âxito', 'Responsable actualizado correctamente');
        reloadReportsKeepFilters();
      })
      .withFailureHandler(err => {
        console.error(err);
        showAlert('error', 'Error', 'No se pudo actualizar el responsable');
      })
      .updateReportResponsible(reportId, cedula);
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

function changeReportStatus(reportId) {
  showStatusModal(reportId);
}

function showStatusModal(reportId) {
  const statusOptions = [
    { value: 'Pendiente', label: 'Pendiente', color: '#6c757d' },
    { value: 'En Progreso', label: 'En Progreso', color: '#007bff' },
    { value: 'En Revision', label: 'En Revision', color: '#fd7e14' },
    { value: 'Completado', label: 'Completado', color: '#28a745' }
  ];

  // Eliminar modal existente
  const existingModal = document.getElementById('statusModal');
  if (existingModal) existingModal.remove();

  // Overlay
  const overlay = document.createElement('div');
  overlay.id = 'statusModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  // Contenido
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  `;

  modal.innerHTML = `
    <h2 style="margin-bottom: 1rem; font-size: 18px; font-weight: 600; color: #1e293b; text-align:center">
      Cambiar Estado
    </h2>
    <div id="statusOptionsContainer" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
    <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
      <button id="cancelBtn" style="padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer;">Cancelar</button>
      <button id="confirmBtn" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: #fff; border-radius: 8px; cursor: pointer;" disabled>Confirmar</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  // Insertar opciones din√°micamente
  const container = modal.querySelector('#statusOptionsContainer');
  statusOptions.forEach(opt => {
    const div = document.createElement('div');
    div.className = 'status-option';
    div.dataset.status = opt.value;
    div.style.cssText = `
      padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px;
      cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
    `;
    div.innerHTML = `
      <div style="width:12px; height:12px; border-radius:50%; background:${opt.color};"></div>
      <span>${opt.label}</span>
    `;
    container.appendChild(div);
  });

  let selectedStatus = null;

  // Manejo de selecci√≥n
  container.querySelectorAll('.status-option').forEach(option => {
    option.addEventListener('click', () => {
      container.querySelectorAll('.status-option').forEach(o => {
        o.style.borderColor = '#e2e8f0';
        o.style.background = '#fff';
      });
      option.style.borderColor = '#3b82f6';
      option.style.background = 'rgba(59,130,246,0.05)';
      selectedStatus = option.dataset.status;
      modal.querySelector('#confirmBtn').disabled = false;
    });
  });

  // Bot√≥n cancelar
  modal.querySelector('#cancelBtn').addEventListener('click', () => overlay.remove());

  // Bot√≥n confirmar
  modal.querySelector('#confirmBtn').addEventListener('click', () => {
    if (!selectedStatus) return;
    overlay.remove();

    showAlert('info', 'Actualizando...', 'Cambiando estado del reporte', 2000);

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', '¬°√âxito!', `Estado cambiado a "${selectedStatus}"`);
        reloadReportsKeepFilters();
      })
      .withFailureHandler(err => {
        console.error('Error:', err);
        showAlert('error', 'Error', 'No se pudo actualizar el estado');
      })
      .updateReportStatus(reportId, selectedStatus);
  });

  // Cerrar modal clickeando afuera
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

    function showAlert(type, title, message, duration = 5000) {
        // Create alert container if it doesn't exist
        let alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.id = 'alertContainer';
            alertContainer.className = 'alert-container';
            document.body.appendChild(alertContainer);
        }

        // Create alert element
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        
        const iconSymbols = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: 'i'
        };

        alert.innerHTML = `
            <div class="alert-icon">${iconSymbols[type] || 'i'}</div>
            <div class="alert-content">
                <div class="alert-title">${title}</div>
                <div class="alert-message">${message}</div>
            </div>
            <button class="alert-close" onclick="closeAlert(this)">&times;</button>
            <div class="alert-progress"></div>
        `;

        alertContainer.appendChild(alert);

        // Show alert with animation
        setTimeout(() => {
            alert.classList.add('show');
        }, 100);

        // Auto remove alert
        setTimeout(() => {
            closeAlert(alert.querySelector('.alert-close'));
        }, duration);
    }

    function closeAlert(closeBtn) {
        const alert = closeBtn.closest('.alert');
        alert.classList.remove('show');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 400);
    }

    function handleError(error) {
        console.error('Error:', error);
        showAlert('error', 'Error', 'Error al cargar los datos: ' + error.message);
    }

    // Form submission
function submitN2Form(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('.submit-btn');
    buttonStateManager.bloquear(submitBtn, 'Enviar Reporte');

    const selectedCedula = document.getElementById('selectedLeaderCedula').value;
    if (!selectedCedula) {
        alert('Por favor seleccione un l√≠der responsable de la lista');
        buttonStateManager.desbloquear(submitBtn); 
        return;
    }

    let zonaProceso = "";
    const zonaProcesoInput = document.getElementById('zonaProceso');
    if (zonaProcesoInput) {
        zonaProceso = zonaProcesoInput.value;
    }

    const otroInput = document.getElementById('otroProceso');
    if (otroInput && otroInput.value.trim() !== "") {
        zonaProceso = otroInput.value.trim();
    }

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const fechaLocal = `${year}-${month}-${day} ${hour}:${minute}`;

    const formData = {
        liderResponsable: selectedCedula,
        proceso: document.getElementById('proceso').value,
        zonaProceso: zonaProceso,
        anormalidad: document.getElementById('anormalidad').value,
        procesoResponsable: document.getElementById('procesoResponsable').value,
        fechaSolucion: document.getElementById('fechaSolucion').value,
        tipoReporte: 'N2',
        fecha: fechaLocal,
        nombreCedula: document.getElementById('nombreCedula').value,
        fotos: selectedFilesN2 || [] // ‚úÖ Esto ya es Base64 igual que tarjetas
    };

    console.log("üì∏ Fotos a enviar N2 (Base64):", formData.fotos.length);
    if (formData.fotos.length > 0) {
        console.log("üì∏ Primera foto (primeros 100 chars):", formData.fotos[0].substring(0, 100));
    }

    showAlert('info', 'Enviando...', 'Procesando su reporte, por favor espere', 3000);

    google.script.run
        .withSuccessHandler(function(response) {
            buttonStateManager.desbloquear(submitBtn);
            handleSubmitSuccess(response);
        })
        .withFailureHandler(function(error) {
            buttonStateManager.desbloquear(submitBtn);
            handleError(error);
        })
        .submitN2Report(formData);
}

    function handleSubmitSuccess(result) {
        showAlert('success', '¬°√âxito!', 'Reporte N2 enviado exitosamente');
        document.getElementById('n2Form').reset();
        limpiarDropZoneN2();
    }

    // CAMPOS DINAMICOS DEL FORM DE N2

  const zonaProceso = document.getElementById("zonaProceso");
  const otroProceso = document.getElementById("otroProceso");
  const proceso = document.getElementById("proceso");

  // Opciones din√°micas por proceso
  const opcionesPorProceso = {
    Pastificio: [
      "L√≠nea A", "L√≠nea B", "L√≠nea C", "L√≠nea D",
      "SIRCEM", "Girapasta"
    ],
    Empaque: [
      "M√°quina 02", "M√°quina 03", "M√°quina 04", "M√°quina 05", "M√°quina 06",
      "M√°quina 17", "M√°quina 18", "M√°quina 19", "M√°quina 20", "M√°quina 21",
      "Encartonadora PL", "Encartonadora PC", "Empaque Fideo Nestle",
      "Tolvas de Verduras", "Vaso", "Celdas Rob√≥ticas", "CEMPA"
    ],
    Molino: [
      "Dechinadora", "Sortex", "Plansifter", "Bancos Molienda",
      "Sasores", "B√°sculas"
    ],
    CEDI: [
      "Racks", "Pasillos", "Muelles", "Recepci√≥n", "Cuarto de Cargue Bater√≠as"
    ],
    Mantenimiento: [
      "Red contraincendios", "Taller", "Cuarto de lubricantes", "Caldera", "Compresores y Bomba de vacio",
      "Torres de enfriamiento", "Contenedores", "Aire ambiente Pastificio", "Oficinas"
    ],
    Almacenes: [
      "Racks", "Pasillos", "Muelles", "Recepci√≥n", "Cuarto de Cargue Bater√≠as"
    ]
  };

  // Cuando cambia el proceso, actualizar las zonas
  proceso.addEventListener("change", () => {
    const seleccionado = proceso.value;
    zonaProceso.innerHTML = '<option value="">Selecciona zona</option>'; // reset

    if (opcionesPorProceso[seleccionado]) {
      opcionesPorProceso[seleccionado].forEach(op => {
        const option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        zonaProceso.appendChild(option);
      });
    }

    // Habilitar ambos otra vez
    zonaProceso.disabled = false;
    otroProceso.disabled = false;
  });

  // L√≥gica: solo uno se puede llenar
  zonaProceso.addEventListener("change", () => {
    if (zonaProceso.value) {
      otroProceso.disabled = true;
      otroProceso.value = "";
    } else {
      otroProceso.disabled = false;
    }
  });

  otroProceso.addEventListener("input", () => {
    if (otroProceso.value.trim() !== "") {
      zonaProceso.disabled = true;
      zonaProceso.value = "";
    } else {
      zonaProceso.disabled = false;
    }
  });

  //FILTRO POR PROCESO

function applyCombinedFilters() {
  const selectedProcess = document.getElementById("ProcessFilter").value;
  const selectedRespo = document.getElementById("ProcessRespo").value;
  const searchQuery = document.getElementById("searchByName").value.toLowerCase();
  const selectedReportFilter = document.getElementById("reportFilter").value;

  if (!Array.isArray(n2Reports) || n2Reports.length === 0) return;

  // üîπ Empezamos filtrando desde los datos base
  let filteredReports = [...n2Reports];

  // 1Ô∏è‚É£ FILTRO: Tipo de Reporte (basado en currentUser)
  switch (selectedReportFilter) {
    case "myReports": // creados por el usuario
      filteredReports = filteredReports.filter(r => 
        r.nombreCedula && r.nombreCedula.includes(currentUser.cedula)
      );
      break;

    case "assignedToMe": // donde el usuario es l√≠der responsable
      filteredReports = filteredReports.filter(r => 
        r.liderResponsable && r.liderResponsable.includes(currentUser.cedula)
      );
      break;

    case "myProcess": // del proceso del usuario
      filteredReports = filteredReports.filter(r => 
        r.proceso && r.proceso.toLowerCase() === currentUser.proceso_user.toLowerCase()
      );
      break;

    default:
      // mostrar todos
      break;
  }

  // 2Ô∏è‚É£ FILTRO: Proceso (ProcessFilter)
  if (selectedProcess !== "allProcess") {
    const procesoName = selectedProcess.replace("Process", "");
    filteredReports = filteredReports.filter(r => 
      r.proceso && r.proceso.trim() === procesoName
    );
  }

  // 3Ô∏è‚É£ FILTRO: Responsable de Proceso (ProcessRespo)
  if (selectedRespo !== "all") {
    filteredReports = filteredReports.filter(r => 
      r.procesoResponsable && r.procesoResponsable.trim() === selectedRespo
    );
  }

  // 4Ô∏è‚É£ FILTRO: B√∫squeda por nombre (campo visible en la tarjeta)
  if (searchQuery) {
    filteredReports = filteredReports.filter(r => 
      (r.liderResponsable && r.liderResponsable.toLowerCase().includes(searchQuery)) ||
      (r.descripcion && r.descripcion.toLowerCase().includes(searchQuery))
    );
  }

  console.log("üîç Verificaci√≥n de Base64 en reportes filtrados:");
filteredReports.forEach((report, index) => {
    if (report.fotos && report.fotos.length > 0) {
        console.log(`   Reporte ${index} (${report.id}): ${report.fotos.length} fotos`);
        console.log(`   Primera foto es Base64: ${report.fotos[0].startsWith('data:image')}`);
    }
});

  console.log(`‚úÖ ${filteredReports.length} reportes tras filtros combinados`);

  // üîπ Renderizar solo los reportes filtrados
  updateVisibleReportsWithDOM(filteredReports);
  loadCommentsCount();
  updateReportCounts();
}

function updateVisibleReportsWithDOM(filteredReports) {
  const containers = document.querySelectorAll('.cards-container');
  containers.forEach(c => {
    // Limpiar contenedor correctamente
    while (c.firstChild) {
      c.removeChild(c.firstChild);
    }
  });

  if (!filteredReports.length) {
    containers.forEach(c => {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty-column';
      emptyDiv.innerHTML = '<span>No hay reportes</span>';
      c.appendChild(emptyDiv);
    });
    updateReportCounts();
    return;
  }

  const reportsByStatus = {
    'Pendiente': [],
    'En Progreso': [],
    'En Revision': [],
    'Completado': []
  };

  filteredReports.forEach(r => {
    const status = r.estado || 'Pendiente';
    if (reportsByStatus[status]) reportsByStatus[status].push(r);
  });

  // üîπ USAR appendChild con elementos DOM reales
  Object.entries(reportsByStatus).forEach(([status, list]) => {
    const containerId = status.toLowerCase().replace(' ', '-') + '-cards';
    const countId = status.toLowerCase().replace(' ', '-') + '-count';
    const container = document.getElementById(containerId);
    const count = document.getElementById(countId);

    if (container && count) {
      count.textContent = list.length;
      
      // Limpiar contenedor
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      
      if (list.length) {
        list.forEach(r => {
          // üîπ IMPORTANTE: Usar el elemento DOM directamente
          const cardElement = createReportCard(r);
          container.appendChild(cardElement);
        });
      } else {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'empty-column';
        emptyDiv.innerHTML = '<span>No hay reportes</span>';
        container.appendChild(emptyDiv);
      }
    }
  });

  updateReportCounts();
}


function updateVisibleReports(filteredReports) {
  const containers = document.querySelectorAll('.cards-container');
  containers.forEach(c => c.innerHTML = ''); // limpiar sin eliminar estructura

  if (!filteredReports.length) {
    containers.forEach(c => {
      c.innerHTML = `
        <div class="empty-column">
          <span>No hay reportes</span>
        </div>
      `;
    });
    updateReportCounts();
    return;
  }

  // agrupar por estado como siempre
  const reportsByStatus = {
    'Pendiente': [],
    'En Progreso': [],
    'En Revision': [],
    'Completado': []
  };

  filteredReports.forEach(r => {
    const status = r.estado || 'Pendiente';
    if (reportsByStatus[status]) reportsByStatus[status].push(r);
  });

  // render normal
  Object.entries(reportsByStatus).forEach(([status, list]) => {
    const containerId = status.toLowerCase().replace(' ', '-') + '-cards';
    const countId = status.toLowerCase().replace(' ', '-') + '-count';
    const container = document.getElementById(containerId);
    const count = document.getElementById(countId);

    if (container && count) {
      count.textContent = list.length;
      container.innerHTML = list.length
        ? list.map(r => createReportCard(r).outerHTML).join('')
        : `<div class="empty-column"><span>No hay reportes</span></div>`;
    }
  });

  updateReportCounts();
}

function showChangeDateModal(reportId, currentDate) {
  const existingModal = document.getElementById('dateModal');
  if (existingModal) existingModal.remove();

  const overlay = document.createElement('div');
  overlay.id = 'dateModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

  modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600;">
      üìÖ Cambiar Fecha de Soluci√≥n
    </h2>

    <label for="newDate" style="font-weight:500; color:#475569;">Nueva Fecha:</label>
    <input type="date" id="newDate" value="${currentDate ? formatLocalDateForInput(currentDate) : ''}" 
      style="width:100%; padding:0.6rem 0.8rem; border:1px solid #cbd5e1; border-radius:8px; font-size:14px;">

    <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
      <button id="cancelDate" 
        style="padding:0.5rem 1rem; border:1px solid #cbd5e1; border-radius:8px; cursor:pointer;">
        Cancelar
      </button>
      <button id="saveDate" 
        style="padding:0.5rem 1rem; border:none; background:#3b82f6; color:#fff; border-radius:8px; cursor:pointer;">
        Guardar
      </button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const dateInput = modal.querySelector('#newDate');
  const saveBtn = modal.querySelector('#saveDate');

  // Bot√≥n cancelar
  modal.querySelector('#cancelDate').addEventListener('click', () => overlay.remove());

  // Guardar
  saveBtn.addEventListener('click', () => {
    const newDate = dateInput.value.trim();
    if (!newDate) {
      showAlert('warning', 'Campo vac√≠o', 'Debes seleccionar una fecha');
      return;
    }

    overlay.remove();
    showAlert('info', 'Actualizando...', 'Modificando fecha de soluci√≥n...', 2000);

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', '√âxito', 'Fecha actualizada correctamente');
        loadN2Reports(); // recargar lista
      })
      .withFailureHandler(err => {
        console.error(err);
        showAlert('error', 'Error', 'No se pudo actualizar la fecha');
      })
      .updateReportDate(reportId, newDate);
  });

  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.remove();
  });
}

function formatLocalDateForInput(dateString) {
  const date = new Date(dateString);
  // Ajusta a la zona local, sin UTC shift
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function validarUbicacionAntesDeEnviar() {
    const ubicacion = document.getElementById('ubicacion');
    if (ubicacion.value.length > 36) {
        showAlert('error', 'Ubicaci√≥n muy larga', 'La ubicaci√≥n no puede tener m√°s de 36 caracteres');
        ubicacion.focus();
        return false;
    }
    return true;
}

function submitTarjetaForm(event) {
  event.preventDefault();

  const submitBtn = event.target.querySelector('.submit-btn');
    buttonStateManager.bloquear(submitBtn, 'Enviar Tarjeta');

    if (!validarUbicacionAntesDeEnviar()) {
    buttonStateManager.desbloquear(submitBtn);
    return;
  }

  const formData = {
    zonaRiesgo: document.getElementById('zonaRiesgo').value,
    nombreCedula: document.getElementById('nombreCedula').value,
    ubicacion: document.getElementById('ubicacion').value,
    prioridad: document.getElementById('prioridad').value,
    descripcionProblema: document.getElementById('descripcionProblema').value,
    tipoRiesgo: document.getElementById('tipoRiesgo').value,
    problemaAsociado: document.getElementById('problemaAsociado').value,
    sistemaGestion: document.getElementById('sistemaGestion').value,
    responsableSolucion: document.getElementById('responsableSolucion').value,
    generadaPor: document.getElementById('generadaPor').value,
    fechaCreacionTarjeta: document.getElementById('fechaCreacionTarjeta').value,
    requiereSAP: document.getElementById('requiereSAP').value,
    fotos: selectedFiles || []
  };

  console.log("üì∏ Fotos a enviar:", formData.fotos.length);

  showAlert('info', 'Enviando...', 'Procesando su tarjeta de anormalidad, por favor espere', 3000);

  google.script.run
    .withSuccessHandler(function(response) {
      buttonStateManager.desbloquear(submitBtn);
      handleTarjetaSubmitSuccess(response);
    })
    .withFailureHandler(function(error) {
      buttonStateManager.desbloquear(submitBtn);
      handleError(error);
    })
    .submitTarjetaReport(formData);
}

    let selectedFiles = []; // almacenamiento temporal

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');

// Evento clic: abre selector de archivos
dropZone.addEventListener('click', () => fileInput.click());

// Arrastrar y soltar
dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

// Manejo de archivos
function handleFiles(files) {
  [...files].forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      selectedFiles.push(e.target.result);
      const div = document.createElement('div');
      div.classList.add('preview-item');
      div.innerHTML = `
        <img src="${e.target.result}" alt="preview">
        <button type="button" onclick="removeImage('${e.target.result}')">√ó</button>
      `;
      previewContainer.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

// Quitar una imagen de la vista previa
function removeImage(base64) {
  selectedFiles = selectedFiles.filter(img => img !== base64);
  [...previewContainer.children].forEach(child => {
    if (child.querySelector('img').src === base64) child.remove();
  });
}

// Limpiar zona de im√°genes (se llama despu√©s de enviar)
function limpiarDropZone() {
  selectedFiles = [];
  previewContainer.innerHTML = '';
  dropZone.innerHTML = '<p>Arrastra tus im√°genes aqu√≠ o haz clic para seleccionarlas</p>';
}

function handleTarjetaSubmitSuccess(result) {
    if (result.success) {
        showAlert('success', '¬°√âxito!', 'Tarjeta de anormalidad enviada exitosamente');

        const tarjetaForm = document.getElementById('tarjetaForm');
        if (tarjetaForm) {
            tarjetaForm.reset();
            limpiarDropZone();

            // Restaurar campo Nombre + C√©dula
            const nombreCedulaField = document.getElementById('nombreCedula');
            if (nombreCedulaField && typeof currentUser !== 'undefined') {
                nombreCedulaField.value = currentUser.nombre;
            }

            // Restaurar Fecha de creaci√≥n - CORREGIDO
            setTimeout(() => {
                setFechaCreacionTarjeta();
            }, 100);
        }

    } else {
        showAlert('error', 'Error', result.message || 'Error al enviar la tarjeta');
    }
}

function setFechaCreacionTarjeta() {
    const fechaInput = document.getElementById("fechaCreacionTarjeta");
    if (!fechaInput) return;
    
    const now = new Date();
    
    // Formatear fecha en formato: DD/MM/YYYY HH:MM:SS
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    const fechaFormateada = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
    
    fechaInput.value = fechaFormateada;
}

if (document.getElementById('fechaCreacionTarjeta')) {
    setFechaCreacionTarjeta();
}

// Mapas de opciones por riesgo
const problemasPorRiesgo = {
    "Riesgo a las personas": [
        "Incidente",
        "Acto inseguro",
        "Condici√≥n insegura"
    ],
    "Riesgo ambiental": [
        "Incidentes ambientales",
        "Acto Inseguro ambientales",
        "Condici√≥n b√°sica"
    ],
    "Riesgo de inocuidad": [
        "Defecto",
        "Acto y/o comportamiento",
        "Condici√≥n b√°sica"
    ],
    "Riesgo de falla de equipo": [
        "Condici√≥n de operaci√≥n",
        "Condiciones b√°sicas"
    ],
    "Riesgo de calidad": [
        "Defecto",
        "Acto y/o comportamiento",
        "Condici√≥n b√°sica"
    ]
};

const sistemasPorRiesgo = {
    "Riesgo a las personas": [
        "Seguridad y salud en el trabajo",
        "Seguridad vial"
    ]
};

// Referencias a los selects y al contenedor del sistema de gesti√≥n
const tipoRiesgo = document.getElementById("tipoRiesgo");
const problemaAsociado = document.getElementById("problemaAsociado");
const sistemaGestion = document.getElementById("sistemaGestion");
const sistemaGestionGroup = sistemaGestion.closest(".form-group"); // Ocultamos el grupo completo

// Ocultar al inicio
sistemaGestionGroup.style.display = "none";

tipoRiesgo.addEventListener("change", function () {
    const riesgo = this.value;
    console.log("üëâ Riesgo seleccionado:", riesgo);

    problemaAsociado.innerHTML = '<option value="">Selecciona un problema</option>';
    sistemaGestion.innerHTML = '<option value="">Selecciona el sistema</option>';

    if (riesgo && problemasPorRiesgo[riesgo]) {
        console.log("‚úÖ Opciones encontradas:", problemasPorRiesgo[riesgo]);

        // Cargar problemas
        problemasPorRiesgo[riesgo].forEach(opcion => {
            const opt = document.createElement("option");
            opt.value = opcion;
            opt.textContent = opcion;
            problemaAsociado.appendChild(opt);
        });

        // Si es Riesgo a las personas, mostrar y cargar sistemas
        if (sistemasPorRiesgo[riesgo]) {
            sistemaGestionGroup.style.display = "block"; // mostrar
            sistemasPorRiesgo[riesgo].forEach(opcion => {
                const opt = document.createElement("option");
                opt.value = opcion;
                opt.textContent = opcion;
                sistemaGestion.appendChild(opt);
            });
        } else {
            sistemaGestionGroup.style.display = "none"; // ocultar
        }

    } else {
        console.warn("‚ö† No hay opciones para el riesgo:", riesgo);
        sistemaGestionGroup.style.display = "none";
    }
});

function loadTarjetasReports() {
    showTarjetasLoadingSpinner();
    
    google.script.run
        .withSuccessHandler(function(tarjetas) {
            window.tarjetasBase = tarjetas;
            tarjetasReports = tarjetas;
            
            displayTarjetasReports(tarjetas);
            loadTarjetasCommentsCount();
        })
        .withFailureHandler(function(err) {
            handleTarjetasError(err);
        })
        .getTarjetasReports();
}

/**
 * Muestra spinner de carga en las tarjetas
 */
function showTarjetasLoadingSpinner() {
    const containers = ['abiertas-cards', 'cerradas-cards'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="loading-spinner-tarjetas">
                    ${Array(6).fill(0).map(() => `
                        <div class="skeleton-card-simple"></div>
                    `).join('')}
                </div>
            `;
        }
    });
}

/**
 * Muestra las tarjetas separadas por estado
 */
function displayTarjetasReports(tarjetas) {
    console.log('[v0] Mostrando tarjetas:', tarjetas.length);
    
    if (!Array.isArray(tarjetas)) {
        tarjetas = [];
    }

    // Guardar tarjetas globalmente
    tarjetasReports = tarjetas;

    // Limpiar contenedores
    const abiertasContainer = document.getElementById('abiertas-cards');
    const cerradasContainer = document.getElementById('cerradas-cards');
    
    if (abiertasContainer) abiertasContainer.innerHTML = '';
    if (cerradasContainer) cerradasContainer.innerHTML = '';

    // Separar por estado
    const abiertas = tarjetas.filter(t => t.estado !== 'Cerrada');
    const cerradas = tarjetas.filter(t => t.estado === 'Cerrada');

    // Actualizar contadores
    const abiertasCount = document.getElementById('abiertas-count');
    const cerradasCount = document.getElementById('cerradas-count');
    
    if (abiertasCount) abiertasCount.textContent = abiertas.length;
    if (cerradasCount) cerradasCount.textContent = cerradas.length;

    // Mostrar tarjetas abiertas
    if (abiertas.length === 0 && abiertasContainer) {
        abiertasContainer.innerHTML = `
            <div class="empty-column">
                <span>No hay tarjetas abiertas</span>
            </div>
        `;
    } else {
        abiertas.forEach(tarjeta => {
            if (abiertasContainer) {
                abiertasContainer.appendChild(createTarjetaCard(tarjeta, false));
            }
        });
    }

    // Mostrar tarjetas cerradas
    if (cerradas.length === 0 && cerradasContainer) {
        cerradasContainer.innerHTML = `
            <div class="empty-column">
                <span>No hay tarjetas cerradas</span>
            </div>
        `;
    } else {
        cerradas.forEach(tarjeta => {
            if (cerradasContainer) {
                cerradasContainer.appendChild(createTarjetaCard(tarjeta, true));
            }
        });
    }
    
}

function createTarjetaCard(tarjeta, isCerrada) {
  const card = document.createElement('div');
  card.className = 'report-card tarjeta-card';
  card.setAttribute('data-row-index', tarjeta.rowIndex);
  card.setAttribute('data-prioridad', tarjeta.prioridad);
  card.setAttribute('data-tarjeta-id', tarjeta.id);

  // üîπ Color del borde seg√∫n prioridad
  const colores = { Alta: '#dc3545', Media: '#fd7e14', Baja: '#28a745' };
  const borderColor = colores[tarjeta.prioridad] || '#6c757d';
  card.style.borderLeftColor = borderColor;

  // üîπ Calcular d√≠as desde la creaci√≥n
  let diasDesdeCreacion = '';
  if (tarjeta.fechaCreacion) {
    const fechaCreacion = new Date(tarjeta.fechaCreacion);
    const hoy = new Date();
    const diffDays = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
    diasDesdeCreacion = `Hace ${diffDays} d√≠a${diffDays !== 1 ? 's' : ''}`;
  }

  const sapBadge = tarjeta.requiereSAP === 'Si' 
    ? `<span class="sap-badge" style="background-color: #1e3a8a; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">SAP</span>`
    : '';

  // Usando texto en lugar de icono
const editButtonHtml = !isCerrada ? `
  <button 
    class="edit-responsable-btn" 
    title="Cambiar responsable"
    onclick="showChangeTarjetaResponsibleModal(${tarjeta.rowIndex}, '${escapeHtml(tarjeta.responsableSolucion || '')}')"
    style="background:none; border:none; cursor:pointer; color:#0d6efd; padding:0 4px; margin-left:4px; font-size:11px; text-decoration:underline;"
  >
    <i class="fa-solid fa-pencil"></i>
  </button>
` : '';

  card.innerHTML = `
    <div class="card-header">
        <div style="display: flex; align-items: center; gap: 8px;">
            <span class="card-id">${tarjeta.id || ''}</span>
            <span class="card-priority" 
                  style="background:${borderColor};color:white;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">
                ${tarjeta.prioridad || 'Sin prioridad'}
            </span>
            ${sapBadge}
        </div>
        <span class="card-date">${diasDesdeCreacion}</span>
    </div>

    <div class="card-title">${tarjeta.ubicacion || 'Sin ubicaci√≥n'}</div>
    <div class="card-description">${tarjeta.descripcionProblema || 'Sin descripci√≥n'}</div>

    <div class="card-meta">
        <span class="card-process">${tarjeta.zonaRiesgo || 'Sin zona'}</span>
        <span class="card-risk-type" style="font-size:11px;color:#6c757d;margin-left:10px;">
            ${tarjeta.tipoRiesgo || ''}
        </span>
        <span class="comment-count" id="comment-count-tar-${tarjeta.id}" style="color:black; border-radius:8px; padding:2px 6px; font-size:10px; margin-left:8px;">0</span>
    </div>

    <div class="card-images" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:20px;"></div>

    <div class="card-footer" 
         style="margin-top:8px;padding-top:8px;border-top:1px solid #e9ecef;font-size:12px;color:#6c757d;">
        <div style="margin-bottom: 4px;">
            <strong>Responsable:</strong> 
            <span style="display:inline-block; vertical-align:middle;">
              ${tarjeta.responsableSolucion || 'No asignado'}
            </span>
            ${editButtonHtml}
        </div>
        <div style="margin-bottom: 4px;"><strong>Responsable especifico:</strong> ${tarjeta.responsableNombreVisualizarReporte || 'Desconocido'}</div>
        <div style="margin-bottom: 4px;"><strong>Creada por:</strong> ${tarjeta.nombreCedula || 'Desconocido'}</div>
        <div style="margin-bottom: 4px;"><strong>Problema asociado:</strong> ${tarjeta.problemaAsociado || 'N/A'}</div>
        <div style="margin-bottom: 4px;"><strong>Sistema de gesti√≥n:</strong> ${tarjeta.sistemaGestion || 'N/A'}</div>
        <div style="margin-bottom: 4px;"><strong>Generada por:</strong> ${tarjeta.generadaPor || 'N/A'}</div>
        ${tarjeta.requiereSAP === 'Si' ? `<div style="margin-bottom: 4px;"><strong style="color:#1e3a8a;">Requiere SAP:</strong> <span style="color:#1e3a8a; font-weight:600;">S√ç</span></div>` : ''}
        ${
          tarjeta.estado === 'Cerrada'
            ? `<div style="margin-bottom: 4px;"><strong style="color:#d9534f;">Comentario de Cierre:</strong> 
                 <span style="color:#d9534f;">${tarjeta.comentarioCierre || 'N/A'}</span>
               </div>
               <div style="margin-bottom: 4px;"><strong style="color:#d9534f;">Cerrada por:</strong> 
                 <span style="color:#d9534f;">${tarjeta.responsableCierre || 'N/A'}</span>
               </div>`
            : ''
        }
    </div>

    <div class="card-actions">
        <button class="card-action-btn" onclick="viewTarjetaDetails(${tarjeta.rowIndex})">Ver Detalles</button>
        <button class="card-action-btn" onclick="showTarjetasCommentsModal('${tarjeta.id}')">Seguimiento</button>
        ${
          !isCerrada
            ? `<button class="card-action-btn card-close-btn" onclick="showCloseTarjetaModal(${tarjeta.rowIndex})">Cerrar Tarjeta</button>`
            : ''
        }
    </div>
  `;

  // üîπ Insertar im√°genes
  const imagesContainer = card.querySelector('.card-images');

  if (tarjeta.fotos && tarjeta.fotos.length > 0) {
    tarjeta.fotos.forEach((foto, i) => {
      const img = document.createElement('img');
      img.alt = `Foto ${i + 1}`;
      img.className = 'card-img-thumb';

      if (foto.startsWith('data:image')) {
        img.src = foto;
      } else if (foto.includes('drive.google.com')) {
        const match = foto.match(/id=([a-zA-Z0-9_-]+)/);
        img.src = match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : foto;
      } else {
        img.src = foto;
      }

      img.style.cssText = `
        width:70px;
        height:70px;
        margin:10px 0;
        object-fit:cover;
        border-radius:8px;
        border:1px solid #ccc;
        cursor:pointer;
        transition:transform 0.2s ease;
      `;

      img.addEventListener('mouseover', () => img.style.transform = 'scale(1.1)');
      img.addEventListener('mouseout', () => img.style.transform = 'scale(1)');
      img.addEventListener('click', () => expandImage(img.src));

      imagesContainer.appendChild(img);
    });
  }

  return card;
}

// Funci√≥n para ampliar imagen al hacer click
function expandImage(url) {
  console.log("üîç Expandir imagen:", url.substring(0, 50) + "...");
  
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.background = 'rgba(0,0,0,0.9)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.cursor = 'pointer';
  modal.style.zIndex = '9999';
  
  const imgElement = document.createElement('img');
  imgElement.src = url;
  imgElement.style.maxWidth = '90%';
  imgElement.style.maxHeight = '90%';
  imgElement.style.borderRadius = '8px';
  imgElement.style.objectFit = 'contain';
  
  modal.appendChild(imgElement);
  modal.onclick = () => {
    console.log("‚ùå Cerrar modal de imagen");
    modal.remove();
  };
  
  document.body.appendChild(modal);
  
  // Tambi√©n cerrar con ESC
  const closeOnEsc = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', closeOnEsc);
    }
  };
  document.addEventListener('keydown', closeOnEsc);
}

/**
 * Muestra los detalles completos de una tarjeta
 */
function viewTarjetaDetails(rowIndex) {
    const tarjeta = tarjetasReports.find(t => t.rowIndex === rowIndex);
    if (!tarjeta) return;

    let detallesHTML = `
        <br><strong>Zona de Riesgo:</strong> ${tarjeta.zonaRiesgo}\n <br><br>
        <strong>Ubicaci√≥n:</strong> ${tarjeta.ubicacion}\n <br><br>
        <strong>Prioridad:</strong> ${tarjeta.prioridad}\n <br><br>
        <strong>Descripci√≥n:</strong> ${tarjeta.descripcionProblema}\n <br><br>
        <strong>Tipo de Riesgo:</strong> ${tarjeta.tipoRiesgo}\n <br><br>
        <strong>Problema Asociado:</strong> ${tarjeta.problemaAsociado}\n <br><br>
        ${tarjeta.sistemaGestion ? `<strong>Sistema de Gesti√≥n:</strong> ${tarjeta.sistemaGestion}\n <br><br>` : ''}
        <strong>Responsable:</strong> ${tarjeta.responsableSolucion}\n <br><br>
        <strong>Responsable especifico:</strong> ${tarjeta.responsableNombreVisualizarReporte}\n <br><br>
        <strong>Generada por:</strong> ${tarjeta.nombreCedula}\n <br><br>
        <strong>Fecha de Creaci√≥n:</strong> ${formatDate(tarjeta.fechaCreacion)}\n <br><br>
        <strong>Estado:</strong> ${tarjeta.estado}
    `;

    if (tarjeta.estado === 'Cerrada') {
        detallesHTML += `\n <br><br><strong>Comentario de Cierre:</strong> ${tarjeta.comentarioCierre || 'N/A'}`;
        detallesHTML += `\n <br><br><strong>Cerrada por:</strong> ${tarjeta.responsableCierre || 'N/A'}`;
        detallesHTML += `\n <br><br><strong>Fecha de cierre:</strong> ${tarjeta.fechaCierreTarjeta|| 'N/A'}`;
    }

    showAlert('info', 'Detalles de la Tarjeta', detallesHTML, 10000);
}

/**
 * Muestra modal para cerrar tarjeta con comentario
 */
function showCloseTarjetaModal(rowIndex) {
    // Eliminar modal existente
    const existingModal = document.getElementById('closeTarjetaModal');
    if (existingModal) existingModal.remove();

    // Overlay
    const overlay = document.createElement('div');
    overlay.id = 'closeTarjetaModal';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

    // Contenido del modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: #fff; padding: 2rem;
        border-radius: 16px; width: 90%; max-width: 500px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    `;

    modal.innerHTML = `
        <h2 style="margin-bottom: 1rem; font-size: 20px; font-weight: 600; color: #1e293b; text-align:center">
            Cerrar Tarjeta de Anormalidad
        </h2>
        <p style="margin-bottom: 1.5rem; font-size: 14px; color: #64748b; text-align: center;">
            Agregue un comentario sobre la soluci√≥n o cierre de esta tarjeta
        </p>
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                Responsable del cierre:
            </label>
            <input 
                type="text" 
                id="responsableCierre" 
                value="${currentUser.nombre || currentUser.cedula || ''}"
                readonly
                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb; color: #6b7280;"
            >
            <p style="font-size: 12px; color: #6b7280; margin-top: 0.25rem;">
                Este campo se completa autom√°ticamente con su informaci√≥n
            </p>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                Comentario de cierre:
            </label>
            <textarea 
                id="comentarioCierre" 
                placeholder="Describa la soluci√≥n implementada o raz√≥n del cierre..."
                style="width: 100%; min-height: 120px; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; font-size: 14px; resize: vertical;"
            ></textarea>
        </div>
        
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button id="cancelCloseBtn" style="padding: 0.75rem 1.5rem; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; background: white; font-weight: 500;">
                Cancelar
            </button>
            <button id="confirmCloseBtn" style="padding: 0.75rem 1.5rem; border: none; background: #dc3545; color: #fff; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Cerrar Tarjeta
            </button>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Bot√≥n cancelar
    modal.querySelector('#cancelCloseBtn').addEventListener('click', () => overlay.remove());

    // Bot√≥n confirmar
    modal.querySelector('#confirmCloseBtn').addEventListener('click', () => {
        const comentario = modal.querySelector('#comentarioCierre').value.trim();
        const responsableCierre = modal.querySelector('#responsableCierre').value.trim();
        
        if (!comentario) {
            showAlert('warning', 'Comentario requerido', 'Por favor agregue un comentario antes de cerrar la tarjeta');
            return;
        }

        if (!responsableCierre) {
            showAlert('warning', 'Responsable requerido', 'El responsable del cierre es obligatorio');
            return;
        }

        overlay.remove();
        closeTarjetaReport(rowIndex, comentario, responsableCierre);
    });

    // Cerrar modal clickeando afuera
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
}


/**
 * Cierra una tarjeta con comentario
 */
function closeTarjetaReport(rowIndex, comentario, responsableCierre) {
    showAlert('info', 'Cerrando tarjeta...', 'Procesando el cierre de la tarjeta', 2000);

    google.script.run
        .withSuccessHandler(() => {
            showAlert('success', '¬°Tarjeta cerrada!', 'La tarjeta ha sido cerrada exitosamente');
            loadTarjetasReports(); // Recargar tarjetas
        })
        .withFailureHandler(err => {
            console.error('Error al cerrar tarjeta:', err);
            showAlert('error', 'Error', 'No se pudo cerrar la tarjeta: ' + err.message);
        })
        .closeTarjetaReport(rowIndex, comentario, responsableCierre);
}

/**
 * Aplica filtro por prioridad
 */
function applyTarjetaPrioridadFilter() {
    const selected = document.getElementById('tarjetaPrioridadFilter').value;
    const cards = document.querySelectorAll('.tarjeta-card');

    cards.forEach(card => {
        const prioridad = card.getAttribute('data-prioridad');

        if (selected === 'all') {
            card.style.display = 'block';
        } else {
            if (prioridad === selected) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }
    });
}

/**
 * Maneja errores al cargar tarjetas
 */
function handleTarjetasError(error) {
    console.error('Error loading tarjetas:', error);
    const containers = ['abiertas-cards', 'cerradas-cards'];
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="empty-column">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span>Error al cargar tarjetas</span>
                </div>
            `;
        }
    });
    showAlert('error', 'Error', 'No se pudieron cargar las tarjetas: ' + error.message);
}

// üîπ Cargar y actualizar contador de comentarios por tarjeta
function loadCommentsCount() {
  google.script.run
    .withSuccessHandler(updateCommentCounters)
    .getCommentsCountForReports();
}

// üîπ Actualiza visualmente los contadores
function updateCommentCounters(counts) {
  for (const [reportId, count] of Object.entries(counts)) {
    const badge = document.getElementById(`comment-count-${reportId}`);
    if (badge) {
      badge.textContent = count;

      // Cambiar color de fondo seg√∫n el n√∫mero de comentarios
      if (count > 0) {
        badge.style.backgroundColor = '#007bff';
        badge.style.color = 'white';
      } else {
        badge.style.backgroundColor = 'transparent';
        badge.style.color = 'black';
      }
    }
  }
}

function applyTarjetaFilters() {
    // üü¢ Asegurar que la fuente base est√© actualizada
    if (!window.tarjetasBase || window.tarjetasBase.length === 0) {
        if (typeof tarjetasReports !== "undefined" && Array.isArray(tarjetasReports) && tarjetasReports.length > 0) {
            window.tarjetasBase = [...tarjetasReports];
        } else {
            console.warn("‚ö†Ô∏è No hay datos disponibles para inicializar las tarjetas.");
            displayTarjetasReports([]);
            return;
        }
    }

    // üü£ Capturar TODOS los filtros individualmente
    const filtroResponsable = document.getElementById('filtroResponsable')?.value || "";
    const filtroTipo = document.getElementById('filtroTipo')?.value || "";
    const filtroZona = document.getElementById('filtroZona')?.value || "";
    const filtroRiesgo = document.getElementById('filtroRiesgo')?.value || "";
    const searchCreator = document.getElementById('searchCreator')?.value?.toLowerCase().trim() || "";
    const searchNombreResponsable = document.getElementById('searchNombreResponsable')?.value?.toLowerCase().trim() || "";

    // üîπ Fuente base segura
    const tarjetas = Array.isArray(window.tarjetasBase) ? window.tarjetasBase : [];
    let filtradas = [...tarjetas];

    // üî• APLICAR FILTROS COMBINADOS - TODOS SE PUEDEN USAR JUNTOS

    // 1. Filtro por CREADOR
    if (searchCreator) {
        filtradas = filtradas.filter(t => {
            const creador = String(t.nombreCedula || '').toLowerCase();
            return creador.includes(searchCreator);
        });
    }

    if (searchNombreResponsable) {
    filtradas = filtradas.filter(t => {
        const responsable = String(t.responsableNombreVisualizarReporte || '').toLowerCase();
        return responsable.includes(searchNombreResponsable.toLowerCase());
    });
}

    // 2. Filtro por RESPONSABLE
    if (filtroResponsable) {
        filtradas = filtradas.filter(t => 
            String(t.responsableSolucion).trim() === filtroResponsable.trim()
        );
    }

    // 3. Filtro por TIPO
    if (filtroTipo) {
        filtradas = filtradas.filter(t => 
            String(t.generadaPor).trim() === filtroTipo.trim()
        );
    }

    // 4. Filtro por ZONA
    if (filtroZona) {
        filtradas = filtradas.filter(t => {
            const zona = String(t.zonaRiesgo || '').trim();
            const ubi = String(t.ubicacion || '').trim();
            return zona === filtroZona || ubi.includes(filtroZona);
        });
    }

    if (filtroRiesgo) {
        filtradas = filtradas.filter(t => 
            String(t.tipoRiesgo).trim() === filtroRiesgo.trim()
        );
    }

    console.log(`‚úÖ ${filtradas.length} tarjetas filtradas`);
    displayTarjetasReports(filtradas);
    
    loadTarjetasCommentsCount();
}

    // Initialize the application
    window.onload = function() {
        loadLeaders();
        initializeN2Dropzone();
        // Load N2 reports if we're on the N2 page initially
        if (document.getElementById('n2') && document.getElementById('n2').classList.contains('active')) {
            loadN2Reports();
            loadTarjetasReports();
            
        }
    };

function reloadReportsKeepFilters() {
  const currentFilters = {
    process: document.getElementById("ProcessFilter").value,
    respo: document.getElementById("ProcessRespo").value,
    search: document.getElementById("searchByName").value,
    reportType: document.getElementById("reportFilter").value
  };
  
  showLoadingSpinner();
  
  // Recargar datos del servidor
  google.script.run
    .withSuccessHandler((reports) => {
      n2Reports = reports;
      // Re-aplicar filtros inmediatamente despu√©s de recibir datos
      document.getElementById("ProcessFilter").value = currentFilters.process;
      document.getElementById("ProcessRespo").value = currentFilters.respo;
      document.getElementById("searchByName").value = currentFilters.search;
      document.getElementById("reportFilter").value = currentFilters.reportType;
      
      applyCombinedFilters();
      loadCommentsCount();
    })
    .withFailureHandler((err) => {
      console.error('Error al recargar:', err);
      handleN2Error(err);
    })
    .getN2Reports();
}

/**
 * Recarga los datos de m√°quinas manteniendo los filtros aplicados (igual que N2)
 */
function reloadMaquinasKeepFilters() {
    const currentFilters = {
        proceso: document.getElementById('maquinasProcesoFilter').value,
        area: document.getElementById('maquinasAreaFilter').value,
        areaProc: document.getElementById('maquinasAreaprocFilter').value,
        search: document.getElementById('maquinasSearchByName').value
    };
    
    showMaquinasLoadingSpinner();
    
    // Recargar datos del servidor
    google.script.run
        .withSuccessHandler((reports) => {
            maquinasReports = reports;
            // Re-aplicar filtros inmediatamente despu√©s de recibir datos
            document.getElementById('maquinasProcesoFilter').value = currentFilters.proceso;
            document.getElementById('maquinasAreaFilter').value = currentFilters.area;
            document.getElementById('maquinasAreaprocFilter').value = currentFilters.areaProc;
            document.getElementById('maquinasSearchByName').value = currentFilters.search;
            
            applyMaquinasFilters();
            loadMaquinasCommentsCount();
        })
        .withFailureHandler((err) => {
            console.error('Error al recargar m√°quinas:', err);
            handleMaquinasError(err);
        })
        .getMaquinasReports();
}

const areasPorProceso = {
  "Pastificio": ["L√≠nea A", "L√≠nea B", "L√≠nea C", "L√≠nea D", "SIRCEM", "Girapasta"],
  "Empaque": [
    "M√°quina 02", "M√°quina 03", "M√°quina 04", "M√°quina 05", "M√°quina 06",
    "M√°quina 17", "M√°quina 18", "M√°quina 19", "M√°quina 20", "M√°quina 21",
    "Encartonadora PL", "Encartonadora PC"
  ]
};

const subsistemasPorArea = {
  "maquinas": ["EMPACADORA", "CHEQUEADORA DE PESO", "ENFARDADORA", "ETIQUETADORA", "BANDAS", "EMBOLSADORA"],
  "encartonadoras": ["ENCARTONADORA", "BANDAS", "ETIQUETADORA"]
};

// Actualizar √°reas seg√∫n proceso seleccionado
function updateAreaProceso() {
  const proceso = document.getElementById('procesoMaquina').value;
  const areaSelect = document.getElementById('areaProceso');
  const subsistemaSelect = document.getElementById('subsistema');
  
  // Limpiar selects
  areaSelect.innerHTML = '<option value="">Selecciona el √°rea</option>';
  subsistemaSelect.innerHTML = '<option value="">Selecciona el subsistema</option>';
  
  if (proceso && areasPorProceso[proceso]) {
    areasPorProceso[proceso].forEach(area => {
      const option = document.createElement('option');
      option.value = area;
      option.textContent = area;
      areaSelect.appendChild(option);
    });
  }
}

// Actualizar subsistemas seg√∫n √°rea seleccionada
function updateSubsistema() {
  const area = document.getElementById('areaProceso').value;
  const subsistemaSelect = document.getElementById('subsistema');
  
  subsistemaSelect.innerHTML = '<option value="">Selecciona el subsistema</option>';
  
  let subsistemas = [];
  
  if (area.includes("Encartonadora")) {
    subsistemas = subsistemasPorArea["encartonadoras"];
  } else if (area.startsWith("M√°quina") || area.startsWith("L√≠nea")) {
    subsistemas = subsistemasPorArea["maquinas"];
  }
  
  subsistemas.forEach(sub => {
    const option = document.createElement('option');
    option.value = sub;
    option.textContent = sub;
    subsistemaSelect.appendChild(option);
  });
}

  subsistema.addEventListener("change", () => {
    if (subsistema.value) {
      otroSubsistema.disabled = true;
      otroSubsistema.value = "";
    } else {
      otroSubsistema.disabled = false;
    }
  });

  otroSubsistema.addEventListener("input", () => {
    if (otroSubsistema.value.trim() !== "") {
      subsistema.disabled = true;
      subsistema.value = "";
    } else {
      subsistema.disabled = false;
    }
  });
  
function submitMaquinasForm(event) {
  event.preventDefault();

  const submitBtn = event.target.querySelector('.submit-btn');
  buttonStateManager.bloquear(submitBtn, 'Enviar Reporte');

  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const day = String(now.getDate()).padStart(2, "0");
  const hour = String(now.getHours()).padStart(2, "0");
  const minute = String(now.getMinutes()).padStart(2, "0");
  const fechaLocal = `${year}-${month}-${day} ${hour}:${minute}`;
  
  const formData = {
    fecha: fechaLocal,
    mecanicoResponsable: document.getElementById('nombreMecanico').value,
    proceso: document.getElementById('procesoMaquina').value,
    areaProceso: document.getElementById('areaProceso').value,
    subsistema: document.getElementById('subsistema').value || document.getElementById('otroSubsistema').value,
    anormalidad: document.getElementById('anormalidadMaquina').value,
    areaResponsable: document.getElementById('areaResponsable').value,
    criticidad: document.getElementById('criticidadMaquina').value,
    nombreCedula: currentUser.nombre + ' - ' + currentUser.cedula
  };
  
  showAlert('info', 'Enviando...', 'Procesando su reporte, por favor espere', 3000);
  
  google.script.run
    .withSuccessHandler(function(response) {
      // Desbloquear el bot√≥n en √©xito
      buttonStateManager.desbloquear(submitBtn);
      
      if (response.success) {
        showAlert('success', '¬°√âxito!', 'Reporte de Anormalidad Cr√≠tica enviado exitosamente');
        document.getElementById('maquinasForm').reset();
      } else {
        showAlert('error', 'Error', response.message || 'Error al enviar el reporte');
      }

      const nombreMecanicoField = document.getElementById('nombreMecanico');
      if (nombreMecanicoField && typeof currentUser !== 'undefined') {
        nombreMecanicoField.value = currentUser.nombre;
      }
    })
    .withFailureHandler(function(error) {
      // Desbloquear el bot√≥n en error
      buttonStateManager.desbloquear(submitBtn);
      showAlert('Error al enviar el reporte: ' + error.message, 'error');
    })
    .submitMaquinasReport(formData);
}

// ========== TABLERO DE M√ÅQUINAS ==========

let maquinasReports = [];

/**
 * Carga los reportes de m√°quinas desde el backend
 */
function loadMaquinasReports() {
    showMaquinasLoadingSpinner();
    
    google.script.run
        .withSuccessHandler(function(reports) {
            console.log('[v0] Reportes de m√°quinas recibidos:', reports);
            displayMaquinasReports(reports);
            loadMaquinasCommentsCount(); // <CHANGE> Cargar contadores de comentarios
        })
        .withFailureHandler(function(err) {
            console.error('[v0] Error al cargar reportes de m√°quinas:', err);
            handleMaquinasError(err);
        })
        .getMaquinasReports();
}

/**
 * Muestra spinner de carga
 */
function showMaquinasLoadingSpinner() {
    const containers = document.querySelectorAll('#anormalidades .cards-container');
    containers.forEach(container => {
        container.innerHTML = '<div class="loading-spinner">Cargando reportes...</div>';
    });
}

/**
 * Muestra los reportes de m√°quinas en el tablero
 */
function displayMaquinasReports(reports) {
    console.log('[v0] Mostrando reportes de m√°quinas:', reports.length);
    
    if (!Array.isArray(reports)) {
        reports = [];
    }

    // Guardar reportes globalmente para filtros
    maquinasReports = reports;

    // Limpiar contenedores
    const containers = document.querySelectorAll('#anormalidades .cards-container');
    containers.forEach(container => {
        container.innerHTML = '';
    });

    // Agrupar por estado
    const reportsByStatus = {
        'Abierto': [],
        'En Progreso': [],
        'Cerrado': []
    };

    reports.forEach(report => {
        const status = report.estado || 'Abierto';
        if (reportsByStatus[status]) {
            reportsByStatus[status].push(report);
        }
    });

    // Renderizar en cada columna
    Object.entries(reportsByStatus).forEach(([status, statusReports]) => {
        const containerId = 'maquinas-' + status.toLowerCase().replace(' ', '-') + '-cards';
        const countId = 'maquinas-' + status.toLowerCase().replace(' ', '-') + '-count';
        
        const container = document.getElementById(containerId);
        const countElement = document.getElementById(countId);
        
        if (container && countElement) {
            countElement.textContent = statusReports.length;
            
            if (statusReports.length === 0) {
                container.innerHTML = `
                    <div class="empty-column">
                        <span>No hay reportes</span>
                    </div>
                `;
            } else {
                statusReports.forEach(report => {
                    container.appendChild(createMaquinaCard(report));
                });
            }
        }
    });
}

/**
 * Crea una card de reporte de m√°quina (mismo estilo que N2)
 */
function createMaquinaCard(report) {
    const card = document.createElement('div');
    card.className = 'report-card';
    card.setAttribute('data-report-id', report.id);
    card.setAttribute('data-proceso', report.proceso);
    card.setAttribute('data-area', report.areaResponsable);
    
    // Determinar color de criticidad
    const criticidadColors = {
        'Alta': '#dc3545',
        'Media': '#ffc107',
        'Baja': '#28a745'
    };
    
    const criticidadColor = criticidadColors[report.criticidad] || '#6c757d';
    
    // CAMBIO: Mec√°nico y criticidad alineados horizontalmente
    const cardHTML = [
        '<div class="card-header">',
        '<span class="card-id">' + (report.id || '') + '</span>',
        '<span class="card-date">' + formatDate(report.fechaRegistro) + '</span>',
        '</div>',
        // CAMBIO: Fila con mec√°nico responsable y criticidad alineados
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; margin-bottom: 8px;">',
        '<div class="card-description" style="margin: 0; flex: 1;">' + (report.mecanicoResponsable || '') + '</div>',
        '<span class="criticidad-badge" style="background-color: ' + criticidadColor + '; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; margin-left: 8px;" onclick="changeMaquinaCriticidad(\'' + report.id + '\', event)">' + (report.criticidad || 'Sin asignar') + '</span>',
        '</div>',
        '<div class="card-title">' + (report.proceso || '') + (' - ') + (report.subsistema || '') + '</div>',
        '<div class="card-description">' + (report.areaProceso || '') + '</div>',
        '<div class="card-description">' + (report.anormalidad || '') + '</div>',
        '<div class="card-meta">',
        '<span class="card-process">' + (report.areaResponsable || '') + '</span>',
        '<span class="comment-count" id="comment-count-maq-' + report.id + '" style="color:black; border-radius:8px; padding:2px 6px; font-size:12px; margin-left:8px;">0</span>',
        '</div>',
        '<div class="card-actions">',
        '<button class="card-action-btn" onclick="viewMaquinaDetails(\'' + report.id + '\')">Ver</button>',
        '<button class="card-action-btn" onclick="showMaquinasCommentsModal(\'' + report.id + '\')">Comentarios</button>',
        '<button class="card-action-btn" onclick="changeMaquinaStatus(\'' + report.id + '\')">Cambiar Estado</button>',
        '</div>'
    ].join('');

    card.innerHTML = cardHTML;
    return card;
}

/**
 * Muestra los detalles de un reporte de m√°quina con alerta (igual que N2)
 */
function viewMaquinaDetails(reportId) {
    const report = maquinasReports.find(r => r.id === reportId);
    if (report) {
        showAlert('info', `Reporte ${reportId}`, 
            `<br><strong>Proceso:</strong> ${report.proceso}\n <br><br>
            <strong>√Årea del Proceso:</strong> ${report.areaProceso}\n <br><br>
            <strong>Subsistema:</strong> ${report.subsistema}\n <br><br>
            <strong>Mec√°nico Responsable:</strong> ${report.mecanicoResponsable}\n <br><br>
            <strong>Anormalidad:</strong> ${report.anormalidad}\n <br><br>
            <strong>√Årea Responsable:</strong> ${report.areaResponsable}\n <br><br>
            <strong>Criticidad:</strong> ${report.criticidad || 'Sin asignar'}\n <br><br>
            <strong>Estado:</strong> ${report.estado}`, 
            8000);
    }
}

/**
 * Muestra el modal de comentarios para m√°quinas (reutiliza estructura de N2)
 */
function showMaquinasCommentsModal(reportId) {
    // <CHANGE> Modal de comentarios espec√≠fico para m√°quinas
    const existingModal = document.getElementById('commentModalMaquinas');
    if (existingModal) existingModal.remove();

    const overlay = document.createElement('div');
    overlay.id = 'commentModalMaquinas';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

    const modal = document.createElement('div');
    modal.style.cssText = `
        background: #fff; padding: 1.5rem;
        border-radius: 16px; width: 90%; max-width: 480px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        display: flex; flex-direction: column; gap: 1rem;
    `;

    modal.innerHTML = `
        <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600; margin:0;">
            <i class="fa-regular fa-comments"></i> Observaciones de mantenimiento
        </h2>

        <div id="commentsList" style="
            max-height:240px; overflow:auto; border:1px solid #e2e8f0;
            border-radius:8px; padding:0.75rem; background:#f8fafc;
        ">
            <div style="text-align:center; color:#94a3b8;">Cargando comentarios...</div>
        </div>

        <textarea id="newComment" placeholder="Escribe tu comentario..." rows="3"
            style="width:100%; padding:0.75rem; border:1px solid #cbd5e1; border-radius:8px; resize:vertical;"></textarea>

        <div style="display:flex; justify-content:flex-end; gap:0.75rem;">
            <button id="cancelComment" style="
                padding:0.5rem 1rem; border:1px solid #cbd5e1;
                border-radius:8px; cursor:pointer; background:#fff;
            ">Cancelar</button>

            <button id="saveComment" style="
                padding:0.5rem 1rem; border:none; background:#3b82f6;
                color:#fff; border-radius:8px; cursor:pointer;
            ">Guardar</button>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const commentsList = modal.querySelector('#commentsList');
    const textarea = modal.querySelector('#newComment');
    const saveBtn = modal.querySelector('#saveComment');

    // Funci√≥n para cargar comentarios
    function loadComments() {
        google.script.run
            .withSuccessHandler(comments => {
                if (!comments || comments.length === 0) {
                    commentsList.innerHTML = `<div style="color:#94a3b8;">No hay comentarios todav√≠a</div>`;
                    return;
                }

                commentsList.innerHTML = comments.map(c => `
                    <div style="padding:0.5rem 0; border-bottom:1px solid #e2e8f0;">
                        <div style="font-weight:600; color:#0f172a; font-size:13px;">${escapeHtml(c.autor)}</div>
                        <div style="font-size:12px; color:#94a3b8;">${escapeHtml(c.fecha)}</div>
                        <div style="margin-top:4px; font-size:14px; color:#334155;">${escapeHtml(c.comentario)}</div>
                    </div>
                `).join('');
                commentsList.scrollTop = commentsList.scrollHeight;
            })
            .withFailureHandler(err => {
                console.error(err);
                commentsList.innerHTML = `<div style="color:#ef4444;">Error al cargar comentarios</div>`;
            })
            .getMaquinasCommentsForReport(reportId);
    }

    loadComments();
    loadMaquinasCommentsCount();

    modal.querySelector('#cancelComment').addEventListener('click', () => overlay.remove());

    saveBtn.addEventListener('click', () => {
        const comment = textarea.value.trim();
        if (!comment) {
            showAlert('warning', 'Campo vac√≠o', 'Debes escribir un comentario');
            return;
        }

        const autor = (typeof currentUser !== 'undefined' && (currentUser.nombre || currentUser.cedula))
            ? (currentUser.nombre || currentUser.cedula)
            : 'Usuario desconocido';

        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';

        google.script.run
            .withSuccessHandler(() => {
                showAlert('success', 'Comentario agregado', 'Se guard√≥ correctamente');
                textarea.value = '';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar';
                loadComments();
                loadMaquinasCommentsCount();
            })
            .withFailureHandler(err => {
                console.error(err);
                showAlert('error', 'Error', 'No se pudo guardar el comentario');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar';
            })
            .addMaquinasCommentToReport(reportId, comment, autor);
    });

    overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.remove();
    });
}

/**
 * Carga los contadores de comentarios para m√°quinas
 */
function loadMaquinasCommentsCount() {
    google.script.run
        .withSuccessHandler(updateMaquinasCommentCounters)
        .getMaquinasCommentsCountForReports();
}

/**
 * Actualiza visualmente los contadores de comentarios
 */
function updateMaquinasCommentCounters(counts) {
    for (const [reportId, count] of Object.entries(counts)) {
        const badge = document.getElementById(`comment-count-maq-${reportId}`);
        if (badge) {
            badge.textContent = count;

            if (count > 0) {
                badge.style.backgroundColor = '#007bff';
                badge.style.color = 'white';
            } else {
                badge.style.backgroundColor = 'transparent';
                badge.style.color = 'black';
            }
        }
    }
}

/**
 * Cambia el estado de un reporte de m√°quina
 */
function changeMaquinaStatus(reportId) {
    const statusOptions = [
        { value: 'Abierto', label: 'Abierto', color: '#6c757d' },
        { value: 'En Progreso', label: 'En Progreso', color: '#007bff' },
        { value: 'Cerrado', label: 'Cerrado', color: '#28a745' }
    ];

    const existingModal = document.getElementById('maquinaStatusModal');
    if (existingModal) existingModal.remove();

    const overlay = document.createElement('div');
    overlay.id = 'maquinaStatusModal';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

    const modal = document.createElement('div');
    modal.style.cssText = `
        background: #fff; padding: 1.5rem;
        border-radius: 16px; width: 90%; max-width: 400px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    `;

    modal.innerHTML = `
        <h2 style="margin-bottom: 1rem; font-size: 18px; font-weight: 600; color: #1e293b; text-align:center">
            Cambiar Estado
        </h2>
        <div id="maquinaStatusOptionsContainer" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button id="maquinaCancelBtn" style="padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer;">Cancelar</button>
            <button id="maquinaConfirmBtn" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: #fff; border-radius: 8px; cursor: pointer;" disabled>Confirmar</button>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const container = modal.querySelector('#maquinaStatusOptionsContainer');
    statusOptions.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'status-option';
        div.dataset.status = opt.value;
        div.style.cssText = `
            padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
        `;
        div.innerHTML = `
            <div style="width:12px; height:12px; border-radius:50%; background:${opt.color};"></div>
            <span>${opt.label}</span>
        `;
        container.appendChild(div);
    });

    let selectedStatus = null;

    container.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', () => {
            container.querySelectorAll('.status-option').forEach(o => {
                o.style.borderColor = '#e2e8f0';
                o.style.background = '#fff';
            });
            option.style.borderColor = '#3b82f6';
            option.style.background = 'rgba(59,130,246,0.05)';
            selectedStatus = option.dataset.status;
            modal.querySelector('#maquinaConfirmBtn').disabled = false;
        });
    });

    modal.querySelector('#maquinaCancelBtn').addEventListener('click', () => overlay.remove());

    modal.querySelector('#maquinaConfirmBtn').addEventListener('click', () => {
        if (!selectedStatus) return;
        overlay.remove();

        showAlert('info', 'Actualizando...', 'Cambiando estado del reporte', 2000);

        google.script.run
            .withSuccessHandler(() => {
                showAlert('success', '¬°√âxito!', `Estado cambiado a "${selectedStatus}"`);
                reloadMaquinasKeepFilters();
            })
            .withFailureHandler(err => {
                console.error('Error:', err);
                showAlert('error', 'Error', 'No se pudo actualizar el estado');
            })
            .updateMaquinaStatus(reportId, selectedStatus);
    });

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
}

/**
 * Aplica filtros combinados al tablero de m√°quinas
 */
function applyMaquinasFilters() {
    const selectedProceso = document.getElementById('maquinasProcesoFilter').value;
    const selectedArea = document.getElementById('maquinasAreaFilter').value;
    const selectedAreaProc = document.getElementById('maquinasAreaprocFilter').value;
    const searchQuery = document.getElementById('maquinasSearchByName').value.toLowerCase();

    if (!Array.isArray(maquinasReports) || maquinasReports.length === 0) return;

    // üîπ Empezamos filtrando desde los datos base (IGUAL QUE N2)
    let filteredReports = [...maquinasReports];

    // 1Ô∏è‚É£ FILTRO: Proceso
    if (selectedProceso !== 'all') {
        filteredReports = filteredReports.filter(r => 
            r.proceso && r.proceso.trim() === selectedProceso
        );
    }

    // 2Ô∏è‚É£ FILTRO: √Årea Responsable
    if (selectedArea !== 'all') {
        filteredReports = filteredReports.filter(r => 
            r.areaResponsable && r.areaResponsable.trim() === selectedArea
        );
    }

    // 3Ô∏è‚É£ FILTRO: √Årea del Proceso
    if (selectedAreaProc !== 'all') {
        filteredReports = filteredReports.filter(r => 
            r.areaProceso && r.areaProceso.trim() === selectedAreaProc
        );
    }

    // 4Ô∏è‚É£ FILTRO: B√∫squeda por nombre del mec√°nico
    if (searchQuery) {
        filteredReports = filteredReports.filter(r => 
            (r.mecanicoResponsable && r.mecanicoResponsable.toLowerCase().includes(searchQuery))
        );
    }

    console.log(`‚úÖ ${filteredReports.length} reportes de m√°quinas tras filtros`);

    // üîπ CORRECI√ìN: Usar funci√≥n que no sobreescribe maquinasReports (IGUAL QUE N2)
    updateVisibleMaquinasReportsWithDOM(filteredReports);
    loadMaquinasCommentsCount();
}

/**
 * Actualiza los reportes visibles en el DOM sin sobreescribir la variable global (IGUAL QUE N2)
 */
function updateVisibleMaquinasReportsWithDOM(filteredReports) {
    console.log('[v0] Actualizando reportes visibles de m√°quinas:', filteredReports.length);
    
    if (!Array.isArray(filteredReports)) {
        filteredReports = [];
    }

    // Limpiar contenedores
    const containers = document.querySelectorAll('#anormalidades .cards-container');
    containers.forEach(container => {
        container.innerHTML = '';
    });

    // Agrupar por estado
    const reportsByStatus = {
        'Abierto': [],
        'En Progreso': [],
        'Cerrado': []
    };

    filteredReports.forEach(report => {
        const status = report.estado || 'Abierto';
        if (reportsByStatus[status]) {
            reportsByStatus[status].push(report);
        }
    });

    // Renderizar en cada columna
    Object.entries(reportsByStatus).forEach(([status, statusReports]) => {
        const containerId = 'maquinas-' + status.toLowerCase().replace(' ', '-') + '-cards';
        const countId = 'maquinas-' + status.toLowerCase().replace(' ', '-') + '-count';
        
        const container = document.getElementById(containerId);
        const countElement = document.getElementById(countId);
        
        if (container && countElement) {
            countElement.textContent = statusReports.length;
            
            if (statusReports.length === 0) {
                container.innerHTML = `
                    <div class="empty-column">
                        <span>No hay reportes</span>
                    </div>
                `;
            } else {
                statusReports.forEach(report => {
                    container.appendChild(createMaquinaCard(report));
                });
            }
        }
    });
}

/**
 * Maneja errores al cargar reportes de m√°quinas
 */
function handleMaquinasError(error) {
    console.error('Error loading maquinas reports:', error);
    const containers = document.querySelectorAll('#anormalidades .cards-container');
    containers.forEach(container => {
        container.innerHTML = `
            <div class="empty-column">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>Error al cargar reportes</span>
            </div>
        `;
    });
    showAlert('error', 'Error', 'No se pudieron cargar los reportes: ' + error.message);
}

// <CHANGE> Nueva funci√≥n para cambiar criticidad desde el tablero
function changeMaquinaCriticidad(reportId, event) {
    event.stopPropagation(); // Evitar que se active otro evento
    
    const criticidadOptions = [
        { value: 'Alta', label: 'Alta', color: '#dc3545' },
        { value: 'Media', label: 'Media', color: '#ffc107' },
        { value: 'Baja', label: 'Baja', color: '#28a745' }
    ];

    const existingModal = document.getElementById('maquinaCriticidadModal');
    if (existingModal) existingModal.remove();

    const overlay = document.createElement('div');
    overlay.id = 'maquinaCriticidadModal';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

    const modal = document.createElement('div');
    modal.style.cssText = `
        background: #fff; padding: 1.5rem;
        border-radius: 16px; width: 90%; max-width: 400px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    `;

    modal.innerHTML = `
        <h2 style="margin-bottom: 1rem; font-size: 18px; font-weight: 600; color: #1e293b; text-align:center">
            Cambiar Criticidad
        </h2>
        <div id="maquinaCriticidadOptionsContainer" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button id="maquinaCriticidadCancelBtn" style="padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer;">Cancelar</button>
            <button id="maquinaCriticidadConfirmBtn" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: #fff; border-radius: 8px; cursor: pointer;" disabled>Confirmar</button>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const container = modal.querySelector('#maquinaCriticidadOptionsContainer');
    criticidadOptions.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'criticidad-option';
        div.dataset.criticidad = opt.value;
        div.style.cssText = `
            padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
        `;
        div.innerHTML = `
            <div style="width:12px; height:12px; border-radius:50%; background:${opt.color};"></div>
            <span>${opt.label}</span>
        `;
        container.appendChild(div);
    });

    let selectedCriticidad = null;

    container.querySelectorAll('.criticidad-option').forEach(option => {
        option.addEventListener('click', () => {
            container.querySelectorAll('.criticidad-option').forEach(o => {
                o.style.borderColor = '#e2e8f0';
                o.style.background = '#fff';
            });
            option.style.borderColor = '#3b82f6';
            option.style.background = 'rgba(59,130,246,0.05)';
            selectedCriticidad = option.dataset.criticidad;
            modal.querySelector('#maquinaCriticidadConfirmBtn').disabled = false;
        });
    });

    modal.querySelector('#maquinaCriticidadCancelBtn').addEventListener('click', () => overlay.remove());

    modal.querySelector('#maquinaCriticidadConfirmBtn').addEventListener('click', () => {
        if (!selectedCriticidad) return;
        overlay.remove();

        showAlert('info', 'Actualizando...', 'Cambiando criticidad del reporte', 2000);

        google.script.run
            .withSuccessHandler(() => {
                showAlert('success', '√âxito', `Criticidad cambiada a "${selectedCriticidad}"`);
                reloadMaquinasKeepFilters();
            })
            .withFailureHandler(err => {
                console.error('Error:', err);
                showAlert('error', 'Error', 'No se pudo actualizar la criticidad');
            })
            .updateMaquinaCriticidad(reportId, selectedCriticidad);
    });

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
}

let dropdownOpen = false;
let gestionDropdownOpen = false;

function toggleReportesDropdown(event) {
    event.stopPropagation();
    dropdownOpen = !dropdownOpen;
    
    const dropdown = document.getElementById('reportesDropdown');
    if (dropdownOpen) {
        dropdown.classList.add('show');
        dropdown.style.display = 'block';
    } else {
        dropdown.classList.remove('show');
        dropdown.style.display = 'none';
    }
}

function hideReportesDropdown() {
    dropdownOpen = false;
    const dropdown = document.getElementById('reportesDropdown');
    dropdown.classList.remove('show');
    dropdown.style.display = 'none';
}

// Cerrar dropdown al hacer clic afuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.nav-dropdown')) {
        hideReportesDropdown();
        hideGestionDropdown();
    }
});


function toggleGestionDropdown(event) {
    event.stopPropagation();
    gestionDropdownOpen = !gestionDropdownOpen;
    reportesDropdownOpen = false; // Cerrar el otro dropdown
    
    const dropdown = document.getElementById('gestionDropdown');
    const reportesDropdown = document.getElementById('reportesDropdown');
    
    if (gestionDropdownOpen) {
        dropdown.classList.add('show');
        dropdown.style.display = 'block';
        reportesDropdown.classList.remove('show');
        reportesDropdown.style.display = 'none';
    } else {
        dropdown.classList.remove('show');
        dropdown.style.display = 'none';
    }
}

function hideGestionDropdown() {
    gestionDropdownOpen = false;
    const dropdown = document.getElementById('gestionDropdown');
    dropdown.classList.remove('show');
    dropdown.style.display = 'none';
}

// <CHANGE> Cargar todos los reportes consolidados
function loadConsolidadoReports() {
    showConsolidadoLoadingSpinner();
    
    google.script.run
        .withSuccessHandler(function(data) {
            console.log('[v0] Consolidado cargado:', data);
            consolidadoData = data;
            displayConsolidadoReportsByProcess(data);
        })
        .withFailureHandler(function(err) {
            console.error('[v0] Error al cargar consolidado:', err);
            handleConsolidadoError(err);
        })
        .getConsolidadoReports();
}

// <CHANGE> Mostrar spinner en consolidado
function showConsolidadoLoadingSpinner() {
    const container = document.getElementById('consolidadoContainer');
    if (container) {
        container.innerHTML = '<div class="loading-spinner">Cargando reportes...</div>';
    }
}

// <CHANGE> Manejar errores del consolidado
function handleConsolidadoError(error) {
    console.error('Error loading consolidado:', error);
    const container = document.getElementById('consolidadoContainer');
    if (container) {
        container.innerHTML = `
            <div class="consolidado-empty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <h3>Error al cargar reportes</h3>
                <p>${error.message || 'Intenta nuevamente'}</p>
            </div>
        `;
    }
}

function displayConsolidadoReportsByProcess(data) {
    const container = document.getElementById('consolidadoContainer');
    if (!container) {
        console.log('[v0] Contenedor consolidado no encontrado');
        return;
    }

    loadProcesosFilter(data);
    
    const reportesPorProceso = {};
    
    // Agrupar N2 por proceso
    if (data.n2 && Array.isArray(data.n2)) {
        data.n2.forEach(report => {
            const proceso = report.proceso || 'Sin proceso';
            if (!reportesPorProceso[proceso]) reportesPorProceso[proceso] = [];
            reportesPorProceso[proceso].push({ type: 'n2', ...report });
        });
    }
    
    // Agrupar Tarjetas por zona de riesgo
    if (data.tarjetas && Array.isArray(data.tarjetas)) {
        data.tarjetas.forEach(report => {
            const proceso = report.zonaRiesgo || 'Sin zona';
            if (!reportesPorProceso[proceso]) reportesPorProceso[proceso] = [];
            reportesPorProceso[proceso].push({ type: 'tarjeta', ...report });
        });
    }
    
    // Agrupar M√°quinas por proceso
    if (data.maquinas && Array.isArray(data.maquinas)) {
        data.maquinas.forEach(report => {
            const proceso = report.proceso || 'Sin proceso';
            if (!reportesPorProceso[proceso]) reportesPorProceso[proceso] = [];
            reportesPorProceso[proceso].push({ type: 'maquina', ...report });
        });
    }
    
    // Agrupar Ciclos por proceso
    if (data.ciclos && Array.isArray(data.ciclos)) {
        data.ciclos.forEach(report => {
            const proceso = report.proceso || 'Sin proceso';
            if (!reportesPorProceso[proceso]) reportesPorProceso[proceso] = [];
            reportesPorProceso[proceso].push({ type: 'ciclo', ...report });
        });
    }
    
    container.innerHTML = '';
    
    if (Object.keys(reportesPorProceso).length === 0) {
        container.innerHTML = `<div class="consolidado-empty"><h3> No hay reportes</h3><p>No se encontraron reportes en el sistema</p></div>`;
        return;
    }
    
    // Ordenar procesos alfab√©ticamente
    const procesosOrdenados = Object.keys(reportesPorProceso).sort();
    
    procesosOrdenados.forEach(proceso => {
        const reportes = reportesPorProceso[proceso];
        
        const procesoSection = document.createElement('div');
        procesoSection.className = 'consolidado-proceso-section';
        
        // Contar reportes por tipo
        const resumenN2 = reportes.filter(r => r.type === 'n2').length;
        const resumenTarjetas = reportes.filter(r => r.type === 'tarjeta').length;
        const resumenMaquinas = reportes.filter(r => r.type === 'maquina').length;
        const resumenCiclos = reportes.filter(r => r.type === 'ciclo').length; // Nuevo
        const totalCount = reportes.length;
        
        const header = document.createElement('div');
        header.className = 'consolidado-proceso-header';
        header.innerHTML = `
            <div class="consolidado-proceso-name">${proceso}</div>
            <div class="consolidado-proceso-stats">
                <span>Total: <strong>${totalCount}</strong></span>
                ${resumenN2 > 0 ? `<span>N2: <strong>${resumenN2}</strong></span>` : ''}
                ${resumenTarjetas > 0 ? `<span>Tarjetas: <strong>${resumenTarjetas}</strong></span>` : ''}
                ${resumenMaquinas > 0 ? `<span>M√°quinas: <strong>${resumenMaquinas}</strong></span>` : ''}
                ${resumenCiclos > 0 ? `<span>Ciclos: <strong>${resumenCiclos}</strong></span>` : ''}
            </div>
        `;
        procesoSection.appendChild(header);
        
        const grid = document.createElement('div');
        grid.className = 'consolidado-reports-grid';
        reportes.forEach(report => {
            grid.appendChild(createConsolidadoReportItem(report));
        });
        procesoSection.appendChild(grid);
        
        container.appendChild(procesoSection);
    });
}

function createConsolidadoReportItem(report) {
    const item = document.createElement('div');
    item.className = 'consolidado-report-item';
    
    let tipo = '', badgeClass = '', titulo = '', descricao = '';
    let nombrePersona = '';
    let nombreRespo = '';
    let infoExtra = '';
    
    if (report.type === 'n2') {
        tipo = 'N2';
        badgeClass = 'n2';
        titulo = report.proceso + " - " + (report.zonaProceso || '');
        descricao = report.anormalidad || '';
        nombrePersona = report.nombreCedula || 'Sin nombre';
        // Para N2 usamos liderResponsable
        nombreRespo = report.liderResponsable || 'Sin responsable';
        infoExtra = `
            <div class="consolidado-report-extra">
                <span class="extra-item">Zona: ${report.zonaProceso || 'N/A'}</span>
                <span class="extra-item">Proceso Resp.: ${report.procesoResponsable || 'N/A'}</span>
            </div>
        `;
    } else if (report.type === 'tarjeta') {
        tipo = 'Tarjeta';
        badgeClass = 'tarjeta';
        titulo = report.zonaRiesgo + " - " + (report.ubicacion || '');
        descricao = report.descripcionProblema || '';
        nombrePersona = report.nombreCedula || 'Sin nombre';
        // CORRECCI√ìN: Para tarjetas usamos responsableNombreVisualizarReporte
        nombreRespo = report.responsableNombreVisualizarReporte || 'Sin responsable';
        infoExtra = `
            <div class="consolidado-report-extra">
                <span class="extra-item">Prioridad: ${report.prioridad || 'N/A'}</span>
                <span class="extra-item">Tipo Riesgo: ${report.tipoRiesgo || 'N/A'}</span>
            </div>
        `;
    } else if (report.type === 'maquina') {
        tipo = 'M√°quina';
        badgeClass = 'maquina';
        titulo = report.proceso + " - " + (report.areaProceso || '');
        descricao = report.anormalidad || '';
        nombrePersona = report.nombreCedula || report.mecanicoResponsable || 'Sin nombre';
        nombreRespo = report.mecanicoResponsable || 'Sin responsable';
        infoExtra = `
            <div class="consolidado-report-extra">
                <span class="extra-item">√Årea: ${report.areaProceso || 'N/A'}</span>
                <span class="extra-item">Criticidad: ${report.criticidad || 'N/A'}</span>
            </div>
        `;
    } else if (report.type === 'ciclo') {
        tipo = 'Ciclos de Mejora';
        badgeClass = 'ciclo';
        titulo = report.nombreCiclo || report.id || 'Ciclo sin nombre';
        descricao = report.defecto || report.descripcion || 'Sin descripci√≥n';
        nombrePersona = report.creadoPor || report.lider || 'Sin l√≠der';
        nombreRespo = report.lider || 'Sin responsable';
        
        // Extraer tipo de foco (si est√° en datosFoco)
        let tipoFoco = 'No especificado';
        let focoDetalle = '';
        
        if (report.datosFoco) {
            try {
                const datosFoco = JSON.parse(report.datosFoco);
                if (datosFoco.tipo === 'indicador') {
                    tipoFoco = 'Indicador';
                    focoDetalle = datosFoco.nombreKPI || 'KPI no especificado';
                } else if (datosFoco.tipo === 'proceso') {
                    tipoFoco = 'Proceso';
                    focoDetalle = datosFoco.procesoSimplificar || 'Proceso no especificado';
                } else if (datosFoco.tipo === 'error') {
                    tipoFoco = 'Error';
                    focoDetalle = datosFoco.declaracionProblema || 'Error no especificado';
                }
            } catch (e) {
                tipoFoco = 'Error en datos';
            }
        }
        
        infoExtra = `
            <div class="consolidado-report-extra">
                <span class="extra-item">Foco: ${tipoFoco}</span>
                <span class="extra-item">Equipo: ${report.equipo || 'N/A'}</span>
                <span class="extra-item">Aviso: ${report.aviso || 'N/A'}</span>
            </div>
            ${focoDetalle ? `<div class="foco-detalle" style="font-size: 12px; color: #666; margin-top: 4px;">${focoDetalle}</div>` : ''}
        `;
    }
    
    const fecha = report.fechaRegistro || report.fechaCreacion || report.fecha || '';
    const estado = report.estado || 'Abierto';
    const estadoColor = estado === 'Completado' || estado === 'Cerrada' || estado === 'Cerrado' || estado === 'Implementado' ? '#28a745' : 
                       estado === 'En Progreso' || estado === 'En Progreso' ? '#007bff' : 
                       estado === 'En Revision' ? '#fd7e14' : '#6c757d';
    
    item.innerHTML = `
        <div class="consolidado-report-header">
            <div class="consolidado-report-type ${badgeClass}">${tipo}</div>
            <div class="consolidado-person-name" style="display:none;">${nombrePersona}</div>
            <div class="consolidado-respo-name" style="display:none;">${nombreRespo}</div>
        </div>
        <div class="consolidado-report-title">${titulo}</div>
        <div style="font-size: 13px; color: #94a3b8; line-height: 1.2; margin: 4px 0;">${descricao || '(Sin desc.)'}</div>
        ${infoExtra}
        <div class="consolidado-report-meta">
            <span style="color: ${estadoColor}; font-weight: 600;">${estado}</span>
            <span>${fecha ? fecha.split(' ')[0] : 'S/F'}</span>
        </div>
        <div class="consolidado-report-person">
            <strong>Persona que reporta:</strong> ${nombrePersona}
        </div>
        ${nombreRespo !== nombrePersona ? `<div class="consolidado-report-person">
            <strong>Responsable:</strong> ${nombreRespo}
        </div>` : ''}
    `;
    
    return item;
}

function clearEmptyMessages() {
    const container = document.getElementById('consolidadoContainer');
    const emptyMessages = container.querySelectorAll('.consolidado-empty');
    emptyMessages.forEach(msg => msg.remove());
}

function filterConsolidadoByName() {
    const selectedProceso = document.getElementById('consolidadoProcesoFilter').value;
    const selectedType = document.getElementById('ConsolidadoFilter').value;
    const searchTerm = document.getElementById('consolidadoSearch').value.toLowerCase();
    const container = document.getElementById('consolidadoContainer');
    const procesoSections = container.querySelectorAll('.consolidado-proceso-section');
    
    clearEmptyMessages();
    
    let visibles = 0;
    
    procesoSections.forEach(section => {
        const procesoName = section.querySelector('.consolidado-proceso-name').textContent;
        const reportItems = section.querySelectorAll('.consolidado-report-item');
        
        const matchesProceso = selectedProceso === 'all' || procesoName === selectedProceso;
        
        let hasVisibleReports = false;
        
        reportItems.forEach(item => {
            const tipoReporte = item.querySelector('.consolidado-report-type')?.textContent.trim() || '';
            const nombrePersona = item.querySelector('.consolidado-person-name')?.textContent.toLowerCase() || '';
            
            const matchesType = selectedType === 'all' || 
                               (selectedType === 'N2' && tipoReporte === 'N2') ||
                               (selectedType === 'Tarjetas de Anormalidades' && tipoReporte === 'Tarjeta') ||
                               (selectedType === 'Anormalidades Criticas' && tipoReporte === 'M√°quina') ||
                               (selectedType === 'Ciclos de Mejora' && tipoReporte === 'Ciclos de Mejora'); // Nuevo
            
            const matchesName = searchTerm === '' || nombrePersona.includes(searchTerm);
            
            if (matchesProceso && matchesType && matchesName) {
                item.style.display = 'block';
                hasVisibleReports = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (matchesProceso && hasVisibleReports) {
            section.style.display = 'block';
            visibles++;
        } else {
            section.style.display = 'none';
        }
    });
    
    if (visibles === 0) {
        showConsolidadoEmptyMessage(selectedProceso, selectedType, searchTerm);
    }
}

function filterConsolidadoByRespo() {
    const selectedProceso = document.getElementById('consolidadoProcesoFilter').value;
    const selectedType = document.getElementById('ConsolidadoFilter').value;
    const searchTerm = document.getElementById('consolidadoSearch').value.toLowerCase();
    const respoSearchTerm = document.getElementById('consolidadoRespoSearch').value.toLowerCase(); // Nuevo: b√∫squeda por responsable
    
    const container = document.getElementById('consolidadoContainer');
    const procesoSections = container.querySelectorAll('.consolidado-proceso-section');
    
    clearEmptyMessages();
    
    let visibles = 0;
    
    procesoSections.forEach(section => {
        const procesoName = section.querySelector('.consolidado-proceso-name').textContent;
        const reportItems = section.querySelectorAll('.consolidado-report-item');
        
        const matchesProceso = selectedProceso === 'all' || procesoName === selectedProceso;
        
        let hasVisibleReports = false;
        
        reportItems.forEach(item => {
            const tipoReporte = item.querySelector('.consolidado-report-type')?.textContent.trim() || '';
            const nombrePersona = item.querySelector('.consolidado-person-name')?.textContent.toLowerCase() || '';
            const nombreRespo = item.querySelector('.consolidado-respo-name')?.textContent.toLowerCase() || '';
            
            const matchesType = selectedType === 'all' || 
                               (selectedType === 'N2' && tipoReporte === 'N2') ||
                               (selectedType === 'Tarjetas de Anormalidades' && tipoReporte === 'Tarjeta') ||
                               (selectedType === 'Anormalidades Criticas' && tipoReporte === 'M√°quina') ||
                               (selectedType === 'Ciclos de Mejora' && tipoReporte === 'Ciclos de Mejora');
            
            // B√∫squeda por nombre de persona
            const matchesName = searchTerm === '' || nombrePersona.includes(searchTerm);
            
            // NUEVO: B√∫squeda por responsable
            const matchesRespo = respoSearchTerm === '' || nombreRespo.includes(respoSearchTerm);
            
            // Combinar todos los filtros
            if (matchesProceso && matchesType && matchesName && matchesRespo) {
                item.style.display = 'block';
                hasVisibleReports = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (matchesProceso && hasVisibleReports) {
            section.style.display = 'block';
            visibles++;
        } else {
            section.style.display = 'none';
        }
    });
    
    if (visibles === 0) {
        showConsolidadoEmptyMessageWithRespo(selectedProceso, selectedType, searchTerm, respoSearchTerm);
    }
}

function applyTypesFilter() {
    filterConsolidadoByName();
    filterConsolidadoByRespo();
}

let procesosDisponibles = [];

function loadProcesosFilter(data) {
    const procesoFilter = document.getElementById('consolidadoProcesoFilter');
    if (!procesoFilter) return;
    
    procesoFilter.innerHTML = '<option value="all">Todos los procesos/zonas</option>';
    
    const procesosSet = new Set();
    
    // Procesar N2
    if (data.n2 && Array.isArray(data.n2)) {
        data.n2.forEach(report => {
            if (report.proceso) procesosSet.add(report.proceso);
        });
    }
    
    // Procesar Tarjetas
    if (data.tarjetas && Array.isArray(data.tarjetas)) {
        data.tarjetas.forEach(report => {
            if (report.zonaRiesgo) procesosSet.add(report.zonaRiesgo);
        });
    }
    
    // Procesar M√°quinas
    if (data.maquinas && Array.isArray(data.maquinas)) {
        data.maquinas.forEach(report => {
            if (report.proceso) procesosSet.add(report.proceso);
        });
    }
    
    // Procesar Ciclos (NUEVO)
    if (data.ciclos && Array.isArray(data.ciclos)) {
        data.ciclos.forEach(report => {
            if (report.proceso) procesosSet.add(report.proceso);
        });
    }
    
    procesosDisponibles = Array.from(procesosSet).sort();
    
    procesosDisponibles.forEach(proceso => {
        const option = document.createElement('option');
        option.value = proceso;
        option.textContent = proceso;
        procesoFilter.appendChild(option);
    });
}

function filterConsolidadoByProcess() {
    const selectedProceso = document.getElementById('consolidadoProcesoFilter').value;
    const selectedType = document.getElementById('ConsolidadoFilter').value;
    const searchTerm = document.getElementById('consolidadoSearch').value.toLowerCase();
    const container = document.getElementById('consolidadoContainer');
    const procesoSections = container.querySelectorAll('.consolidado-proceso-section');
    
    clearEmptyMessages();
    
    let visibles = 0;
    
    procesoSections.forEach(section => {
        const procesoName = section.querySelector('.consolidado-proceso-name').textContent;
        const reportItems = section.querySelectorAll('.consolidado-report-item');
        
        // Verificar si el proceso coincide con el filtro
        const matchesProceso = selectedProceso === 'all' || procesoName === selectedProceso;
        
        let hasVisibleReports = false;
        
        // Filtrar cada reporte individualmente
        reportItems.forEach(item => {
            const tipoReporte = item.querySelector('.consolidado-report-type')?.textContent.trim() || '';
            const nombrePersona = item.querySelector('.consolidado-person-name')?.textContent.toLowerCase() || '';
            
            const matchesType = selectedType === 'all' || 
                               (selectedType === 'N2' && tipoReporte === 'N2') ||
                               (selectedType === 'Tarjetas de Anormalidades' && tipoReporte === 'Tarjeta') ||
                               (selectedType === 'Anormalidades Criticas' && tipoReporte === 'M√°quina'); 
                               (selectedType === 'Ciclos de Mejora' && tipoReporte === 'Ciclos de Mejora');
            
            const matchesName = searchTerm === '' || nombrePersona.includes(searchTerm);
            
            // Mostrar u ocultar cada reporte individualmente
            if (matchesProceso && matchesType && matchesName) {
                item.style.display = 'block';
                hasVisibleReports = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Mostrar/ocultar la secci√≥n completa
        if (matchesProceso && hasVisibleReports) {
            section.style.display = 'block';
            visibles++;
        } else {
            section.style.display = 'none';
        }
    });
    
    if (visibles === 0) {
        showConsolidadoEmptyMessage(selectedProceso, selectedType, searchTerm);
    }
}

function showConsolidadoEmptyMessage(selectedProceso, selectedType, searchTerm) {
    const container = document.getElementById('consolidadoContainer');
    const empty = document.createElement('div');
    empty.className = 'consolidado-empty';
    
    let message = '';
    
    if (selectedProceso !== 'all' && selectedType !== 'all' && searchTerm !== '') {
        message = `No se encontraron reportes del proceso "${selectedProceso}", tipo "${selectedType}" y nombre "${searchTerm}"`;
    } else if (selectedProceso !== 'all' && selectedType !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}" y tipo "${selectedType}"`;
    } else if (selectedProceso !== 'all' && searchTerm !== '') {
        message = `No se encontraron reportes del proceso "${selectedProceso}" y nombre "${searchTerm}"`;
    } else if (selectedType !== 'all' && searchTerm !== '') {
        message = `No se encontraron reportes del tipo "${selectedType}" y nombre "${searchTerm}"`;
    } else if (selectedProceso !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}"`;
    } else if (selectedType !== 'all') {
        message = `No se encontraron reportes del tipo "${selectedType}"`;
    } else if (searchTerm !== '') {
        message = `No se encontraron reportes del nombre "${searchTerm}"`;
    } else {
        message = 'No se encontraron reportes en el sistema';
    }
    
    empty.innerHTML = `<h3> Sin resultados</h3><p>${message}</p>`;
    container.appendChild(empty);
}

function showConsolidadoEmptyMessageWithRespo(selectedProceso, selectedType, searchTerm, respoSearchTerm) {
    const container = document.getElementById('consolidadoContainer');
    const empty = document.createElement('div');
    empty.className = 'consolidado-empty';
    
    let message = '';
    
    // L√≥gica para mensajes combinados
    if (searchTerm && respoSearchTerm && selectedProceso !== 'all' && selectedType !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}", tipo "${selectedType}", nombre "${searchTerm}" y responsable "${respoSearchTerm}"`;
    } else if (respoSearchTerm && selectedProceso !== 'all' && selectedType !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}", tipo "${selectedType}" y responsable "${respoSearchTerm}"`;
    } else if (respoSearchTerm && selectedProceso !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}" y responsable "${respoSearchTerm}"`;
    } else if (respoSearchTerm && selectedType !== 'all') {
        message = `No se encontraron reportes del tipo "${selectedType}" y responsable "${respoSearchTerm}"`;
    } else if (respoSearchTerm && searchTerm) {
        message = `No se encontraron reportes del nombre "${searchTerm}" y responsable "${respoSearchTerm}"`;
    } else if (respoSearchTerm) {
        message = `No se encontraron reportes del responsable "${respoSearchTerm}"`;
    } else if (selectedProceso !== 'all' && selectedType !== 'all' && searchTerm) {
        message = `No se encontraron reportes del proceso "${selectedProceso}", tipo "${selectedType}" y nombre "${searchTerm}"`;
    } else if (selectedProceso !== 'all' && selectedType !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}" y tipo "${selectedType}"`;
    } else if (selectedProceso !== 'all' && searchTerm) {
        message = `No se encontraron reportes del proceso "${selectedProceso}" y nombre "${searchTerm}"`;
    } else if (selectedType !== 'all' && searchTerm) {
        message = `No se encontraron reportes del tipo "${selectedType}" y nombre "${searchTerm}"`;
    } else if (selectedProceso !== 'all') {
        message = `No se encontraron reportes del proceso "${selectedProceso}"`;
    } else if (selectedType !== 'all') {
        message = `No se encontraron reportes del tipo "${selectedType}"`;
    } else if (searchTerm) {
        message = `No se encontraron reportes del nombre "${searchTerm}"`;
    } else {
        message = 'No se encontraron reportes en el sistema';
    }
    
    empty.innerHTML = `<h3> Sin resultados</h3><p>${message}</p>`;
    container.appendChild(empty);
}

function clearConsolidadoFilters() {
    document.getElementById('consolidadoProcesoFilter').value = 'all';
    document.getElementById('ConsolidadoFilter').value = 'all';
    document.getElementById('consolidadoSearch').value = '';
    document.getElementById('consolidadoRespoSearch').value = ''; // Limpiar b√∫squeda de responsable
    filterConsolidadoByRespo();
}

function validarLongitudUbicacion(input) {
    const maxLength = 36;
    let currentLength = input.value.length;
    
    // Cortar si excede el l√≠mite
    if (currentLength > maxLength) {
        input.value = input.value.substring(0, maxLength);
        currentLength = maxLength;
    }
    
    // Actualizar contador
    const counter = document.getElementById('contador-ubicacion');
    if (counter) {
        counter.textContent = `${currentLength}/${maxLength}`;
        
        // Cambiar color seg√∫n el l√≠mite
        if (currentLength >= maxLength) {
            counter.style.color = '#dc2626';
            counter.style.fontWeight = '600';
        } else if (currentLength >= 30) { // Aviso cuando est√© cerca del l√≠mite
            counter.style.color = '#f59e0b';
            counter.style.fontWeight = '500';
        } else {
            counter.style.color = '#64748b';
            counter.style.fontWeight = '400';
        }
    }
}

function showTarjetasCommentsModal(tarjetaId) {
  const existingModal = document.getElementById('commentModalTarjetas');
  if (existingModal) existingModal.remove();

  const overlay = document.createElement('div');
  overlay.id = 'commentModalTarjetas';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

  modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600; margin:0;">
      <i class="fa-regular fa-comments"></i> Seguimiento de la Tarjeta
    </h2>

    <div id="commentsList" style="
      max-height:240px; overflow:auto; border:1px solid #e2e8f0;
      border-radius:8px; padding:0.75rem; background:#f8fafc;
    ">
      <div style="text-align:center; color:#94a3b8;">Cargando comentarios...</div>
    </div>

    <textarea id="newComment" placeholder="Escribe tu comentario..." rows="3"
      style="width:100%; padding:0.75rem; border:1px solid #cbd5e1; border-radius:8px; resize:vertical;"></textarea>

    <div style="display:flex; justify-content:flex-end; gap:0.75rem;">
      <button id="cancelComment" style="
        padding:0.5rem 1rem; border:1px solid #cbd5e1;
        border-radius:8px; cursor:pointer; background:#fff;
      ">Cancelar</button>

      <button id="saveComment" style="
        padding:0.5rem 1rem; border:none; background:#3b82f6;
        color:#fff; border-radius:8px; cursor:pointer;
      ">Guardar</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const commentsList = modal.querySelector('#commentsList');
  const textarea = modal.querySelector('#newComment');
  const saveBtn = modal.querySelector('#saveComment');

  function loadComments() {
    google.script.run
      .withSuccessHandler(comments => {
        if (!comments || comments.length === 0) {
          commentsList.innerHTML = `<div style="color:#94a3b8;">No hay comentarios todav√≠a</div>`;
          return;
        }

        commentsList.innerHTML = comments.map(c => `
          <div style="padding:0.5rem 0; border-bottom:1px solid #e2e8f0;">
            <div style="font-weight:600; color:#0f172a; font-size:13px;">${escapeHtml(c.autor)}</div>
            <div style="font-size:12px; color:#94a3b8;">${escapeHtml(c.fecha)}</div>
            <div style="margin-top:4px; font-size:14px; color:#334155;">${escapeHtml(c.comentario)}</div>
          </div>
        `).join('');
        commentsList.scrollTop = commentsList.scrollHeight;
      })
      .withFailureHandler(err => {
        console.error(err);
        commentsList.innerHTML = `<div style="color:#ef4444;">Error al cargar comentarios</div>`;
      })
      .getTarjetasCommentsForReport(tarjetaId);
  }

  loadComments();

  modal.querySelector('#cancelComment').addEventListener('click', () => overlay.remove());

  saveBtn.addEventListener('click', () => {
    const comment = textarea.value.trim();
    if (!comment) {
      showAlert('warning', 'Campo vac√≠o', 'Debes escribir un comentario');
      return;
    }

    // üîπ MISMOS C√ìDIGO QUE USA N2 Y M√ÅQUINAS
    const autor = (typeof currentUser !== 'undefined' && (currentUser.nombre || currentUser.cedula))
      ? (currentUser.nombre || currentUser.cedula)
      : 'Usuario desconocido';

    console.log('üîç Autor que se enviar√°:', autor);

    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', 'Comentario agregado', 'Se guard√≥ correctamente');
        textarea.value = '';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
        loadComments();
        loadTarjetasCommentsCount();
      })
      .withFailureHandler(err => {
        console.error(err);
        showAlert('error', 'Error', 'No se pudo guardar el comentario');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      })
      .addTarjetaCommentToReport(tarjetaId, comment, autor);
  });

  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.remove();
  });
}

function loadTarjetasCommentsCount() {
  google.script.run
    .withSuccessHandler(updateTarjetasCommentCounters)
    .getTarjetasCommentsCountForReports();
}

function updateTarjetasCommentCounters(counts) {
  for (const [tarjetaId, count] of Object.entries(counts)) {
    const badge = document.getElementById(`comment-count-tar-${tarjetaId}`);
    if (badge) {
      badge.textContent = count;
      if (count > 0) {
        badge.style.backgroundColor = '#007bff';
        badge.style.color = 'white';
      } else {
        badge.style.backgroundColor = 'transparent';
        badge.style.color = 'black';
      }
    }
  }
}

/**
 * Muestra/oculta el formulario de registro con animaci√≥n deslizante horizontal
 */
function toggleRegisterForm() {
    const registerContainer = document.getElementById('registerContainer');
    const cardsWrapper = document.querySelector('.cards-wrapper');
    
    // Toggle de las clases para la animaci√≥n
    registerContainer.classList.toggle('active');
    cardsWrapper.classList.toggle('register-active');
    
    // Limpiar mensajes de error/√©xito al cambiar
    document.getElementById('registerError').style.display = 'none';
    document.getElementById('registerSuccess').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
}

/**
 * Maneja el registro de un nuevo usuario
 */
function handleRegister(event) {
    event.preventDefault();
    
    const registerBtn = document.getElementById('registerBtn');
    const registerBtnText = document.getElementById('registerBtnText');
    const registerBtnSpinner = document.getElementById('registerBtnSpinner');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');
    
    // Obtener valores del formulario
    const formData = {
        nombres: document.getElementById('regNombres').value.trim(),
        apellidos: document.getElementById('regApellidos').value.trim(),
        cedula: document.getElementById('regCedula').value.trim(),
        correo: document.getElementById('regCorreo').value.trim(),
        proceso: document.getElementById('regProceso').value,
        empresa: document.getElementById('regEmpresa').value
    };
    
    // Validaciones b√°sicas
    if (!formData.nombres || !formData.apellidos || !formData.cedula || 
        !formData.correo || !formData.proceso || !formData.empresa) {
        showRegisterError('Por favor complete todos los campos');
        return;
    }
    
    // Validar formato de c√©dula (solo n√∫meros)
    if (!/^\d+$/.test(formData.cedula)) {
        showRegisterError('La c√©dula debe contener solo n√∫meros');
        return;
    }
    
    // Validar formato de correo
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.correo)) {
        showRegisterError('Por favor ingrese un correo v√°lido');
        return;
    }
    
    // Mostrar spinner
    registerBtn.disabled = true;
    registerBtnText.style.display = 'none';
    registerBtnSpinner.style.display = 'inline-block';
    registerError.style.display = 'none';
    registerSuccess.style.display = 'none';
    
    // Enviar datos al backend
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // Mostrar mensaje de √©xito
                registerSuccess.textContent = '¬°Registro exitoso! Ya puede iniciar sesi√≥n con su c√©dula.';
                registerSuccess.style.display = 'block';
                
                // Limpiar formulario
                document.getElementById('registerForm').reset();
                
                // Despu√©s de 3 segundos, volver al login
                setTimeout(function() {
                    toggleRegisterForm();
                    // Pre-llenar la c√©dula en el login
                    document.getElementById('cedulaInput').value = formData.cedula;
                }, 3000);
            } else {
                showRegisterError(result.message || 'Error al registrar. Intente nuevamente.');
            }
            resetRegisterButton();
        })
        .withFailureHandler(function(error) {
            console.error('Error en registro:', error);
            showRegisterError('Error al registrar: ' + error.message);
            resetRegisterButton();
        })
        .registrarUsuario(formData);
}

/**
 * Muestra un mensaje de error en el registro
 */
function showRegisterError(message) {
    const registerError = document.getElementById('registerError');
    registerError.textContent = message;
    registerError.style.display = 'block';
}

/**
 * Resetea el bot√≥n de registro a su estado original
 */
function resetRegisterButton() {
    const registerBtn = document.getElementById('registerBtn');
    const registerBtnText = document.getElementById('registerBtnText');
    const registerBtnSpinner = document.getElementById('registerBtnSpinner');
    
    registerBtn.disabled = false;
    registerBtnText.style.display = 'inline';
    registerBtnSpinner.style.display = 'none';
}

const buttonStateManager = {
    bloquear: function(boton, textoOriginal) {
        boton.dataset.originalText = textoOriginal || boton.textContent;
        boton.disabled = true;
        boton.textContent = 'Enviando...';
        boton.style.opacity = '0.7';
        boton.style.cursor = 'not-allowed';
    },
    
    desbloquear: function(boton) {
        boton.disabled = false;
        boton.textContent = boton.dataset.originalText || 'Enviar';
        boton.style.opacity = '1';
        boton.style.cursor = 'pointer';
    }
};

// ========== FUNCIONES CICLO DE MEJORA ==========

// Mapeo de categor√≠as para mostrar en la tabla
const categoriaLabels = {
    'ambiente': 'Medio Ambiente',
    'mano': 'Mano de Obra',
    'materiales': 'Materiales',
    'tiempo': 'Tiempo',
    'metodo': 'M√©todo',
    'maquina': 'M√°quina'
};

function initCicloMejoraForm() {
    const fechaField = document.getElementById('fechaCiclo');
    if (fechaField) {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        };
        fechaField.value = now.toLocaleDateString('es-CO', options);
    }
    
    google.script.run
        .withSuccessHandler(function(nextId) {
            const idField = document.getElementById('cicloMejoraId');
            if (idField) idField.value = nextId;
        })
        .withFailureHandler(function(error) {
            console.error('Error obteniendo ID de ciclo:', error);
            document.getElementById('cicloMejoraId').value = 'CM-001';
        })
        .getNextCicloId();
    
    // Limpiar integrantes seleccionados
    limpiarIntegrantesCiclo();
    setupCausaListeners();
    limpiarPlanAccion();
    setupCausaListeners();
}

// Configurar listeners en inputs de causas
function setupCausaListeners() {
    document.querySelectorAll('.cause-input-pro').forEach(input => {
        input.removeEventListener('input', actualizarTabla5Porques);
        input.addEventListener('input', actualizarTabla5Porques);
    });
    
    // Listener para el defecto principal
    const defectoInput = document.getElementById('defectoPrincipal');
    const defectBox = document.getElementById('defectBox');
    if (defectoInput && defectBox) {
        defectoInput.addEventListener('input', function() {
            const text = this.value.trim();
            defectBox.textContent = text.length > 15 ? text.substring(0, 15) + '...' : (text || 'DEFECTO');
        });
    }
}

// Agregar nueva causa a una categor√≠a
function agregarCausa(categoria) {
    const container = document.getElementById('causas-' + categoria);
    if (!container) return;
    
    const newCause = document.createElement('div');
    newCause.className = 'cause-row';
    newCause.innerHTML = `
        <input type="text" class="cause-input-pro" data-category="${categoria}" placeholder="Causa...">
        <button type="button" class="cause-remove-btn" onclick="eliminarCausa(this)">√ó</button>
    `;
    
    container.appendChild(newCause);
    
    // Agregar listener al nuevo input
    const newInput = newCause.querySelector('input');
    newInput.addEventListener('input', actualizarTabla5Porques);
    newInput.focus();
}

// Eliminar una causa
function eliminarCausa(btn) {
    const causeRow = btn.closest('.cause-row');
    const container = causeRow.parentElement;
    
    // Mantener al menos un input por categor√≠a
    if (container.querySelectorAll('.cause-row').length > 1) {
        causeRow.style.animation = 'fadeOut 0.2s ease';
        setTimeout(() => {
            causeRow.remove();
            actualizarTabla5Porques();
        }, 200);
    }
}

// Mostrar/ocultar secci√≥n 5 Por Qu√©
function mostrar5Porques(mostrar) {
    const seccion = document.getElementById('seccion5Porques');
    const btnSi = document.getElementById('btnSiPorques');
    const btnNo = document.getElementById('btnNoPorques');
    
    if (mostrar) {
        seccion.style.display = 'block';
        btnSi.classList.add('active');
        btnNo.classList.remove('active');
        actualizarTabla5Porques();
    } else {
        seccion.style.display = 'none';
        btnSi.classList.remove('active');
        btnNo.classList.add('active');
    }
}

// Recopilar todas las causas agrupadas por categor√≠a
function recopilarTodasLasCausas() {
    const causasPorCategoria = {};
    const categorias = ['ambiente', 'mano', 'materiales', 'tiempo', 'metodo', 'maquina'];
    
    categorias.forEach(cat => {
        causasPorCategoria[cat] = [];
        const container = document.getElementById('causas-' + cat);
        if (container) {
            container.querySelectorAll('.cause-input-pro').forEach(input => {
                const valor = input.value.trim();
                if (valor) {
                    causasPorCategoria[cat].push(valor);
                }
            });
        }
    });
    
    return causasPorCategoria;
}

// Actualizar la tabla de 5 Por Qu√© autom√°ticamente
function actualizarTabla5Porques() {
    const tbody = document.getElementById('tbody5Porques');
    if (!tbody) return;
    
    const causasPorCategoria = recopilarTodasLasCausas();
    let hayAlgunaCausa = false;
    
    Object.values(causasPorCategoria).forEach(causas => {
        if (causas.length > 0) hayAlgunaCausa = true;
    });
    
    if (!hayAlgunaCausa) {
        tbody.innerHTML = `
            <tr class="empty-row">
                <td colspan="9" class="empty-message">  <!-- Cambiado de 7 a 9 columnas -->
                    Complete las causas en el diagrama de Espina de Pescado para generar el an√°lisis
                </td>
            </tr>
        `;
        return;
    }
    
    const valoresExistentes = guardarValoresTabla();
    
    let html = '';
    const categorias = ['ambiente', 'mano', 'materiales', 'tiempo', 'metodo', 'maquina'];
    
    categorias.forEach(cat => {
        const causas = causasPorCategoria[cat];
        if (causas.length === 0) return;
        
        causas.forEach((causa, index) => {
            const rowKey = `${cat}-${index}`;
            const valores = valoresExistentes[rowKey] || {};
            
            html += `
                <tr data-row-key="${rowKey}">
                    ${index === 0 ? `<td class="td-categoria" rowspan="${causas.length}">${categoriaLabels[cat]}</td>` : ''}
                    <td class="td-causa-cell">
                        <div class="causa-display">${causa}</div>
                    </td>
                    <td class="td-porque-cell">
                        <div class="porque-wrapper">
                            <textarea class="porque-input porque-pregunta" data-tipo="pregunta" data-porque="1" placeholder="¬øPor qu√© ocurri√≥ la Causa Ra√≠z Inicial?">${valores.p1_pregunta || ''}</textarea>
                            <div class="porque-separator">Respuesta</div>
                            <textarea class="porque-input porque-respuesta" data-tipo="respuesta" data-porque="1" placeholder="Escriba la respuesta...">${valores.p1_respuesta || ''}</textarea>
                        </div>
                    </td>
                    <td class="td-porque-cell">
                        <div class="porque-wrapper">
                            <textarea class="porque-input porque-pregunta" data-tipo="pregunta" data-porque="2" placeholder=" ¬øPor qu√© ocurri√≥ la respuesta al 1er Por Qu√©?">${valores.p2_pregunta || ''}</textarea>
                            <div class="porque-separator">Respuesta</div>
                            <textarea class="porque-input porque-respuesta" data-tipo="respuesta" data-porque="2" placeholder="Escriba la respuesta...">${valores.p2_respuesta || ''}</textarea>
                        </div>
                    </td>
                    <td class="td-porque-cell">
                        <div class="porque-wrapper">
                            <textarea class="porque-input porque-pregunta" data-tipo="pregunta" data-porque="3" placeholder="¬øPor qu√© ocurri√≥ la respuesta al 2do Por Qu√©?">${valores.p3_pregunta || ''}</textarea>
                            <div class="porque-separator">Respuesta</div>
                            <textarea class="porque-input porque-respuesta" data-tipo="respuesta" data-porque="3" placeholder="Escriba la respuesta...">${valores.p3_respuesta || ''}</textarea>
                        </div>
                    </td>
                    <td class="td-porque-cell">
                        <div class="porque-wrapper">
                            <textarea class="porque-input porque-pregunta" data-tipo="pregunta" data-porque="4" placeholder="¬øPor qu√© ocurri√≥ la respuesta al 3er Por Qu√©?">${valores.p4_pregunta || ''}</textarea>
                            <div class="porque-separator">Respuesta</div>
                            <textarea class="porque-input porque-respuesta" data-tipo="respuesta" data-porque="4" placeholder="Escriba la respuesta...">${valores.p4_respuesta || ''}</textarea>
                        </div>
                    </td>
                    <td class="td-porque-cell">
                        <div class="porque-wrapper">
                            <textarea class="porque-input porque-pregunta" data-tipo="pregunta" data-porque="5" placeholder="¬øPor qu√© ocurri√≥ la respuesta al 4to Por Qu√©?">${valores.p5_pregunta || ''}</textarea>
                            <div class="porque-separator">Respuesta</div>
                            <textarea class="porque-input porque-respuesta" data-tipo="respuesta" data-porque="5" placeholder="Escriba la respuesta...">${valores.p5_respuesta || ''}</textarea>
                        </div>
                    </td>
                    <td class="td-raiz-cell">
                        <textarea class="raiz-input" placeholder="Causa Ra√≠z Final (La ultima respuesta de los 5 Por que)">${valores.raiz || ''}</textarea>
                    </td>
                </tr>
            `;
        });
    });
    
    tbody.innerHTML = html;
}

// Guardar valores actuales de la tabla
function guardarValoresTabla() {
    const valores = {};
    document.querySelectorAll('#tbody5Porques tr[data-row-key]').forEach(row => {
        const key = row.dataset.rowKey;
        valores[key] = {
            p1_pregunta: row.querySelector('[data-porque="1"][data-tipo="pregunta"]')?.value || '',
            p1_respuesta: row.querySelector('[data-porque="1"][data-tipo="respuesta"]')?.value || '',
            p2_pregunta: row.querySelector('[data-porque="2"][data-tipo="pregunta"]')?.value || '',
            p2_respuesta: row.querySelector('[data-porque="2"][data-tipo="respuesta"]')?.value || '',
            p3_pregunta: row.querySelector('[data-porque="3"][data-tipo="pregunta"]')?.value || '',
            p3_respuesta: row.querySelector('[data-porque="3"][data-tipo="respuesta"]')?.value || '',
            p4_pregunta: row.querySelector('[data-porque="4"][data-tipo="pregunta"]')?.value || '',
            p4_respuesta: row.querySelector('[data-porque="4"][data-tipo="respuesta"]')?.value || '',
            p5_pregunta: row.querySelector('[data-porque="5"][data-tipo="pregunta"]')?.value || '',
            p5_respuesta: row.querySelector('[data-porque="5"][data-tipo="respuesta"]')?.value || '',
            raiz: row.querySelector('.raiz-input')?.value || ''
        };
    });
    return valores;
}

// Recopilar datos de la tabla 5 Por Qu√© - VERSI√ìN REVISADA
function recopilarDatosTabla5Porques() {
    const datos = [];
    document.querySelectorAll('#tbody5Porques tr[data-row-key]').forEach(row => {
        const causaCell = row.querySelector('.causa-display');
        if (!causaCell) return;
        
        // Buscar la categor√≠a
        let categoria = '';
        const catCell = row.querySelector('.td-categoria');
        if (catCell) {
            categoria = catCell.textContent;
        } else {
            // Buscar en filas anteriores
            let prevRow = row.previousElementSibling;
            while (prevRow) {
                const prevCat = prevRow.querySelector('.td-categoria');
                if (prevCat) {
                    categoria = prevCat.textContent;
                    break;
                }
                prevRow = prevRow.previousElementSibling;
            }
        }
        
        const datosPorque = {
            categoria: categoria,
            causa: causaCell.textContent,
            porque1: {
                pregunta: row.querySelector('[data-porque="1"][data-tipo="pregunta"]')?.value || '',
                respuesta: row.querySelector('[data-porque="1"][data-tipo="respuesta"]')?.value || ''
            },
            porque2: {
                pregunta: row.querySelector('[data-porque="2"][data-tipo="pregunta"]')?.value || '',
                respuesta: row.querySelector('[data-porque="2"][data-tipo="respuesta"]')?.value || ''
            },
            porque3: {
                pregunta: row.querySelector('[data-porque="3"][data-tipo="pregunta"]')?.value || '',
                respuesta: row.querySelector('[data-porque="3"][data-tipo="respuesta"]')?.value || ''
            },
            porque4: {
                pregunta: row.querySelector('[data-porque="4"][data-tipo="pregunta"]')?.value || '',
                respuesta: row.querySelector('[data-porque="4"][data-tipo="respuesta"]')?.value || ''
            },
            porque5: {
                pregunta: row.querySelector('[data-porque="5"][data-tipo="pregunta"]')?.value || '',
                respuesta: row.querySelector('[data-porque="5"][data-tipo="respuesta"]')?.value || ''
            },
            causaRaiz: row.querySelector('.raiz-input')?.value || ''
        };
        
        datos.push(datosPorque);
    });
    return datos;
}

// Recopilar causas de una categor√≠a espec√≠fica
function recopilarCausas(categoria) {
    const container = document.getElementById('causas-' + categoria);
    if (!container) return [];
    
    const causas = [];
    container.querySelectorAll('.cause-input-pro').forEach(input => {
        const valor = input.value.trim();
        if (valor) causas.push(valor);
    });
    return causas;
}

// Enviar formulario de Ciclo de Mejora
function submitCicloForm(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('.submit-btn');
    buttonStateManager.bloquear(submitBtn, 'Enviar Ciclo de Mejora');
    
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const fechaLocal = `${year}-${month}-${day} ${hour}:${minute}`;
    
    const espinaPescado = {
        medioAmbiente: recopilarCausas('ambiente'),
        manoDeObra: recopilarCausas('mano'),
        materiales: recopilarCausas('materiales'),
        tiempo: recopilarCausas('tiempo'),
        metodo: recopilarCausas('metodo'),
        maquina: recopilarCausas('maquina')
    };
    
    const seccion5Porques = document.getElementById('seccion5Porques');
    let analisis5Porques = null;
    
    if (seccion5Porques && seccion5Porques.style.display !== 'none') {
        analisis5Porques = recopilarDatosTabla5Porques();
    }
    
    // <CHANGE> Obtener foco de mejora seleccionado
    const focoSeleccionado = document.querySelector('input[name="focoMejora"]:checked');
    const tipoFoco = focoSeleccionado ? focoSeleccionado.value : '';
    
    // <CHANGE> Recopilar datos seg√∫n el foco
    let datosFoco = {};
    if (tipoFoco === 'indicador') {
        datosFoco = {
            tipo: 'indicador',
            nombreKPI: document.getElementById('nombreKPI').value,
            direccion: document.getElementById('direccionIndicador').value,
            resultadoActual: document.getElementById('resultadoActual').value,
            meta: document.getElementById('metaIndicador').value,
            brecha: document.getElementById('brechaIndicador').value,
            ahorroDinero: document.getElementById('ahorroIndicadorDinero').value,
            ahorroPorcentaje: document.getElementById('ahorroIndicadorPorcentaje').value
        };
    } else if (tipoFoco === 'proceso') {
        const metrica = document.getElementById('metricaFlujo').value;
        datosFoco = {
            tipo: 'proceso',
            procesoSimplificar: document.getElementById('procesoSimplificar').value,
            metricaFlujo: metrica === 'otro' ? document.getElementById('metricaOtro').value : metrica,
            valorActual: document.getElementById('valorActualFlujo').value,
            meta: document.getElementById('metaFlujo').value,
            reduccion: document.getElementById('reduccionFlujo').value,
            ahorroTiempo: document.getElementById('ahorroTiempoTotal').value,
            impactoDinero: document.getElementById('impactoProcesoDinero').value
        };
    } else if (tipoFoco === 'error') {
        datosFoco = {
            tipo: 'error',
            declaracionProblema: document.getElementById('declaracionProblema').value,
            evidenciaFallo: document.getElementById('evidenciaFallo').value,
            frecuenciaActual: document.getElementById('frecuenciaActual').value,
            metaFrecuencia: '0',
            brechaRecurrencia: document.getElementById('brechaRecurrencia').value,
            objetivoReduccion: document.getElementById('objetivoReduccionRiesgo').value,
            impactoCosto: document.getElementById('impactoCostoIndirecto').value
        };
    }
    
    const formData = {
        cicloId: document.getElementById('cicloMejoraId').value,
        nombreCiclo: document.getElementById('nombreCicloMejora').value,
        fecha: fechaLocal,
        avisoMantenimiento: document.getElementById('avisoMantenimiento').value,
        proceso: document.getElementById('procesoCiclo').value,
        equipoMaquina: document.getElementById('equipoMaquina').value,
        lider: document.getElementById('liderCicloSearch').value,
        integrantes: document.getElementById('integrantesAnalisis').value,
        // <CHANGE> Agregar foco de mejora
        focoMejora: datosFoco,
        defecto: document.getElementById('defectoPrincipal').value,
        espinaPescado: espinaPescado,
        analisis5Porques: analisis5Porques,
        planAccion: recopilarDatosPlanAccion(),
        creadoPor: currentUser ? currentUser.nombre : ''
    };
    
    showAlert('info', 'Enviando...', 'Procesando su ciclo de mejora, por favor espere', 3000);
    
    google.script.run
        .withSuccessHandler(function(response) {
            buttonStateManager.desbloquear(submitBtn);
            handleCicloSubmitSuccess(response);
        })
        .withFailureHandler(function(error) {
            buttonStateManager.desbloquear(submitBtn);
            handleError(error);
        })
        .submitCicloMejora(formData);
}

function handleCicloSubmitSuccess(result) {
    if (result.success) {
        showAlert('success', 'Registro Exitoso', 'Ciclo de Mejora registrado con ID: ' + result.cicloId);
        document.getElementById('cicloForm').reset();
        
        document.getElementById('liderCicloSearch').value = '';
        limpiarIntegrantesCiclo();
        limpiarFocoMejora();
        limpiarPlanAccion();
        
        document.querySelectorAll('.cause-input-pro').forEach(input => {
            input.value = '';
        });
        
        mostrar5Porques(false);
        initCicloMejoraForm();
    } else {
        showAlert('error', 'Error', result.message || 'Error al enviar el ciclo de mejora');
    }
}

// Extender showReportForm para inicializar el formulario de ciclo
const originalShowReportForm = typeof showReportForm !== 'undefined' ? showReportForm : null;
showReportForm = function(formType, event) {
    if (originalShowReportForm) {
        originalShowReportForm(formType, event);
    }
    
    if (formType === 'ciclo') {
        setTimeout(() => {
            initCicloMejoraForm();
        }, 100);
    }
};

// ========== FUNCIONES BUSQUEDA CICLO DE MEJORA ==========

// Array para almacenar integrantes seleccionados
let integrantesSeleccionadosArray = [];

// ===== BUSQUEDA LIDER CICLO =====
function searchLiderCiclo(query) {
    const resultsContainer = document.getElementById('liderCicloResults');
    
    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const searchTerm = query.toLowerCase();
    const filteredLeaders = leadersData.filter(leader => {
        const texto = leader.info ? leader.info.toLowerCase() : "";
        return texto.includes(searchTerm);
    });

    displayLiderCicloResults(filteredLeaders);
}

function displayLiderCicloResults(leaders) {
    const resultsContainer = document.getElementById('liderCicloResults');
    
    if (leaders.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        resultsContainer.innerHTML = leaders.map(leader => `
            <div class="search-result-item" onclick="selectLiderCiclo('${escapeHtml(leader.info)}', '${leader.cedula || ''}')">
                <div class="search-result-name">${leader.info}</div>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

function selectLiderCiclo(info, cedula) {
    document.getElementById('liderCicloSearch').value = info;
    document.getElementById('liderCiclo').value = info;
    document.getElementById('liderCicloResults').style.display = 'none';
}

function showLiderCicloResults() {
    const query = document.getElementById('liderCicloSearch').value;
    if (query && query.length >= 2) {
        searchLiderCiclo(query);
    }
}

// ===== BUSQUEDA INTEGRANTES (MULTIPLE) =====
function searchIntegrantes(query) {
    const resultsContainer = document.getElementById('integrantesResults');
    
    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const searchTerm = query.toLowerCase();
    const filteredLeaders = leadersData.filter(leader => {
        const texto = leader.info ? leader.info.toLowerCase() : "";
        return texto.includes(searchTerm);
    });

    displayIntegrantesResults(filteredLeaders);
}

function displayIntegrantesResults(leaders) {
    const resultsContainer = document.getElementById('integrantesResults');
    
    if (leaders.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        resultsContainer.innerHTML = leaders.map(leader => {
            const yaSeleccionado = integrantesSeleccionadosArray.some(i => i.info === leader.info);
            const selectedClass = yaSeleccionado ? 'already-selected' : '';
            return `
                <div class="search-result-item ${selectedClass}" onclick="agregarIntegrante('${escapeHtml(leader.info)}', '${leader.cedula || ''}')">
                    <div class="search-result-name">${leader.info}</div>
                </div>
            `;
        }).join('');
    }
    
    resultsContainer.style.display = 'block';
}

function agregarIntegrante(info, cedula) {
    // Verificar si ya esta seleccionado
    if (integrantesSeleccionadosArray.some(i => i.info === info)) {
        return;
    }
    
    // Agregar al array
    integrantesSeleccionadosArray.push({ info: info, cedula: cedula });
    
    // Actualizar UI
    renderIntegrantesSeleccionados();
    actualizarInputIntegrantes();
    
    // Limpiar busqueda
    document.getElementById('integrantesSearch').value = '';
    document.getElementById('integrantesResults').style.display = 'none';
}

function eliminarIntegrante(index) {
    integrantesSeleccionadosArray.splice(index, 1);
    renderIntegrantesSeleccionados();
    actualizarInputIntegrantes();
}

function renderIntegrantesSeleccionados() {
    const container = document.getElementById('integrantesSeleccionados');
    
    if (integrantesSeleccionadosArray.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = integrantesSeleccionadosArray.map((integrante, index) => `
        <div class="selected-tag">
            <span class="tag-name">${integrante.info}</span>
            <button type="button" class="tag-remove" onclick="eliminarIntegrante(${index})" title="Eliminar">√ó</button>
        </div>
    `).join('');
}

function actualizarInputIntegrantes() {
    const input = document.getElementById('integrantesAnalisis');
    input.value = integrantesSeleccionadosArray.map(i => i.info).join(', ');
}

function showIntegrantesResults() {
    const query = document.getElementById('integrantesSearch').value;
    if (query && query.length >= 2) {
        searchIntegrantes(query);
    }
}

// Funcion auxiliar para escapar HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/'/g, "\\'");
}

// Cerrar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
    // Cerrar resultados de lider ciclo
    const liderContainer = document.querySelector('#liderCicloSearch')?.closest('.search-container');
    if (liderContainer && !liderContainer.contains(e.target)) {
        document.getElementById('liderCicloResults').style.display = 'none';
    }
    
    // Cerrar resultados de integrantes
    const integrantesContainer = document.querySelector('#integrantesSearch')?.closest('.search-container');
    if (integrantesContainer && !integrantesContainer.contains(e.target)) {
        document.getElementById('integrantesResults').style.display = 'none';
    }
});

// Limpiar integrantes al reiniciar formulario
function limpiarIntegrantesCiclo() {
    integrantesSeleccionadosArray = [];
    renderIntegrantesSeleccionados();
    actualizarInputIntegrantes();
    
    const liderSearch = document.getElementById('liderCicloSearch');
    if (liderSearch) liderSearch.value = '';
    
    const liderHidden = document.getElementById('liderCiclo');
    if (liderHidden) liderHidden.value = '';
}

function showChangeTarjetaResponsibleModal(rowIndex, currentResponsible) {
  const existingModal = document.getElementById('tarjetaResponsibleModal');
  if (existingModal) existingModal.remove();

  // Obtener las opciones del select del formulario de tarjetas
  const responsableSelect = document.getElementById('responsableSolucion');
  const responsables = [];
  
  if (responsableSelect) {
    // Recorrer todas las opciones del select
    Array.from(responsableSelect.options).forEach(option => {
      if (option.value && option.value.trim() !== '') {
        responsables.push({
          value: option.value,
          text: option.text
        });
      }
    });
  }

  const overlay = document.createElement('div');
  overlay.id = 'tarjetaResponsibleModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  const modal = document.createElement('div');
  modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

  modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600;">
      <i class="fa-regular fa-user"></i> Reasignar Responsable - Tarjeta
    </h2>

    <div style="margin-bottom: 0.5rem;">
      <label style="font-weight:500; color:#475569; font-size:14px;">Responsable actual:</label>
      <div style="padding:0.5rem; background:#f8fafc; border-radius:6px; margin-top:4px;">
        ${currentResponsible || 'No asignado'}
      </div>
    </div>

    <div style="margin-bottom: 0.5rem;">
      <label style="font-weight:500; color:#475569; font-size:14px; display:block; margin-bottom:8px;">
        Nuevo responsable:
      </label>
      <select id="newTarjetaResponsable" 
        style="width:100%; padding:0.6rem 0.8rem; border:1px solid #cbd5e1; border-radius:8px; font-size:14px; background:white;">
        <option value="">Seleccione un responsable</option>
        ${responsables.map(r => 
          `<option value="${escapeHtml(r.value)}">${escapeHtml(r.text)}</option>`
        ).join('')}
      </select>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
      <button id="cancelTarjetaReassign" 
        style="padding:0.5rem 1rem; border:1px solid #cbd5e1; border-radius:8px; cursor:pointer;">
        Cancelar
      </button>
      <button id="saveTarjetaReassign" 
        style="padding:0.5rem 1rem; border:none; background:#3b82f6; color:#fff; border-radius:8px; cursor:pointer;">
        Guardar
      </button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const selectElement = modal.querySelector('#newTarjetaResponsable');

  modal.querySelector('#cancelTarjetaReassign').addEventListener('click', () => overlay.remove());

  modal.querySelector('#saveTarjetaReassign').addEventListener('click', () => {
    const nuevoResponsable = selectElement.value.trim();
    
    if (!nuevoResponsable) {
      showAlert('warning', 'Campo vac√≠o', 'Debes seleccionar un responsable');
      return;
    }

    if (nuevoResponsable === currentResponsible) {
      showAlert('warning', 'Sin cambios', 'El nuevo responsable es el mismo que el actual');
      return;
    }

    overlay.remove();
    showAlert('info', 'Actualizando...', 'Reasignando responsable de la tarjeta...', 2000);

    google.script.run
      .withSuccessHandler(() => {
        showAlert('success', '√âxito', 'Responsable actualizado correctamente');
        // Recargar las tarjetas manteniendo los filtros
        if (window.tarjetasBase && window.tarjetasBase.length > 0) {
          applyTarjetaFilters(); // Vuelve a aplicar filtros
        } else {
          loadTarjetasReports(); // Recarga todo
        }
      })
      .withFailureHandler(err => {
        console.error(err);
        showAlert('error', 'Error', 'No se pudo actualizar el responsable');
      })
      .updateTarjetaResponsible(rowIndex, nuevoResponsable);
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

function reloadTarjetasKeepFilters() {
  const currentFilters = {
    responsable: document.getElementById('filtroResponsable')?.value || "",
    tipo: document.getElementById('filtroTipo')?.value || "",
    zona: document.getElementById('filtroZona')?.value || "",
    riesgo: document.getElementById('filtroRiesgo')?.value || "",
    searchCreator: document.getElementById('searchCreator')?.value || ""
  };
  
  showTarjetasLoadingSpinner();
  
  google.script.run
    .withSuccessHandler((reports) => {
      window.tarjetasBase = reports;
      tarjetasReports = reports;
      
      // Restaurar filtros
      if (currentFilters.responsable) document.getElementById('filtroResponsable').value = currentFilters.responsable;
      if (currentFilters.tipo) document.getElementById('filtroTipo').value = currentFilters.tipo;
      if (currentFilters.zona) document.getElementById('filtroZona').value = currentFilters.zona;
      if (currentFilters.riesgo) document.getElementById('filtroRiesgo').value = currentFilters.riesgo;
      if (currentFilters.searchCreator) document.getElementById('searchCreator').value = currentFilters.searchCreator;
      
      // Aplicar filtros nuevamente
      applyTarjetaFilters();
      loadTarjetasCommentsCount();
    })
    .withFailureHandler((err) => {
      console.error('Error al recargar tarjetas:', err);
      handleTarjetasError(err);
    })
    .getTarjetasReports();
}

// ========== FUNCIONES FOCO DE MEJORA ==========

// Mostrar/ocultar secci√≥n seg√∫n foco seleccionado
function mostrarFocoMejora(tipo) {
    // Ocultar todos los contenidos
    document.getElementById('focoIndicador').style.display = 'none';
    document.getElementById('focoProceso').style.display = 'none';
    document.getElementById('focoError').style.display = 'none';
    
    // Mostrar el seleccionado
    if (tipo === 'indicador') {
        document.getElementById('focoIndicador').style.display = 'block';
    } else if (tipo === 'proceso') {
        document.getElementById('focoProceso').style.display = 'block';
    } else if (tipo === 'error') {
        document.getElementById('focoError').style.display = 'block';
    }
}

// Calcular brecha de indicador
function calcularBrechaIndicador() {
    const resultadoActual = parseFloat(document.getElementById('resultadoActual').value) || 0;
    const meta = parseFloat(document.getElementById('metaIndicador').value) || 0;
    const direccion = document.getElementById('direccionIndicador').value;
    
    let brecha = 0;
    let texto = '';
    
    if (resultadoActual && meta) {
        if (direccion === 'sube') {
            brecha = meta - resultadoActual;
            texto = brecha >= 0 
                ? `Aumentar ${brecha.toFixed(2)} unidades (de ${resultadoActual} a ${meta})`
                : `Ya superamos la meta por ${Math.abs(brecha).toFixed(2)} unidades`;
        } else if (direccion === 'baja') {
            brecha = resultadoActual - meta;
            texto = brecha >= 0 
                ? `Reducir ${brecha.toFixed(2)} unidades (de ${resultadoActual} a ${meta})`
                : `Ya estamos por debajo de la meta por ${Math.abs(brecha).toFixed(2)} unidades`;
        } else {
            brecha = Math.abs(meta - resultadoActual);
            texto = `Brecha: ${brecha.toFixed(2)} unidades`;
        }
    }
    
    document.getElementById('brechaIndicador').value = texto;
}

// Calcular reducci√≥n de flujo
function calcularReduccionFlujo() {
    const valorActual = parseFloat(document.getElementById('valorActualFlujo').value) || 0;
    const meta = parseFloat(document.getElementById('metaFlujo').value) || 0;
    
    if (valorActual && meta) {
        const reduccion = valorActual - meta;
        const porcentaje = ((reduccion / valorActual) * 100).toFixed(1);
        
        if (reduccion > 0) {
            document.getElementById('reduccionFlujo').value = `Reducir ${reduccion.toFixed(2)} unidades (${porcentaje}% de mejora)`;
        } else if (reduccion < 0) {
            document.getElementById('reduccionFlujo').value = `El valor actual ya es menor que la meta`;
        } else {
            document.getElementById('reduccionFlujo').value = `Sin cambio`;
        }
    } else {
        document.getElementById('reduccionFlujo').value = '';
    }
}

// Calcular brecha de recurrencia
function calcularBrechaRecurrencia() {
    const frecuenciaActual = parseInt(document.getElementById('frecuenciaActual').value) || 0;
    
    if (frecuenciaActual > 0) {
        document.getElementById('brechaRecurrencia').value = `${frecuenciaActual} ocurrencias a eliminar (llevar a cero)`;
    } else {
        document.getElementById('brechaRecurrencia').value = '';
    }
}

// Toggle para campo "Otro" en m√©trica de flujo
function toggleMetricaOtro() {
    const select = document.getElementById('metricaFlujo');
    const container = document.getElementById('metricaOtroContainer');
    
    if (select.value === 'otro') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        document.getElementById('metricaOtro').value = '';
    }
}

// Limpiar campos de foco de mejora al reiniciar
function limpiarFocoMejora() {
    // Desmarcar radios
    document.querySelectorAll('input[name="focoMejora"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Ocultar contenidos
    document.getElementById('focoIndicador').style.display = 'none';
    document.getElementById('focoProceso').style.display = 'none';
    document.getElementById('focoError').style.display = 'none';
    
    // Limpiar campos de indicador
    document.getElementById('nombreKPI').value = '';
    document.getElementById('direccionIndicador').value = '';
    document.getElementById('resultadoActual').value = '';
    document.getElementById('metaIndicador').value = '';
    document.getElementById('brechaIndicador').value = '';
    document.getElementById('ahorroIndicadorDinero').value = '';
    document.getElementById('ahorroIndicadorPorcentaje').value = '';
    
    // Limpiar campos de proceso
    document.getElementById('procesoSimplificar').value = '';
    document.getElementById('metricaFlujo').value = '';
    document.getElementById('metricaOtro').value = '';
    document.getElementById('metricaOtroContainer').style.display = 'none';
    document.getElementById('valorActualFlujo').value = '';
    document.getElementById('metaFlujo').value = '';
    document.getElementById('reduccionFlujo').value = '';
    document.getElementById('ahorroTiempoTotal').value = '';
    document.getElementById('impactoProcesoDinero').value = '';
    
    // Limpiar campos de error
    document.getElementById('declaracionProblema').value = '';
    document.getElementById('evidenciaFallo').value = '';
    document.getElementById('frecuenciaActual').value = '';
    document.getElementById('brechaRecurrencia').value = '';
    document.getElementById('objetivoReduccionRiesgo').value = '';
    document.getElementById('impactoCostoIndirecto').value = '';
}

// ========== FUNCIONES PLAN DE ACCI√ìN 5W+2H ==========

let contadorFilasAccion = 0;

// Obtener causas ra√≠z autom√°ticamente (prioridad: 5 Por Qu√© > Espina de Pescado)
function obtenerCausasRaizAutomaticas() {
    const causas = [];
    
    // Primero intentar obtener causas ra√≠z del an√°lisis 5 Por Qu√©
    const seccion5Porques = document.getElementById('seccion5Porques');
    const esta5PorquesVisible = seccion5Porques && seccion5Porques.style.display !== 'none';
    
    if (esta5PorquesVisible) {
        document.querySelectorAll('#tbody5Porques tr[data-row-key]').forEach(row => {
            const raizInput = row.querySelector('.raiz-input');
            if (raizInput && raizInput.value.trim()) {
                causas.push({
                    fuente: '5 Por Qu√©',
                    texto: raizInput.value.trim()
                });
            }
        });
    }
    
    // Si hay causas del 5 Por Qu√©, usarlas
    if (causas.length > 0) {
        return causas;
    }
    
    // Si no hay causas del 5 Por Qu√©, obtener de la espina de pescado
    const categorias = ['ambiente', 'mano', 'materiales', 'tiempo', 'metodo', 'maquina'];
    const categoriaLabelsAccion = {
        'ambiente': 'Medio Ambiente',
        'mano': 'Mano de Obra',
        'materiales': 'Materiales',
        'tiempo': 'Tiempo',
        'metodo': 'M√©todo',
        'maquina': 'M√°quina'
    };
    
    categorias.forEach(cat => {
        const container = document.getElementById('causas-' + cat);
        if (container) {
            container.querySelectorAll('.cause-input-pro').forEach(input => {
                const valor = input.value.trim();
                if (valor) {
                    causas.push({
                        fuente: 'Espina - ' + categoriaLabelsAccion[cat],
                        texto: valor
                    });
                }
            });
        }
    });
    
    return causas;
}

// Obtener la siguiente causa ra√≠z disponible
function obtenerSiguienteCausaRaiz() {
    const causas = obtenerCausasRaizAutomaticas();
    const filasExistentes = document.querySelectorAll('#tbodyPlanAccion tr[data-fila-accion]').length;
    
    // Si hay m√°s causas que filas, devolver la siguiente
    if (filasExistentes < causas.length) {
        return causas[filasExistentes];
    }
    
    // Si ya se usaron todas las causas, devolver null
    return null;
}

// Agregar nueva fila de acci√≥n con causa ra√≠z autom√°tica
function agregarFilaAccion() {
    contadorFilasAccion++;
    const tbody = document.getElementById('tbodyPlanAccion');
    const emptyMsg = document.getElementById('planAccionEmpty');
    
    if (emptyMsg) {
        emptyMsg.style.display = 'none';
    }
    
    // Obtener causa ra√≠z autom√°tica
    const causaRaiz = obtenerSiguienteCausaRaiz();
    const textoCausa = causaRaiz ? causaRaiz.texto : '';
    const fuenteCausa = causaRaiz ? causaRaiz.fuente : '';
    
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-fila-accion', contadorFilasAccion);
    newRow.innerHTML = `
        <td>
            <div class="causa-raiz-cell" data-field="cual" data-fuente="${fuenteCausa}">
                ${textoCausa || '<em style="color:#9ca3af;">Sin causa asignada</em>'}
            </div>
            <input type="hidden" class="causa-raiz-hidden" value="${textoCausa}">
        </td>
        <td>
            <textarea class="accion-textarea" data-field="que" placeholder="Describa la soluci√≥n espec√≠fica..."></textarea>
        </td>
        <td>
            <textarea class="accion-textarea" data-field="donde" placeholder="Proceso, l√≠nea, √°rea..."></textarea>
        </td>
        <td>
            <div class="accion-search-container">
                <input type="text" 
                    class="accion-search-input" 
                    data-field="quien"
                    placeholder="Buscar responsable..."
                    autocomplete="off"
                    oninput="searchResponsableAccion(this, ${contadorFilasAccion})"
                    onfocus="showResponsableResults(${contadorFilasAccion})">
                <div class="accion-search-results" id="resultsAccion${contadorFilasAccion}"></div>
            </div>
        </td>
        <td>
            <textarea class="accion-textarea" data-field="como" placeholder="Detalle del procedimiento..."></textarea>
        </td>
        <td>
            <input type="date" class="accion-date" data-field="cuando">
        </td>
        <td>
            <input type="text" class="accion-input" data-field="cuanto" placeholder="$ o recursos">
        </td>
        <td>
            <button type="button" class="btn-eliminar-accion" onclick="eliminarFilaAccion(this)" title="Eliminar acci√≥n">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    
    // Mostrar alerta si no hay m√°s causas disponibles
    if (!causaRaiz) {
        const causasDisponibles = obtenerCausasRaizAutomaticas();
        if (causasDisponibles.length === 0) {
            showAlert('warning', 'Sin Causas', 'No hay causas registradas. Complete la Espina de Pescado o el an√°lisis 5 Por Qu√© primero.', 4000);
        }
    }
}

// Eliminar fila de acci√≥n
function eliminarFilaAccion(btn) {
    const row = btn.closest('tr');
    row.style.animation = 'fadeOut 0.2s ease';
    
    setTimeout(() => {
        row.remove();
        verificarFilasAccionVacias();
        // Reasignar causas ra√≠z a las filas restantes
        reasignarCausasRaiz();
    }, 200);
}

// Reasignar causas ra√≠z despu√©s de eliminar una fila
function reasignarCausasRaiz() {
    const causas = obtenerCausasRaizAutomaticas();
    const filas = document.querySelectorAll('#tbodyPlanAccion tr[data-fila-accion]');
    
    filas.forEach((fila, index) => {
        const celdaCausa = fila.querySelector('.causa-raiz-cell');
        const inputOculto = fila.querySelector('.causa-raiz-hidden');
        
        if (index < causas.length) {
            const causa = causas[index];
            celdaCausa.innerHTML = causa.texto;
            celdaCausa.setAttribute('data-fuente', causa.fuente);
            inputOculto.value = causa.texto;
        } else {
            celdaCausa.innerHTML = '<em style="color:#9ca3af;">Sin causa asignada</em>';
            celdaCausa.setAttribute('data-fuente', '');
            inputOculto.value = '';
        }
    });
}

// Verificar si no hay filas
function verificarFilasAccionVacias() {
    const tbody = document.getElementById('tbodyPlanAccion');
    const emptyMsg = document.getElementById('planAccionEmpty');
    
    if (tbody && tbody.children.length === 0 && emptyMsg) {
        emptyMsg.style.display = 'block';
    }
}

// B√∫squeda de responsable en la tabla
function searchResponsableAccion(input, filaId) {
    const query = input.value;
    const resultsContainer = document.getElementById('resultsAccion' + filaId);
    
    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    const searchTerm = query.toLowerCase();
    const filteredLeaders = leadersData.filter(leader => {
        const texto = leader.info ? leader.info.toLowerCase() : "";
        return texto.includes(searchTerm);
    });
    
    if (filteredLeaders.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
    } else {
        resultsContainer.innerHTML = filteredLeaders.map(leader => `
            <div class="search-result-item" onclick="selectResponsableAccion('${leader.info}', ${filaId})">
                ${leader.info}
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

// Mostrar resultados de b√∫squeda
function showResponsableResults(filaId) {
    const input = document.querySelector(`tr[data-fila-accion="${filaId}"] .accion-search-input`);
    if (input && input.value.length >= 2) {
        searchResponsableAccion(input, filaId);
    }
}

// Seleccionar responsable
function selectResponsableAccion(info, filaId) {
    const input = document.querySelector(`tr[data-fila-accion="${filaId}"] .accion-search-input`);
    const resultsContainer = document.getElementById('resultsAccion' + filaId);
    
    if (input) {
        input.value = info;
    }
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
}

// Cerrar resultados al hacer clic fuera
document.addEventListener('click', function(event) {
    if (!event.target.closest('.accion-search-container')) {
        document.querySelectorAll('.accion-search-results').forEach(container => {
            container.style.display = 'none';
        });
    }
});

// Recopilar datos del plan de acci√≥n
function recopilarDatosPlanAccion() {
    const acciones = [];
    
    document.querySelectorAll('#tbodyPlanAccion tr[data-fila-accion]').forEach(row => {
        const accion = {
            cual: row.querySelector('.causa-raiz-hidden')?.value || '',
            que: row.querySelector('[data-field="que"]')?.value || '',
            donde: row.querySelector('[data-field="donde"]')?.value || '',
            quien: row.querySelector('[data-field="quien"]')?.value || '',
            como: row.querySelector('[data-field="como"]')?.value || '',
            cuando: row.querySelector('[data-field="cuando"]')?.value || '',
            cuanto: row.querySelector('[data-field="cuanto"]')?.value || ''
        };
        
        // Solo agregar si tiene al menos un campo lleno
        if (Object.values(accion).some(v => v && v.trim())) {
            acciones.push(accion);
        }
    });
    
    return acciones;
}

// Limpiar plan de acci√≥n
function limpiarPlanAccion() {
    const tbody = document.getElementById('tbodyPlanAccion');
    const emptyMsg = document.getElementById('planAccionEmpty');
    
    if (tbody) {
        tbody.innerHTML = '';
    }
    if (emptyMsg) {
        emptyMsg.style.display = 'block';
    }
    
    contadorFilasAccion = 0;
}

// ========== GESTI√ìN DE CICLOS DE MEJORA ==========

let ciclosData = [];
let cicloActual = null;

function loadCiclosMejora() {
    console.log('[Frontend] Iniciando carga de ciclos...');
    
    const tbody = document.getElementById('tbodyCiclos');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="ciclos-loading-cell">
                    <div class="ciclos-loading-spinner">
                        <svg class="spinner-icon" width="20" height="20" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
                            <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                        </svg>
                        <span>Cargando ciclos de mejora...</span>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // Primero hacer un test
    console.log('[Frontend] Haciendo test de conexi√≥n...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('[Frontend] TEST exitoso:', result);
            
            // Ahora cargar los ciclos reales
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('[Frontend] Ciclos recibidos:', data);
                    
                    // Manejar null/undefined
                    if (data === null || data === undefined) {
                        console.warn('[Frontend] Data es null/undefined, usando vac√≠o');
                        data = [];
                    }
                    
                    if (!Array.isArray(data)) {
                        console.warn('[Frontend] Data no es array, convirtiendo');
                        data = [data]; // o data = []
                    }
                    
                    console.log(`[Frontend] ${data.length} ciclos cargados`);
                    
                    // Procesar fechas ISO string a objetos Date
                    data.forEach(ciclo => {
                        if (ciclo.fecha && typeof ciclo.fecha === 'string') {
                            try {
                                ciclo.fecha = new Date(ciclo.fecha);
                            } catch (e) {
                                console.warn('Error convirtiendo fecha:', e);
                            }
                        }
                    });
                    
                    ciclosData = data;
                    renderCiclosTable(ciclosData);
                    actualizarEstadisticasCiclos(ciclosData);
                })
                .withFailureHandler(function(error) {
                    console.error('[Frontend] Error cargando ciclos:', error);
                    
                    // Mostrar mensaje de error pero con array vac√≠o
                    ciclosData = [];
                    renderCiclosTable(ciclosData);
                    actualizarEstadisticasCiclos(ciclosData);
                    
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="ciclos-loading-cell">
                                    <div style="color: #dc2626;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 8px;">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/>
                                        </svg>
                                        <br>Error al cargar los ciclos
                                        <br><small>${error.message || 'Error de conexi√≥n'}</small>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                })
                .getCiclosMejora();
        })
        .withFailureHandler(function(error) {
            console.error('[Frontend] TEST fallido:', error);
            // Mostrar error de conexi√≥n
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="ciclos-loading-cell">
                            <div style="color: #dc2626;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 8px;">
                                    <circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/>
                                </svg>
                                <br>Error de conexi√≥n con el servidor
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .getCiclosMejora();
}

// Renderizar tabla de ciclos
function renderCiclosTable(ciclos) {
    const tbody = document.getElementById('tbodyCiclos');
    if (!tbody) return;
    
    if (!ciclos || ciclos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="ciclos-loading-cell">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5" style="margin-bottom: 8px;">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <br>No hay ciclos de mejora registrados
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = ciclos.map(ciclo => {
        const estadoClass = getEstadoClass(ciclo.estado);
        const focoInfo = getFocoInfo(ciclo.tipoFoco);
        
        return `
            <tr onclick="verDetalleCiclo('${ciclo.id}')" style="cursor: pointer;">
                <td><span class="ciclo-id-badge">${ciclo.id || '-'}</span></td>
                <td>${formatearFechaCiclo(ciclo.fecha)}</td>
                <td class="ciclo-nombre-cell">${ciclo.nombre || '-'}</td>
                <td>${ciclo.proceso || '-'}</td>
                <td>${ciclo.equipo || '-'}</td>
                <td>${ciclo.lider || '-'}</td>
                <td>${focoInfo.html}</td>
                <td><span class="estado-badge ${estadoClass}">${ciclo.estado || 'Abierto'}</span></td>
                <td>
                    <button class="btn-ver-detalle" onclick="event.stopPropagation(); verDetalleCiclo('${ciclo.id}')">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Obtener clase de estado
function getEstadoClass(estado) {
    if (!estado) return 'abierto';
    const estadoLower = estado.toLowerCase();
    if (estadoLower === 'en progreso') return 'en-progreso';
    if (estadoLower === 'implementado') return 'implementado';
    if (estadoLower === 'cerrado') return 'cerrado';
    return 'abierto';
}

// Obtener info del foco
function getFocoInfo(tipoFoco) {
    const focos = {
        'indicador': { label: 'Indicador', class: 'indicador' },
        'proceso': { label: 'Proceso', class: 'proceso' },
        'error': { label: 'Error', class: 'error' }
    };
    
    const foco = focos[tipoFoco] || null;
    if (!foco) return { html: '<span style="color: #9ca3af;">-</span>' };
    
    return {
        html: `<span class="foco-badge ${foco.class}">${foco.label}</span>`
    };
}

// Formatear fecha
function formatearFechaCiclo(fecha) {
    if (!fecha) return '-';
    try {
        // Acepta tanto Date como string ISO
        const d = fecha instanceof Date ? fecha : new Date(fecha);
        
        if (isNaN(d.getTime())) {
            // Si no es fecha v√°lida, intentar extraer del string
            if (typeof fecha === 'string') {
                return fecha.split('T')[0]; // Solo la parte de fecha
            }
            return fecha;
        }
        
        return d.toLocaleDateString('es-CO', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    } catch (e) {
        console.warn('Error formateando fecha:', fecha, e);
        return typeof fecha === 'string' ? fecha.substring(0, 10) : '-';
    }
}

// Actualizar estad√≠sticas
function actualizarEstadisticasCiclos(ciclos) {
    const stats = { abierto: 0, progreso: 0, implementado: 0, cerrado: 0 };
    
    (ciclos || []).forEach(ciclo => {
        const estado = (ciclo.estado || 'Abierto').toLowerCase();
        if (estado === 'abierto') stats.abierto++;
        else if (estado === 'en progreso') stats.progreso++;
        else if (estado === 'implementado') stats.implementado++;
        else if (estado === 'cerrado') stats.cerrado++;
    });
    
    const elAbierto = document.getElementById('ciclos-stat-abierto');
    const elProgreso = document.getElementById('ciclos-stat-progreso');
    const elImplementado = document.getElementById('ciclos-stat-implementado');
    const elCerrado = document.getElementById('ciclos-stat-cerrado');
    
    if (elAbierto) elAbierto.textContent = stats.abierto;
    if (elProgreso) elProgreso.textContent = stats.progreso;
    if (elImplementado) elImplementado.textContent = stats.implementado;
    if (elCerrado) elCerrado.textContent = stats.cerrado;
}

// Filtrar ciclos
function applyCiclosFilters() {
    const procesoFilter = document.getElementById('ciclosProcesoFilter')?.value || 'all';
    const estadoFilter = document.getElementById('ciclosEstadoFilter')?.value || 'all';
    const searchValue = (document.getElementById('ciclosSearchInput')?.value || '').toLowerCase();
    
    const filtered = ciclosData.filter(ciclo => {
        const matchProceso = procesoFilter === 'all' || ciclo.proceso === procesoFilter;
        const matchEstado = estadoFilter === 'all' || ciclo.estado === estadoFilter;
        const matchSearch = !searchValue || 
            (ciclo.id && ciclo.id.toLowerCase().includes(searchValue)) ||
            (ciclo.nombre && ciclo.nombre.toLowerCase().includes(searchValue)) ||
            (ciclo.lider && ciclo.lider.toLowerCase().includes(searchValue));
        
        return matchProceso && matchEstado && matchSearch;
    });
    
    renderCiclosTable(filtered);
}

// Ver detalle de ciclo
function verDetalleCiclo(cicloId) {
    const ciclo = ciclosData.find(c => c.id === cicloId);
    if (!ciclo) {
        showAlert('error', 'Error', 'No se encontr√≥ el ciclo de mejora');
        return;
    }
    
    cicloActual = ciclo;
    
    // Llenar header del modal
    document.getElementById('modalCicloId').textContent = ciclo.id || '-';
    document.getElementById('modalCicloTitulo').textContent = ciclo.nombre || 'Sin nombre';
    
    // <CHANGE> Corregido para usar las clases correctas del HTML
    const estadoClass = getEstadoClass(ciclo.estado);
    const estadoEl = document.getElementById('modalCicloEstado');
    estadoEl.textContent = ciclo.estado || 'Abierto';
    estadoEl.className = 'modal-ciclo-estado-badge estado-badge ' + estadoClass;
    
    // Info general
    document.getElementById('modalCicloFecha').textContent = formatearFechaCiclo(ciclo.fecha);
    document.getElementById('modalCicloProceso').textContent = ciclo.proceso || '-';
    document.getElementById('modalCicloEquipo').textContent = ciclo.equipo || '-';
    document.getElementById('modalCicloAviso').textContent = ciclo.aviso || 'N/A';
    document.getElementById('modalCicloLider').textContent = ciclo.lider || '-';
    document.getElementById('modalCicloIntegrantes').textContent = ciclo.integrantes || '-';
    
    // Foco de mejora
    renderFocoDetalle(ciclo);
    
    // Defecto
    document.getElementById('modalCicloDefecto').textContent = ciclo.defecto || 'No especificado';
    
    // Espina de pescado
    renderEspinaResumen(ciclo);
    
    // 5 Por Qu√©
    renderPorquesResumen(ciclo);
    
    // Plan de acci√≥n
    renderPlanAccionResumen(ciclo);
    
    // Cargar historial
    cargarHistorialCiclo(cicloId);
    
    // Estado actual en select
    const selectEstado = document.getElementById('nuevoEstadoCiclo');
    if (selectEstado) {
        selectEstado.value = ciclo.estado || 'Abierto';
    }
    
    // Limpiar comentario
    const comentarioEl = document.getElementById('comentarioCiclo');
    if (comentarioEl) comentarioEl.value = '';
    
    // Activar primera tab
    cambiarTabCiclo('info');
    
    // <CHANGE> Mostrar modal con la clase correcta
    const modal = document.getElementById('modalDetalleCiclo');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

// Cerrar modal
function cerrarModalCiclo() {
    const modal = document.getElementById('modalDetalleCiclo');
    if (modal) {
        modal.classList.remove('active');
    }
    document.body.style.overflow = '';
    cicloActual = null;
}

// <CHANGE> Corregido para usar las clases correctas del HTML
function cambiarTabCiclo(tabId) {
    // Desactivar todas las tabs
    document.querySelectorAll('.modal-ciclo-tabs-container .modal-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.modal-ciclo-content .modal-tab-content').forEach(tab => tab.classList.remove('active'));
    
    // Activar la tab seleccionada
    document.querySelector(`.modal-ciclo-tabs-container .modal-tab-btn[onclick="cambiarTabCiclo('${tabId}')"]`)?.classList.add('active');
    document.getElementById('tab-' + tabId)?.classList.add('active');
}

// Renderizar detalle del foco - VERSI√ìN CORREGIDA
function renderFocoDetalle(ciclo) {
    const container = document.getElementById('modalCicloFocoDetalle');
    if (!container) return;
    
    let datosFoco = {};
    try {
        datosFoco = ciclo.datosFoco ? JSON.parse(ciclo.datosFoco) : {};
    } catch (e) {
        datosFoco = {};
    }
    
    const tipoFoco = ciclo.tipoFoco || '';
    let html = '';
    
    if (tipoFoco === 'indicador') {
        html = `
            <div class="foco-tipo-header indicador">Mejorar un Resultado (Indicador)</div>
            <div class="foco-detalle-grid">
                <div class="foco-detalle-item"><strong>Indicador</strong><span>${datosFoco.nombreKPI || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Resultado Actual</strong><span>${datosFoco.resultadoActual || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Meta</strong><span>${datosFoco.meta || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Brecha</strong><span>${datosFoco.brecha || '-'}</span></div>
            </div>
        `;
    } else if (tipoFoco === 'proceso') {
        html = `
            <div class="foco-tipo-header proceso">Hacer el Proceso m√°s R√°pido y F√°cil</div>
            <div class="foco-detalle-grid">
                <div class="foco-detalle-item"><strong>Proceso a Mejorar</strong><span>${datosFoco.procesoSimplificar || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Valor Actual</strong><span>${datosFoco.valorActualFlujo || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Meta</strong><span>${datosFoco.meta || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Reducci√≥n</strong><span>${datosFoco.reduccion || '-'}</span></div>
            </div>
        `;
    } else if (tipoFoco === 'error') {
        html = `
            <div class="foco-tipo-header error">Evitar que un Error Vuelva a Pasar</div>
            <div class="foco-detalle-grid">
                <div class="foco-detalle-item"><strong>Declaraci√≥n del Problema</strong><span>${datosFoco.declaracionProblema || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Frecuencia Actual</strong><span>${datosFoco.frecuenciaActual || '-'}</span></div>
                <div class="foco-detalle-item"><strong>Meta</strong><span>0 (Eliminar)</span></div>
                <div class="foco-detalle-item"><strong>Brecha de Recurrencia</strong><span>${datosFoco.brechaRecurrencia || '-'}</span></div>
            </div>
        `;
    } else {
        html = '<p style="color: #9ca3af; font-style: italic;">No se especific√≥ el foco de mejora</p>';
    }
    
    container.innerHTML = html;
}

// Renderizar resumen de espina
function renderEspinaResumen(ciclo) {
    const container = document.getElementById('modalCicloEspina');
    if (!container) return;
    
    const categorias = [
        { key: 'causasAmbiente', label: 'Medio Ambiente' },
        { key: 'causasMano', label: 'Mano de Obra' },
        { key: 'causasMateriales', label: 'Materiales' },
        { key: 'causasTiempo', label: 'Tiempo' },
        { key: 'causasMetodo', label: 'M√©todo' },
        { key: 'causasMaquina', label: 'M√°quina' }
    ];
    
    let html = '';
    let hayCausas = false;
    
    categorias.forEach(cat => {
        const causasStr = ciclo[cat.key] || '';
        if (causasStr && causasStr.trim()) {
            hayCausas = true;
            const causas = causasStr.split('|').filter(c => c.trim());
            html += `
                <div class="espina-categoria-card">
                    <div class="espina-categoria-title">${cat.label}</div>
                    <ul class="espina-categoria-list">
                        ${causas.map(c => `<li>${c.trim()}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
    });
    
    container.innerHTML = hayCausas ? html : '<p class="no-data-msg">No se registraron causas en la espina de pescado</p>';
}

// Renderizar resumen de 5 Por Qu√© - VERSI√ìN CORREGIDA
function renderPorquesResumen(ciclo) {
    const container = document.getElementById('modalCicloPorques');
    if (!container) return;
    
    let porques = [];
    try {
        porques = ciclo.analisis5Porques ? JSON.parse(ciclo.analisis5Porques) : [];
    } catch (e) {
        porques = [];
    }
    
    if (!porques || porques.length === 0) {
        container.innerHTML = '<p class="no-data-msg">No se realiz√≥ an√°lisis de 5 Por Qu√©</p>';
        return;
    }
    
    let html = '';
    porques.forEach((item, idx) => {
        // Extraer los datos de cada porque
        const porque1 = item.porque1 || {};
        const porque2 = item.porque2 || {};
        const porque3 = item.porque3 || {};
        const porque4 = item.porque4 || {};
        const porque5 = item.porque5 || {};
        
        html += `
            <div class="porque-card">
                <div class="porque-causa-title">${item.causa || 'Causa ' + (idx + 1)}</div>
                <div class="porque-pasos-grid">
                    <div class="porque-paso-item ${porque1.pregunta || porque1.respuesta ? '' : 'empty'}">
                        <strong>¬øPor qu√© 1?</strong>
                        <span>${porque1.pregunta || '-'}</span>
                        ${porque1.respuesta ? `<br><strong>Respuesta:</strong> ${porque1.respuesta}` : ''}
                    </div>
                    <div class="porque-paso-item ${porque2.pregunta || porque2.respuesta ? '' : 'empty'}">
                        <strong>¬øPor qu√© 2?</strong>
                        <span>${porque2.pregunta || '-'}</span>
                        ${porque2.respuesta ? `<br><strong>Respuesta:</strong> ${porque2.respuesta}` : ''}
                    </div>
                    <div class="porque-paso-item ${porque3.pregunta || porque3.respuesta ? '' : 'empty'}">
                        <strong>¬øPor qu√© 3?</strong>
                        <span>${porque3.pregunta || '-'}</span>
                        ${porque3.respuesta ? `<br><strong>Respuesta:</strong> ${porque3.respuesta}` : ''}
                    </div>
                    <div class="porque-paso-item ${porque4.pregunta || porque4.respuesta ? '' : 'empty'}">
                        <strong>¬øPor qu√© 4?</strong>
                        <span>${porque4.pregunta || '-'}</span>
                        ${porque4.respuesta ? `<br><strong>Respuesta:</strong> ${porque4.respuesta}` : ''}
                    </div>
                    <div class="porque-paso-item ${porque5.pregunta || porque5.respuesta ? '' : 'empty'}">
                        <strong>¬øPor qu√© 5?</strong>
                        <span>${porque5.pregunta || '-'}</span>
                        ${porque5.respuesta ? `<br><strong>Respuesta:</strong> ${porque5.respuesta}` : ''}
                    </div>
                </div>
                ${item.causaRaiz ? `
                    <div class="porque-raiz-box">
                        <strong>Causa Ra√≠z:</strong> ${item.causaRaiz}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderPlanAccionResumen(ciclo) {
    const container = document.getElementById('modalCicloPlanAccion');
    if (!container) return;
    
    console.log('üîç DIAGN√ìSTICO Frontend - Ciclo recibido:', ciclo);
    console.log('üîç DIAGN√ìSTICO Frontend - planAccion tipo:', typeof ciclo.planAccion);
    console.log('üîç DIAGN√ìSTICO Frontend - planAccion valor:', ciclo.planAccion);
    
    let acciones = [];
    
    try {
        // DIAGN√ìSTICO: Ver qu√© tipo de dato es planAccion
        if (Array.isArray(ciclo.planAccion)) {
            console.log('‚úÖ planAccion es array, longitud:', ciclo.planAccion.length);
            acciones = ciclo.planAccion;
        } 
        else if (typeof ciclo.planAccion === 'string') {
            console.log('‚ö†Ô∏è planAccion es string, intentando parsear');
            const cleaned = ciclo.planAccion.trim();
            
            if (cleaned && (cleaned.startsWith('[') || cleaned.startsWith('{'))) {
                try {
                    acciones = JSON.parse(cleaned);
                    console.log('‚úÖ Parseo exitoso, acciones:', acciones.length);
                } catch (parseError) {
                    console.error('‚ùå Error parseando string:', parseError);
                }
            }
        }
        else {
            console.warn('‚ö†Ô∏è planAccion no es array ni string:', ciclo.planAccion);
        }
        
        // Asegurar que sea array
        if (!Array.isArray(acciones)) {
            console.warn('‚ö†Ô∏è acciones no es array, asignando vac√≠o');
            acciones = [];
        }
        
    } catch (e) {
        console.error('‚ùå Error procesando plan de acci√≥n:', e);
        acciones = [];
    }
    
    console.log('‚úÖ Acciones finales para renderizar:', acciones.length);
    
    if (acciones.length === 0) {
        container.innerHTML = '<p class="no-data-msg">No se registraron acciones en el plan</p>';
        return;
    }
    
    let html = `
        <div class="plan-accion-summary-header">
            <h4>Plan de Acci√≥n - Total: ${acciones.length} acci√≥n(es)</h4>
        </div>
        <table class="plan-tabla-resumen">
            <thead>
                <tr>
                    <th>Causa Ra√≠z</th>
                    <th>Qu√©</th>
                    <th>D√≥nde</th>
                    <th>Qui√©n</th>
                    <th>C√≥mo</th>
                    <th>Cu√°ndo</th>
                    <th>Cu√°nto</th>
                    <th style="width: 60px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // Primero crear todas las filas sin contadores
        acciones.forEach((accion, index) => {
        // ‚úÖ CORRECCI√ìN: Escapar comillas y caracteres especiales para onclick
        const causaParaOnclick = (accion.cual || '-')
            .replace(/"/g, '&quot;')  // Escapar comillas dobles
            .replace(/'/g, "\\'")     // Escapar comillas simples
            .replace(/\\/g, '\\\\')   // Escapar barras invertidas
            .replace(/\n/g, '\\n')    // Escapar saltos de l√≠nea
            .replace(/\r/g, '\\r');   // Escapar retornos de carro
        
        html += `
            <tr data-causa-index="${index}">
                <td class="causa-cell">${accion.cual || '-'}</td>
                <td>${accion.que || '-'}</td>
                <td>${accion.donde || '-'}</td>
                <td>${accion.quien || '-'}</td>
                <td>${accion.como || '-'}</td>
                <td>${formatearFechaCiclo(accion.cuando)}</td>
                <td>${accion.cuanto || '-'}</td>
                <td class="acciones-cell">
                    <button type="button" 
                            class="btn-acciones-causa" 
                            onclick="mostrarAccionesCausa(${index}, '${causaParaOnclick}')"
                            title="Cargando...">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // DESPU√âS de renderizar, cargar los contadores para cada causa
    setTimeout(() => {
        acciones.forEach((accion, index) => {
            cargarContadorInicial(index, ciclo.id);
        });
    }, 100);
}

function cargarContadorInicial(idCausa, cicloId) {
    const fila = document.querySelector(`tr[data-causa-index="${idCausa}"]`);
    if (!fila || !cicloId) return;
    
    google.script.run
        .withSuccessHandler(function(contador) {
            const btn = fila.querySelector('.btn-acciones-causa');
            if (!btn) return;
            
            if (contador > 0) {
                // Verificar si ya existe un contador
                let countSpan = btn.querySelector('.acciones-count');
                if (!countSpan) {
                    countSpan = document.createElement('span');
                    countSpan.className = 'acciones-count';
                    btn.appendChild(countSpan);
                }
                countSpan.textContent = contador;
                btn.title = `${contador} acci√≥n(es) adjunta(s)`;
            } else {
                // Limpiar contador si existe
                const countSpan = btn.querySelector('.acciones-count');
                if (countSpan) countSpan.remove();
                btn.title = 'Agregar acciones';
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando contador inicial:', error);
        })
        .getContadorAccionesCausa(cicloId, idCausa);
}

function mostrarAccionesCausa(idCausa, nombreCausa) {
  try {
    console.log('Mostrar acciones - ID Causa:', idCausa, 'Nombre:', nombreCausa);
    
    if (!cicloActual) {
      showAlert('error', 'Error', 'No hay un ciclo cargado');
      return;
    }
    
    // ‚úÖ CORRECCI√ìN: Guardar referencia globalmente
    accionCausaActual = {
      id: parseInt(idCausa),
      nombre: nombreCausa,
      cicloId: cicloActual.id,
      causaIndex: parseInt(idCausa), // Guardar tambi√©n el √≠ndice para seguimiento
      causaTexto: nombreCausa
    };
        
        // Crear el modal si no existe
        crearModalAccionesCausa();
        
        // Peque√±o delay para asegurar que el DOM se actualice
        setTimeout(() => {
            const modal = document.getElementById('modalAccionesCausa');
            
            if (!modal) {
                console.error('‚ùå Modal no se pudo crear');
                showAlert('error', 'Error', 'No se pudo crear el modal. Por favor, recarga la p√°gina.');
                return;
            }
            
            console.log('‚úÖ Modal encontrado');
            
            // Establecer t√≠tulo y subt√≠tulo
            const tituloEl = document.getElementById('modalAccionesTitulo');
            const subtituloEl = document.getElementById('modalAccionesSubtitulo');
            
            if (tituloEl) {
                tituloEl.textContent = `Acciones de Causa`;
            }
            if (subtituloEl) {
                subtituloEl.textContent = nombreCausa;
            }
            
            // Auto-completar responsable si existe el campo
            const responsableInput = document.getElementById('nuevaAccionResponsable');
            if (responsableInput && currentUser && currentUser.nombre) {
                responsableInput.value = currentUser.nombre;
                console.log('‚úÖ Responsable autocompletado:', currentUser.nombre);
            }
            
            // Mostrar modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Modal mostrado');
            
            // Cargar acciones
            cargarAccionesCausa(idCausa);
            
        }, 100);
        
    } catch (error) {
        console.error('üí• ERROR en mostrarAccionesCausa:', error);
        showAlert('error', 'Error', `Error al mostrar acciones: ${error.message}`);
    }
}

function crearModalAccionesCausa() {
    // Verificar si el modal ya existe
    if (document.getElementById('modalAccionesCausa')) {
        console.log('Modal ya existe, reutilizando...');
        return;
    }

    const nombreCiclo = cicloActual ? cicloActual.nombre || 'Ciclo sin nombre' : 'Ciclo no disponible';
    
    console.log('Creando nuevo modal de acciones...');
    
    const modalHTML = `
        <div id="modalAccionesCausa" class="modal-causa-acciones">
            <div class="modal-causa-content">
                <div class="modal-causa-header">
                    <div class="modal-header-content">
                        <div class="modal-header-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div>
                            <h3 id="modalAccionesTitulo">Acciones de Causa</h3>
                            <p class="modal-subtitle" id="modalAccionesSubtitulo">Cargando...</p>
                        </div>
                    </div>
                    <button type="button" class="modal-causa-close" aria-label="Cerrar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-causa-body">
                    <div class="modal-causa-panel" style="flex: 1;">
                        <div class="panel-header">
                            <h4 class="panel-title">
                                <i class="far fa-clock"></i>
                                Historial de Acciones
                            </h4>
                        </div>
                        
                        <div class="acciones-estado-resumen" id="resumenEstados">
                            <div class="estado-resumen-item completada">
                                <div class="estado-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <span class="estado-count" id="contadorCompletadas">0</span>
                                <span class="estado-label">Completadas</span>
                            </div>
                            <div class="estado-resumen-item en-progreso">
                                <div class="estado-icon">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <span class="estado-count" id="contadorEnProgreso">0</span>
                                <span class="estado-label">En Progreso</span>
                            </div>
                            <div class="estado-resumen-item pendiente">
                                <div class="estado-icon">
                                    <i class="far fa-clock"></i>
                                </div>
                                <span class="estado-count" id="contadorPendientes">0</span>
                                <span class="estado-label">Pendientes</span>
                            </div>
                        </div>
                        
                        <div class="acciones-causa-list" id="listaAccionesCausa">
                            <div class="loading-acciones">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <p>Cargando acciones...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-causa-panel" style="flex: 1.5;">
                        <div class="panel-header">
                            <h4 class="panel-title">
                                <i class="fas fa-plus-circle"></i>
                                Nueva Acci√≥n 5W+2H
                            </h4>
                        </div>
                        
                        <div class="acciones-causa-form">
                            <!-- QU√â (Descripci√≥n) -->
                            <div class="form-group">
                                <label for="nuevaAccionQue">
                                    <i class="far fa-question-circle"></i>
                                    QU√â (Descripci√≥n)
                                </label>
                                <textarea id="nuevaAccionQue" 
                                          class="form-textarea" 
                                          placeholder="Describe QU√â se debe hacer para solucionar esta causa..."
                                          rows="3"></textarea>
                                <div class="form-hint">Describe claramente la acci√≥n espec√≠fica</div>
                            </div>
                            
                            <div class="form-row-2col">
                                <!-- D√ìNDE -->
                                <div class="form-group">
                                    <label for="nuevaAccionDonde">
                                        <i class="fas fa-map-marker-alt"></i>
                                        D√ìNDE
                                    </label>
                                    <input type="text" 
                                           id="nuevaAccionDonde" 
                                           class="form-input"
                                           placeholder="Proceso, l√≠nea, √°rea, equipo...">
                                    <div class="form-hint">Ej: L√≠nea A, Molino, Almac√©n</div>
                                </div>
                                
                                <!-- QUI√âN -->
                                <div class="form-group">
                                    <label for="nuevaAccionQuien">
                                        <i class="fas fa-user-tie"></i>
                                        QUI√âN
                                    </label>
                                    <input type="text" 
                                           id="nuevaAccionQuien" 
                                           class="form-input"
                                           placeholder="Responsable de ejecutar"
                                           value="${currentUser ? currentUser.nombre || '' : ''}">
                                    <div class="form-hint">Persona encargada</div>
                                </div>
                            </div>
                            
                            <!-- C√ìMO -->
                            <div class="form-group">
                                <label for="nuevaAccionComo">
                                    <i class="fas fa-cogs"></i>
                                    C√ìMO
                                </label>
                                <textarea id="nuevaAccionComo" 
                                          class="form-textarea" 
                                          placeholder="Describe C√ìMO se realizar√° la acci√≥n (procedimiento, m√©todo, herramienta)..."
                                          rows="2"></textarea>
                                <div class="form-hint">Procedimiento, m√©todo o herramienta a utilizar</div>
                            </div>
                            
                            <div class="form-row-3col">
                                <!-- CU√ÅNDO -->
                                <div class="form-group">
                                    <label for="nuevaAccionCuando">
                                        <i class="far fa-calendar-alt"></i>
                                        CU√ÅNDO
                                    </label>
                                    <input type="date" 
                                           id="nuevaAccionCuando" 
                                           class="form-input">
                                    <div class="form-hint">Fecha l√≠mite</div>
                                </div>
                                
                                <!-- CU√ÅNTO -->
                                <div class="form-group">
                                    <label for="nuevaAccionCuanto">
                                        <i class="fas fa-money-bill-wave"></i>
                                        CU√ÅNTO
                                    </label>
                                    <input type="text" 
                                           id="nuevaAccionCuanto" 
                                           class="form-input"
                                           placeholder="$ o recursos">
                                    <div class="form-hint">Costo, horas, recursos</div>
                                </div>
                                
                                <!-- ESTADO -->
                                <div class="form-group">
                                    <label for="nuevaAccionEstado">
                                        <i class="fas fa-flag"></i>
                                        Estado
                                    </label>
                                    <select id="nuevaAccionEstado" class="form-select">
                                        <option value="pendiente">
                                            <i class="far fa-clock"></i> Pendiente
                                        </option>
                                        <option value="en_progreso">
                                            <i class="fas fa-spinner"></i> En Progreso
                                        </option>
                                        <option value="completada">
                                            <i class="fas fa-check-circle"></i> Completada
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="cerrarModalAccionesCausa()">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </button>
                                <button type="button" class="btn-primary" onclick="guardarAccionCausa()">
                                    <i class="fas fa-save"></i>
                                    Guardar Acci√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-causa-footer">
                    <div class="footer-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Acciones para: <strong id="footerCausaNombre">${nombreCiclo}</strong></span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    console.log('Modal creado exitosamente');
    
    // Agregar event listeners DESPU√âS de que el modal se haya agregado al DOM
    setTimeout(() => {
        const modal = document.getElementById('modalAccionesCausa');
        if (!modal) {
            console.error('Modal no encontrado despu√©s de creaci√≥n');
            return;
        }
        
        const closeBtn = modal.querySelector('.modal-causa-close');
        
        // Listener para cerrar con el bot√≥n X
        if (closeBtn) {
            closeBtn.addEventListener('click', cerrarModalAccionesCausa);
        }
        
        // Listener para cerrar haciendo clic fuera
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cerrarModalAccionesCausa();
            }
        });
        
        // Listener para cerrar con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                cerrarModalAccionesCausa();
            }
        });
        
    }, 50); // Aumentado a 50ms para dar tiempo al DOM
}

// Cerrar modal de acciones - VERSI√ìN M√ÅS ROBUSTA
function cerrarModalAccionesCausa() {
    const modal = document.getElementById('modalAccionesCausa');
    if (modal) {
        modal.classList.remove('active');
        console.log('Modal cerrado');
    } else {
        console.warn('Modal no encontrado al intentar cerrar');
    }
    
    document.body.style.overflow = '';
    window.causaActual = null;
    
    // Limpiar formulario
    const elementosFormulario = [
        {id: 'nuevaAccionDescripcion', defaultValue: ''},
        {id: 'nuevaAccionResponsable', defaultValue: currentUser ? currentUser.nombre || '' : ''},
        {id: 'nuevaAccionFechaLimite', defaultValue: ''},
        {id: 'nuevaAccionEstado', defaultValue: 'pendiente'}
    ];
    
    elementosFormulario.forEach(item => {
        const elemento = document.getElementById(item.id);
        if (elemento) {
            elemento.value = item.defaultValue;
        }
    });
}


// Manejar clic fuera del modal
document.addEventListener('click', function(e) {
    const modal = document.getElementById('modalAccionesCausa');
    if (modal && e.target === modal) {
        cerrarModalAccionesCausa();
    }
});

// Cerrar con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalAccionesCausa');
        if (modal && modal.classList.contains('active')) {
            cerrarModalAccionesCausa();
        }
    }
});

function cargarAccionesCausa(idCausa) {
    const lista = document.getElementById('listaAccionesCausa');
    if (!lista) {
        console.error('Elemento listaAccionesCausa no encontrado');
        return;
    }
    
    console.log('Cargando acciones para ID Causa:', idCausa);
    
    // Mostrar loading
    lista.innerHTML = `
        <div class="loading-acciones">
            <svg class="spinner-icon" width="20" height="20" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
            </svg>
            Cargando acciones...
        </div>
    `;
    
    google.script.run
        .withSuccessHandler(function(acciones) {
            console.log('Acciones recibidas del backend:', acciones);
            console.log('Tipo:', typeof acciones);
            console.log('Es array?', Array.isArray(acciones));
            console.log('Longitud:', acciones ? acciones.length : 0);
            
            if (acciones && Array.isArray(acciones)) {
                console.log('Primera acci√≥n (si existe):', acciones[0]);
            }
            
            renderListaAccionesCausa(acciones || []);
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando acciones:', error);
            lista.innerHTML = `
                <div class="error-acciones">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v4m0 4h.01"/>
                    </svg>
                    <p>Error al cargar las acciones</p>
                    <p class="error-details">${error.message || 'Error desconocido'}</p>
                    <button onclick="cargarAccionesCausa(${idCausa})" class="btn-reintentar">
                        Reintentar
                    </button>
                </div>
            `;
        })
        .getAccionesCausa(cicloActual.id, idCausa);
}

function renderListaAccionesCausa(acciones) {
    const lista = document.getElementById('listaAccionesCausa');
    if (!lista) return;
    
    if (!acciones || !Array.isArray(acciones) || acciones.length === 0) {
        lista.innerHTML = `
            <div class="no-acciones">
                <div class="no-acciones-icon" style="
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 1.5rem;
                    border: 3px dashed #cbd5e1;
                ">
                    <i class="far fa-clipboard" style="font-size: 2rem; color: #94a3b8;"></i>
                </div>
                <p style="font-size: 1.1rem; color: #475569; font-weight: 500; margin-bottom: 0.5rem;">
                    No hay acciones registradas
                </p>
                <p class="hint-text" style="color: #94a3b8; font-size: 0.95rem;">
                    Agregue la primera acci√≥n usando el formulario 5W+2H
                </p>
            </div>
        `;
        
        actualizarResumenEstados({completada: 0, en_progreso: 0, pendiente: 0});
        return;
    }
    
    acciones.sort((a, b) => {
        const fechaA = a.fechaCreacion ? new Date(a.fechaCreacion) : new Date(0);
        const fechaB = b.fechaCreacion ? new Date(b.fechaCreacion) : new Date(0);
        return fechaB - fechaA;
    });
    
    const contadores = { completada: 0, en_progreso: 0, pendiente: 0 };
    
    let html = '';
    
    // Obtener el texto de la causa desde la variable global window.causaActual
    const causaTexto = window.causaActual ? window.causaActual.nombre || 'Causa' : 'Causa';
    
    acciones.forEach((accion, index) => {
        const estado = accion.estado || 'pendiente';
        contadores[estado] = (contadores[estado] || 0) + 1;
        
        const estadoClass = estado === 'completada' ? 'completada' : 
                          estado === 'en_progreso' ? 'en-progreso' : 'pendiente';
        
        const estadoIcon = estado === 'completada' ? 'fas fa-check-circle' :
                          estado === 'en_progreso' ? 'fas fa-spinner fa-spin' : 'far fa-clock';
        
        const estadoText = estado === 'completada' ? 'Completada' :
                          estado === 'en_progreso' ? 'En Progreso' : 'Pendiente';
        
        // Formatear fechas
        const fechaCreacion = accion.fechaCreacion ? 
            new Date(accion.fechaCreacion).toLocaleDateString('es-CO', {
                day: '2-digit',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Sin fecha';
        
        const fechaLimite = accion.cuando ? 
            new Date(accion.cuando).toLocaleDateString('es-CO', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }) : 'Sin fecha l√≠mite';
        
        // Escapar el texto de la causa para HTML/JS
        const causaTextoEscapada = causaTexto
            .replace(/"/g, '&quot;')
            .replace(/'/g, "\\'")
            .replace(/\\/g, '\\\\')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\r');
        
        html += `
            <div class="accion-item ${estadoClass}">
                <div class="accion-header">
                    <div class="accion-header-left">
                        <div class="accion-estado">
                            <i class="${estadoIcon}"></i>
                            <span class="accion-estado-text">${estadoText}</span>
                        </div>
                        <div class="accion-fecha">
                            <i class="far fa-calendar"></i>
                            ${fechaCreacion}
                        </div>
                    </div>
                    <button type="button" class="btn-secondary" onclick="abrirSeguimientoAccion(${index}, '${causaTextoEscapada}', '${cicloActual.id}')" title="Seguimiento" style="
    margin-bottom: 12px;
    max-height: 25px;
    font-size: 11px;
">
    Seguimiento
</button>
                    <button type="button" class="btn-eliminar-accion" onclick="eliminarAccionCausa(${index})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="accion-content-5w2h">
                    <div class="accion-descripcion">
                        <strong>QU√â:</strong> ${accion.que || 'Sin descripci√≥n'}
                    </div>
                    
                    <div class="accion-details-grid">
                        <div class="accion-detail ${estadoClass} ${!accion.donde ? 'empty' : ''}">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="accion-detail-content">
                                <strong>D√ìNDE</strong>
                                <span>${accion.donde || 'No especificado'}</span>
                            </div>
                        </div>
                        
                        <div class="accion-detail ${estadoClass} ${!accion.quien ? 'empty' : ''}">
                            <i class="fas fa-user-tie"></i>
                            <div class="accion-detail-content">
                                <strong>QUI√âN</strong>
                                <span>${accion.quien || 'Sin asignar'}</span>
                            </div>
                        </div>
                        
                        <div class="accion-detail ${estadoClass} ${!accion.como ? 'empty' : ''}">
                            <i class="fas fa-cogs"></i>
                            <div class="accion-detail-content">
                                <strong>C√ìMO</strong>
                                <span>${accion.como || 'No especificado'}</span>
                            </div>
                        </div>
                        
                        <div class="accion-detail ${estadoClass} ${!accion.cuando ? 'empty' : ''}">
                            <i class="far fa-calendar-check"></i>
                            <div class="accion-detail-content">
                                <strong>CU√ÅNDO</strong>
                                <span>${fechaLimite}</span>
                            </div>
                        </div>
                        
                        <div class="accion-detail ${estadoClass} ${!accion.cuanto ? 'empty' : ''}">
                            <i class="fas fa-money-bill-wave"></i>
                            <div class="accion-detail-content">
                                <strong>CU√ÅNTO</strong>
                                <span>${accion.cuanto || 'No especificado'}</span>
                            </div>
                        </div>
                        
                        <div class="accion-detail ${estadoClass}">
                            <i class="fas fa-user"></i>
                            <div class="accion-detail-content">
                                <strong>Creado por</strong>
                                <span>${accion.autor || 'Sistema'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    lista.innerHTML = html;
    actualizarResumenEstados(contadores);
}

// Nueva funci√≥n para actualizar el resumen de estados
function actualizarResumenEstados(contadores) {
    document.getElementById('contadorCompletadas').textContent = contadores.completada || 0;
    document.getElementById('contadorEnProgreso').textContent = contadores.en_progreso || 0;
    document.getElementById('contadorPendientes').textContent = contadores.pendiente || 0;
}

function formatearFechaCorta(fecha) {
    if (!fecha) return '-';
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return fecha;
        return d.toLocaleDateString('es-CO', {
            day: '2-digit',
            month: 'short'
        });
    } catch (e) {
        return fecha;
    }
}

function guardarAccionCausa() {
    if (!window.causaActual) {
        showAlert('error', 'Error', 'No hay causa seleccionada');
        return;
    }
    
    // Obtener todos los valores del formulario
    const que = document.getElementById('nuevaAccionQue').value.trim();
    const donde = document.getElementById('nuevaAccionDonde').value.trim();
    const quien = document.getElementById('nuevaAccionQuien').value.trim();
    const como = document.getElementById('nuevaAccionComo').value.trim();
    const cuando = document.getElementById('nuevaAccionCuando').value;
    const cuanto = document.getElementById('nuevaAccionCuanto').value.trim();
    const estado = document.getElementById('nuevaAccionEstado').value;
    
    // Validaciones
    if (!que) {
        showAlert('warning', 'Campo requerido', 'El campo QU√â (Descripci√≥n) es obligatorio');
        document.getElementById('nuevaAccionQue').focus();
        return;
    }
    
    if (!quien) {
        showAlert('warning', 'Campo requerido', 'El campo QUI√âN (Responsable) es obligatorio');
        document.getElementById('nuevaAccionQuien').focus();
        return;
    }
    
    const btn = document.querySelector('.btn-primary');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/></svg> Guardando...';
    
    const accionData = {
        cicloId: window.causaActual.cicloId,
        idCausa: window.causaActual.id,
        que: que,           // QU√â
        donde: donde,       // D√ìNDE
        quien: quien,       // QUI√âN
        como: como,         // C√ìMO
        cuando: cuando,     // CU√ÅNDO
        cuanto: cuanto,     // CU√ÅNTO
        estado: estado,     // Estado
        autor: currentUser ? currentUser.nombre : 'Usuario',
        fechaCreacion: new Date().toISOString()
    };
    
    console.log('Enviando datos de acci√≥n 5W+2H:', accionData);
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('Respuesta del backend:', result);
            
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (result.success) {
                showAlert('success', '√âxito', 'Acci√≥n 5W+2H guardada correctamente');
                
                // Limpiar formulario
                document.getElementById('nuevaAccionQue').value = '';
                document.getElementById('nuevaAccionDonde').value = '';
                document.getElementById('nuevaAccionComo').value = '';
                document.getElementById('nuevaAccionCuando').value = '';
                document.getElementById('nuevaAccionCuanto').value = '';
                document.getElementById('nuevaAccionEstado').value = 'pendiente';
                
                // Auto-completar responsable
                if (currentUser) {
                    document.getElementById('nuevaAccionQuien').value = currentUser.nombre || '';
                }
                
                // Recargar lista
                cargarAccionesCausa(window.causaActual.id);
                
                // Actualizar contador en tabla
                actualizarContadorAcciones(window.causaActual.id);
            } else {
                showAlert('error', 'Error', result.message || 'No se pudo guardar la acci√≥n');
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error en guardarAccionCausa:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            showAlert('error', 'Error', 'Error al guardar: ' + (error.message || error));
        })
        .guardarAccionCausa(accionData);
}

// Eliminar acci√≥n
function eliminarAccionCausa(indexAccion) {
    if (!confirm('¬øEst√° seguro de eliminar esta acci√≥n?')) return;
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showAlert('success', '√âxito', 'Acci√≥n eliminada');
                cargarAccionesCausa(window.causaActual.id);
                actualizarContadorAcciones(window.causaActual.id);
            } else {
                showAlert('error', 'Error', result.message || 'No se pudo eliminar la acci√≥n');
            }
        })
        .withFailureHandler(function(error) {
            showAlert('error', 'Error', 'Error al eliminar: ' + error.message);
        })
        .eliminarAccionCausa(window.causaActual.cicloId, window.causaActual.id, indexAccion);
}

function actualizarContadorAcciones(idCausa) {
    if (!cicloActual || !window.causaActual) return;
    
    const fila = document.querySelector(`tr[data-causa-index="${idCausa}"]`);
    if (!fila) {
        console.warn('Fila no encontrada para actualizar contador');
        return;
    }
    
    google.script.run
        .withSuccessHandler(function(contador) {
            const btn = fila.querySelector('.btn-acciones-causa');
            if (!btn) return;
            
            if (contador > 0) {
                let countSpan = btn.querySelector('.acciones-count');
                if (!countSpan) {
                    countSpan = document.createElement('span');
                    countSpan.className = 'acciones-count';
                    btn.appendChild(countSpan);
                }
                countSpan.textContent = contador;
                btn.title = `${contador} acci√≥n(es) adjunta(s)`;
            } else {
                const countSpan = btn.querySelector('.acciones-count');
                if (countSpan) countSpan.remove();
                btn.title = 'Agregar acciones';
            }
        })
        .withFailureHandler(function(error) {
            console.error('Error actualizando contador:', error);
        })
        .getContadorAccionesCausa(cicloActual.id, idCausa);
}

// Cargar historial de seguimiento
function cargarHistorialCiclo(cicloId) {
    const container = document.getElementById('timelineCiclo');
    if (!container) return;
    
    container.innerHTML = '<div class="ciclos-loading-spinner"><span>Cargando historial...</span></div>';
    
    google.script.run
        .withSuccessHandler(function(historial) {
            console.log('üìã Historial recibido del backend:', historial);
            renderHistorialCiclo(historial || []);
        })
        .withFailureHandler(function(error) {
            console.error('Error cargando historial:', error);
            container.innerHTML = '<p class="no-data-msg">Error al cargar el historial: ' + error.message + '</p>';
        })
        .getHistorialCiclo(cicloId);
}

// Renderizar historial
function renderHistorialCiclo(historial) {
    const container = document.getElementById('timelineCiclo');
    if (!container) return;
    
    if (!historial || historial.length === 0) {
        container.innerHTML = `
            <div class="timeline-empty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
                <p>No hay registros de seguimiento todav√≠a</p>
                <p class="timeline-empty-hint">Agregue el primer comentario para comenzar el historial</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por fecha descendente (m√°s reciente primero)
    historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    let html = '';
    historial.forEach(item => {
        const estadoClass = getEstadoClass(item.estado);
        const fechaFormateada = formatearFechaHora(item.fecha);
        
        html += `
            <div class="timeline-entry">
                <div class="timeline-header">
                    <div class="timeline-fecha">${fechaFormateada}</div>
                    <div class="timeline-estado">
                        <span class="estado-badge ${estadoClass}">${item.estado || 'Sin estado'}</span>
                    </div>
                </div>
                <div class="timeline-comentario">
                    <div class="comentario-content">
                        ${item.comentario || '<em style="color:#9ca3af;">Sin comentario</em>'}
                    </div>
                </div>
                <div class="timeline-autor">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    ${item.autor || 'Sistema'}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Formatear fecha y hora
function formatearFechaHora(fecha) {
    if (!fecha) return '-';
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return fecha;
        return d.toLocaleDateString('es-CO', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return fecha;
    }
}

// Guardar seguimiento
function guardarSeguimientoCiclo() {
    if (!cicloActual) {
        showAlert('error', 'Error', 'No hay ciclo seleccionado');
        return;
    }
    
    const nuevoEstado = document.getElementById('nuevoEstadoCiclo').value;
    const comentario = document.getElementById('comentarioCiclo').value.trim();
    
    if (!comentario) {
        showAlert('warning', 'Atenci√≥n', 'Por favor agregue un comentario para el seguimiento');
        return;
    }
    
    const btn = document.querySelector('.btn-guardar-seguimiento');
    btn.disabled = true;
    btn.innerHTML = '<svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/></svg> Guardando...';
    
    const seguimiento = {
        cicloId: cicloActual.id,
        estado: nuevoEstado,
        comentario: comentario,
        autor: currentUser ? currentUser.nombre : 'Usuario'
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Guardar Seguimiento';
            
            if (result.success) {
                showAlert('success', '√âxito', 'Seguimiento guardado correctamente');
                
                // Actualizar estado en modal
                const estadoEl = document.getElementById('modalCicloEstado');
                estadoEl.textContent = nuevoEstado;
                estadoEl.className = 'modal-ciclo-estado-badge estado-badge ' + getEstadoClass(nuevoEstado);
                
                // Actualizar ciclo actual
                cicloActual.estado = nuevoEstado;
                
                // Actualizar en array
                const idx = ciclosData.findIndex(c => c.id === cicloActual.id);
                if (idx !== -1) {
                    ciclosData[idx].estado = nuevoEstado;
                }
                
                // Limpiar comentario
                document.getElementById('comentarioCiclo').value = '';
                
                // Recargar historial
                cargarHistorialCiclo(cicloActual.id);
                
                // Actualizar tabla y estad√≠sticas
                renderCiclosTable(ciclosData);
                actualizarEstadisticasCiclos(ciclosData);
            } else {
                showAlert('error', 'Error', result.message || 'No se pudo guardar el seguimiento');
            }
        })
        .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Guardar Seguimiento';
            showAlert('error', 'Error', 'Error al guardar: ' + (error.message || error));
        })
        .guardarSeguimientoCiclo(seguimiento);
}

// Cerrar modal al hacer clic fuera
document.addEventListener('click', function(e) {
    const modal = document.getElementById('modalDetalleCiclo');
    if (e.target === modal) {
        cerrarModalCiclo();
    }
});

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalDetalleCiclo');
        if (modal && modal.classList.contains('active')) {
            cerrarModalCiclo();
        }
    }
});

// ========== FUNCIONES SEGUIMIENTO POR ACCI√ìN-CAUSA ==========

function guardarSeguimientoAccion() {
    if (!accionCausaActual) {
        showAlert('error', 'Error', 'No hay acci√≥n seleccionada');
        return;
    }
    
    const nuevoEstado = document.getElementById('nuevoEstadoAccion').value;
    const comentario = document.getElementById('comentarioAccion').value.trim();
    
    if (!comentario) {
        showAlert('warning', 'Atenci√≥n', 'Por favor agregue un comentario');
        return;
    }
    
    const btn = document.querySelector('.btn-guardar-seguimiento');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/></svg> Guardando...';
    
    const seguimiento = {
        cicloId: accionCausaActual.cicloId,
        causaIndex: accionCausaActual.causaIndex,
        causaTexto: accionCausaActual.causaTexto,
        estado: nuevoEstado,
        comentario: comentario,
        autor: currentUser ? currentUser.nombre : 'Usuario'
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            
            if (result.success) {
                showAlert('success', '√âxito', 'Seguimiento guardado correctamente');
                document.getElementById('comentarioAccion').value = '';
                cargarHistorialAccionCausa(accionCausaActual.cicloId, accionCausaActual.causaIndex);
            } else {
                showAlert('error', 'Error', result.message || 'No se pudo guardar');
            }
        })
        .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            showAlert('error', 'Error', 'Error al guardar: ' + error.message);
        })
        .guardarSeguimientoAccionCausa(seguimiento);
}

function cargarHistorialAccionCausa(cicloId, causaIndex) {
    const timeline = document.getElementById('timelineAccion');
    if (!timeline) return;
    
    // Mostrar skeleton loader
    timeline.innerHTML = `
        <div class="skeleton-loader">
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
        </div>
    `;
    
    // Cargar datos con timeout para evitar bloqueo
    setTimeout(() => {
        google.script.run
            .withSuccessHandler(function(historial) {
                // Usar requestAnimationFrame para render suave
                requestAnimationFrame(() => {
                    renderHistorialAccionCausa(historial);
                });
            })
            .withFailureHandler(function(error) {
                timeline.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error al cargar historial</p>
                        <button onclick="cargarHistorialAccionCausa('${cicloId}', ${causaIndex})" class="btn-retry">
                            Reintentar
                        </button>
                    </div>
                `;
            })
            .getHistorialAccionCausa(cicloId, causaIndex);
    }, 300); // Peque√±o delay para priorizar la UI
}

function renderHistorialAccionCausa(historial) {
  const timeline = document.getElementById('timelineAccion');
  
  if (!historial || historial.length === 0) {
    timeline.innerHTML = `
      <div style="
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
      ">
        <i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; display: block; color: #ccc;"></i>
        No hay registros de seguimiento a√∫n
      </div>
    `;
    return;
  }
  
  let html = '';
  historial.forEach(registro => {
    const fecha = new Date(registro.fecha);
    const fechaStr = fecha.toLocaleDateString('es-MX', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    // Determinar clase de estado
    const estadoClass = registro.estado === 'Completado' ? 'completado' : 
                       registro.estado === 'En Progreso' ? 'en-progreso' : 
                       registro.estado === 'Cerrado' ? 'cerrado' : 'abierto';
    
    html += `
      <div style="
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid ${
          registro.estado === 'Completado' ? '#28a745' :
          registro.estado === 'En Progreso' ? '#007bff' :
          registro.estado === 'Cerrado' ? '#6c757d' : '#17a2b8'
        };
      ">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-size: 12px; color: #666;">
            <i class="far fa-calendar" style="margin-right: 5px;"></i>
            ${fechaStr}
          </span>
          <span style="
            background: ${
              registro.estado === 'Completado' ? '#28a745' :
              registro.estado === 'En Progreso' ? '#007bff' :
              registro.estado === 'Cerrado' ? '#6c757d' : '#17a2b8'
            };
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
          ">
            ${registro.estado}
          </span>
        </div>
        <div style="margin-bottom: 8px; font-size: 14px;">
          ${registro.comentario || '<em style="color: #999;">Sin comentario</em>'}
        </div>
        <div style="font-size: 12px; color: #666;">
          <i class="fas fa-user" style="margin-right: 5px;"></i>
          ${registro.autor || 'Sistema'}
        </div>
      </div>
    `;
  });
  
  timeline.innerHTML = html;
}

function abrirSeguimientoAccion(causaIndex, causaTexto, cicloId) {
    // Mostrar loader inmediatamente
    showAlert('info', 'Cargando...', 'Abriendo seguimiento', 1500);
    
    // Establecer datos m√≠nimos primero
    accionCausaActual = {
        id: parseInt(causaIndex),
        nombre: causaTexto,
        cicloId: cicloId || (cicloActual ? cicloActual.id : null),
        causaIndex: parseInt(causaIndex),
        causaTexto: causaTexto
    };
    
    // Validaci√≥n r√°pida
    if (!accionCausaActual.cicloId) {
        showAlert('error', 'Error', 'No se encontr√≥ el ciclo');
        return;
    }
    
    // Crear modal (usando cach√©)
    const modal = crearModalSeguimientoAccion();
    
    // Establecer datos b√°sicos inmediatamente
    document.getElementById('seguimientoCicloId').textContent = accionCausaActual.cicloId;
    document.getElementById('seguimientoCausaTexto').textContent = causaTexto || 'Acci√≥n espec√≠fica';
    document.getElementById('nuevoEstadoAccion').value = 'Abierto'; // Valor por defecto
    document.getElementById('comentarioAccion').value = '';
    
    // Mostrar modal inmediatamente
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Cargar datos en segundo plano (sin bloquear la UI)
    setTimeout(() => {
        // Obtener estado real (async)
        google.script.run
            .withSuccessHandler(function(estadoActual) {
                if (estadoActual && document.getElementById('nuevoEstadoAccion')) {
                    document.getElementById('nuevoEstadoAccion').value = estadoActual;
                }
            })
            .getEstadoAccionCausa(accionCausaActual.cicloId, causaIndex);
        
        // Cargar historial
        cargarHistorialAccionCausa(accionCausaActual.cicloId, causaIndex);
    }, 100);
}

let modalSeguimientoCache = null;
let modalInitialized = false;

function crearModalSeguimientoAccion() {
    // Usar cach√© del modal
    if (modalSeguimientoCache && document.body.contains(modalSeguimientoCache)) {
        return modalSeguimientoCache;
    }
    
    // Crear modal simple
    const modalHTML = `
    <div id="modalSeguimientoAccion" class="modal-overlay-seguimiento" style="display:none;">
        <div class="modal-seguimiento-content">
            <button class="modal-seguimiento-close">&times;</button>
            
            <div class="modal-seguimiento-header">
                <div class="modal-header-info">
                    <span class="modal-seguimiento-id-badge" id="seguimientoCicloId">CM-001</span>
                    <span class="modal-seguimiento-causa-badge" id="seguimientoCausaTexto">Causa ra√≠z</span>
                </div>
                <h3 class="modal-seguimiento-title">Seguimiento de Acci√≥n-Causa</h3>
            </div>

            <div class="seguimiento-form-box">
                <h4>Actualizar Estado</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nuevo Estado</label>
                        <select class="form-select" id="nuevoEstadoAccion">
                            <option value="Abierto">Abierto</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Implementado">Implementado</option>
                            <option value="Cerrado">Cerrado</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Comentario</label>
                    <textarea class="form-textarea" id="comentarioAccion" 
                              placeholder="Agregue un comentario sobre el cambio de estado o avance de la acci√≥n..." 
                              rows="3"></textarea>
                </div>
                <button type="button" class="btn-guardar-seguimiento">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Guardar Seguimiento
                </button>
            </div>

            <div class="historial-section">
                <h4>Historial de Seguimiento</h4>
                <div class="timeline-wrapper" id="timelineAccion"></div>
            </div>
        </div>
    </div>
    `;
    
    // Agregar al DOM una sola vez
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Guardar referencia en cach√©
    modalSeguimientoCache = document.getElementById('modalSeguimientoAccion');
    
    // Configurar listeners solo una vez
    if (!modalInitialized) {
        setupModalListeners();
        modalInitialized = true;
    }
    
    return modalSeguimientoCache;
}

function cerrarModalSeguimiento() {
    const modal = modalSeguimientoCache;
    if (!modal) return;
    
    // Animaci√≥n de salida
    modal.style.opacity = '0';
    modal.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
        modal.style.display = 'none';
        // Restaurar para la pr√≥xima apertura
        modal.style.opacity = '1';
        modal.style.transform = 'scale(1)';
        document.body.style.overflow = 'auto';
        accionCausaActual = null;
        
        // Limpiar contenido pesado
        const timeline = document.getElementById('timelineAccion');
        if (timeline) timeline.innerHTML = '';
    }, 200);
}

function setupModalListeners() {
    const modal = modalSeguimientoCache;
    if (!modal) return;
    
    // Cerrar modal con bot√≥n X
    const closeBtn = modal.querySelector('.modal-seguimiento-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', cerrarModalSeguimiento);
    }
    
    // Cerrar modal haciendo clic fuera
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            cerrarModalSeguimiento();
        }
    });
    
    // Guardar seguimiento
    const saveBtn = modal.querySelector('.btn-guardar-seguimiento');
    if (saveBtn) {
        saveBtn.addEventListener('click', guardarSeguimientoAccion);
    }
    
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display !== 'none') {
            cerrarModalSeguimiento();
        }
    });
}

</script>

