<script>
    function showChangeTarjetaResponsibleModal(rowIndex, currentResponsible) {
        const existingModal = document.getElementById('tarjetaResponsibleModal');
        if (existingModal) existingModal.remove();

        // Obtener las opciones del select del formulario de tarjetas
        const responsableSelect = document.getElementById('responsableSolucion');
        const responsables = [];

        if (responsableSelect) {
            // Recorrer todas las opciones del select
            Array.from(responsableSelect.options).forEach(option => {
                if (option.value && option.value.trim() !== '') {
                    responsables.push({
                        value: option.value,
                        text: option.text
                    });
                }
            });
        }

        const overlay = document.createElement('div');
        overlay.id = 'tarjetaResponsibleModal';
        overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

        const modal = document.createElement('div');
        modal.style.cssText = `
    background: #fff; padding: 1.5rem;
    border-radius: 16px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 1rem;
  `;

        modal.innerHTML = `
    <h2 style="text-align:center; color:#1e293b; font-size:18px; font-weight:600;">
      <i class="fa-regular fa-user"></i> Reasignar Responsable - Tarjeta
    </h2>

    <div style="margin-bottom: 0.5rem;">
      <label style="font-weight:500; color:#475569; font-size:14px;">Responsable actual:</label>
      <div style="padding:0.5rem; background:#f8fafc; border-radius:6px; margin-top:4px;">
        ${currentResponsible || 'No asignado'}
      </div>
    </div>

    <div style="margin-bottom: 0.5rem;">
      <label style="font-weight:500; color:#475569; font-size:14px; display:block; margin-bottom:8px;">
        Nuevo responsable:
      </label>
      <select id="newTarjetaResponsable" 
        style="width:100%; padding:0.6rem 0.8rem; border:1px solid #cbd5e1; border-radius:8px; font-size:14px; background:white;">
        <option value="">Seleccione un responsable</option>
        ${responsables.map(r =>
            `<option value="${escapeHtml(r.value)}">${escapeHtml(r.text)}</option>`
        ).join('')}
      </select>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
      <button id="cancelTarjetaReassign" 
        style="padding:0.5rem 1rem; border:1px solid #cbd5e1; border-radius:8px; cursor:pointer;">
        Cancelar
      </button>
      <button id="saveTarjetaReassign" 
        style="padding:0.5rem 1rem; border:none; background:#3b82f6; color:#fff; border-radius:8px; cursor:pointer;">
        Guardar
      </button>
    </div>
  `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const selectElement = modal.querySelector('#newTarjetaResponsable');

        modal.querySelector('#cancelTarjetaReassign').addEventListener('click', () => overlay.remove());

        modal.querySelector('#saveTarjetaReassign').addEventListener('click', () => {
            const nuevoResponsable = selectElement.value.trim();

            if (!nuevoResponsable) {
                showAlert('warning', 'Campo vacío', 'Debes seleccionar un responsable');
                return;
            }

            if (nuevoResponsable === currentResponsible) {
                showAlert('warning', 'Sin cambios', 'El nuevo responsable es el mismo que el actual');
                return;
            }

            overlay.remove();
            showAlert('info', 'Actualizando...', 'Reasignando responsable de la tarjeta...', 2000);

            google.script.run
                .withSuccessHandler(() => {
                    showAlert('success', 'Éxito', 'Responsable actualizado correctamente');
                    // Recargar las tarjetas manteniendo los filtros
                    if (window.tarjetasBase && window.tarjetasBase.length > 0) {
                        applyTarjetaFilters(); // Vuelve a aplicar filtros
                    } else {
                        loadTarjetasReports(); // Recarga todo
                    }
                })
                .withFailureHandler(err => {
                    console.error(err);
                    showAlert('error', 'Error', 'No se pudo actualizar el responsable');
                })
                .updateTarjetaResponsible(rowIndex, nuevoResponsable);
        });

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.remove();
        });
    }

</script>