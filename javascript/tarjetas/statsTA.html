<script>

    // Modal para estadísticas de tarjetas
    function openStatsForTarjetas() {
        showTarjetasStatsModal();
    }

    function showTarjetasStatsModal() {
        // Eliminar modal existente si hay
        const existingModal = document.getElementById('tarjetasStatsModal');
        if (existingModal) existingModal.remove();

        // Crear overlay
        const overlay = document.createElement('div');
        overlay.id = 'tarjetasStatsModal';
        overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

        // Crear modal
        const modal = document.createElement('div');
        modal.style.cssText = `
        background: white;
        border-radius: 12px;
        width: 95%;
        max-width: 1400px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    `;

        // Header del modal
        modal.innerHTML = `
        <div style="
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f307f;
            border-radius: 12px 12px 0 0;
            color: white;
        ">
            <div>
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">
                    <i style="margin-right: 10px;" class="fa-solid fa-chart-line"></i> Dashboard de Estadísticas T.A
                </h2>
                <p style="margin: 4px 0 0; opacity: 0.9; font-size: 14px;">
                    Informe completo de gestión de tarjetas
                </p>
            </div>
            <button onclick="closeTarjetasStatsModal()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            ">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <!-- Tabs Navigation -->
        <div style="
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            padding: 0 24px;
            overflow-x: inherit;
        " id="statsTabs">
            <button onclick="switchTab('riesgo-problema')" class="stats-tab active" data-tab="riesgo-problema">
                <i class="fa-solid fa-triangle-exclamation"></i> Riesgo/Problema
            </button>
            <button onclick="switchTab('riesgo-anual')" class="stats-tab" data-tab="riesgo-anual">
                <i class="fa-solid fa-calendar-check"></i> Riesgo/Problema por año
            </button>
            <button onclick="switchTab('responsable-cargo')" class="stats-tab" data-tab="responsable-cargo">
                <i class="fa-solid fa-user-tie"></i> Por Responsable
            </button>
            <button onclick="switchTab('lider-solucion')" class="stats-tab" data-tab="lider-solucion">
                <i class="fa-solid fa-user-check"></i> Por Líder
            </button>
            <button onclick="switchTab('zona-riesgo')" class="stats-tab" data-tab="zona-riesgo">
                <i class="fa-solid fa-map-marker-alt"></i> Por Zona
            </button>
            <button onclick="switchTab('tipo-reporte')" class="stats-tab" data-tab="tipo-reporte">
                <i class="fa-solid fa-file-alt"></i> Por Reporte
            </button>
            <button onclick="switchTab('mensual')" class="stats-tab" data-tab="mensual">
                <i class="fa-solid fa-calendar-alt"></i> Mensual
            </button>
        </div>
        
        <!-- Tab Content Container -->
        <div style="padding: 24px; overflow-y: auto; flex: 1;" id="tabContent">
            <!-- Contenido se cargará dinámicamente -->
        </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Cargar la primera pestaña por defecto
        switchTab('riesgo-problema');

        // Cerrar al hacer clic fuera
        overlay.addEventListener('click', function (e) {
            if (e.target === overlay) {
                closeTarjetasStatsModal();
            }
        });

        // Cerrar con ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeTarjetasStatsModal();
            }
        });
    }

    function switchTab(tabName) {
        // Crear efecto ripple
        const activeTab = document.querySelector('.stats-tab.active');
        if (activeTab) {
            createRippleEffect(activeTab);
        }

        // Actualizar clases de los tabs
        document.querySelectorAll('.stats-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            }
        });

        // Animar el indicador
        const indicator = document.getElementById('tabIndicator');
        const targetTab = document.querySelector(`.stats-tab[data-tab="${tabName}"]`);

        if (indicator && targetTab) {
            const tabRect = targetTab.getBoundingClientRect();
            const containerRect = document.getElementById('statsTabs').getBoundingClientRect();

            indicator.style.width = `${tabRect.width}px`;
            indicator.style.left = `${tabRect.left - containerRect.left}px`;
            indicator.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        }

        // Mostrar contenido según la pestaña con animación de fade
        const tabContent = document.getElementById('tabContent');
        tabContent.style.opacity = '0.5';
        tabContent.style.transform = 'translateY(10px)';

        setTimeout(() => {
            // Cambia las llamadas para usar las funciones correctas
            if (tabName === 'riesgo-problema') {
                loadRiesgoProblemaTab();
            } else if (tabName === 'riesgo-anual') {
                loadRiesgoAnualTab();
            } else if (tabName === 'responsable-cargo') {
                loadResponsableCargoTab();
            } else if (tabName === 'lider-solucion') {
                loadLiderSolucionTab();
            } else if (tabName === 'zona-riesgo') {
                loadZonaRiesgoTab();
            } else if (tabName === 'tipo-reporte') {
                loadTipoReporteTab();
            } else if (tabName === 'mensual') {
                loadMensualTab();
            }

            // Restaurar animación
            setTimeout(() => {
                tabContent.style.opacity = '1';
                tabContent.style.transform = 'translateY(0)';
                tabContent.style.transition = 'all 0.3s ease';
            }, 50);
        }, 150);
    }


    function closeTarjetasStatsModal() {
        const modal = document.getElementById('tarjetasStatsModal');
        if (modal) {
            modal.remove();
        }
    }

    function loadTarjetasStats() {
        const tableBody = document.getElementById('statsTableBody');
        const summaryContainer = document.getElementById('statsSummary');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderTarjetasStats(result.data, result.summary);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getTarjetasStats();
    }

    function renderTarjetasStats(data, summary) {
        const tableBody = document.getElementById('statsTableBody');
        const summaryContainer = document.getElementById('statsSummary');

        if (!tableBody) return;

        // Actualizar resumen
        if (summaryContainer && summary) {
            summaryContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">Total Tarjetas</div>
                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">${summary.totalTarjetas || 0}</div>
                <div style="font-size: 12px;">registradas</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">Abiertas</div>
                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">${summary.abiertas || 0}</div>
                <div style="font-size: 12px;">pendientes</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">Cerradas</div>
                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">${summary.cerradas || 0}</div>
                <div style="font-size: 12px;">gestionadas</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                <div style="font-size: 12px; opacity: 0.9;">% Gestión</div>
                <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">${summary.porcentajeGestion || '0.00'}%</div>
                <div style="font-size: 12px;">eficiencia</div>
            </div>
        `;
        }

        // Renderizar tabla
        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            const isTotal = row.isTotal;
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: #1f2937; color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (isTotal) {
                rowStyle = 'background: #374151; color: white; font-weight: 600;';
                cellStyle = 'font-weight: 600;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.tipoRiesgo || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.problema || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor};">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    function showErrorInStats(message) {
        const tableBody = document.getElementById('statsTableBody');
        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 24px;"></i>
                    </div>
                    ${message || 'Error al cargar estadísticas'}
                    <br>
                    <button onclick="loadTarjetasStats()" style="
                        margin-top: 12px;
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">
                        Reintentar
                    </button>
                </td>
            </tr>
        `;
        }
    }

    function exportTarjetasStats() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    // Crear archivo CSV
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `estadisticas_tarjetas_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })
            .exportTarjetasStatsToCSV();
    }

    // Función para cargar pestaña de Riesgo/Problema
    function loadRiesgoProblemaTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-triangle-exclamation" style="margin-right: 10px;"></i> Gestión por Riesgo y Problema asociado
            </h3>
            
            <div id="statsSummary" style="
                margin-bottom: 24px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            ">
                <!-- Resumen se cargará aquí -->
                <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9;">Total Tarjetas</div>
                    <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">registradas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9;">Abiertas</div>
                    <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">pendientes</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9;">Cerradas</div>
                    <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">gestionadas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #007bff; border-radius: 8px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9;">% Gestión</div>
                    <div style="font-size: 32px; font-weight: 700; margin: 8px 0;">0%</div>
                    <div style="font-size: 12px;">eficiencia</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Tabla Dinámica
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Tipo de Riesgo</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Problema Asociado</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

        // Cargar datos para esta pestaña
        loadRiesgoProblemaStats();
    }

    // Función para cargar pestaña de Responsable por Cargo
    function loadResponsableCargoTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-user-tie" style="margin-right: 10px;"></i> Gestión por Responsable por Cargo de la Solución
            </h3>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Tabla Dinámica
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Responsable Solución</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

        // Cargar datos para esta pestaña
        loadResponsableCargoStats();
    }

    // Funciones similares para las otras pestañas (puedes crear los templates necesarios)
    function loadLiderSolucionTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-user-check" style="margin-right: 10px;"></i> Gestión por Líder de la Solución
            </h3>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Tabla Dinámica
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportCurrentTabStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Líder de Solución</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

        loadLiderSolucionStats();
    }

    // Función para detectar la pestaña activa y cargar los datos correspondientes
    function loadCurrentTabStats() {
        const activeTab = document.querySelector('.stats-tab.active');
        if (!activeTab) return;

        const tabName = activeTab.dataset.tab;

        switch (tabName) {
            case 'riesgo-problema':
                loadRiesgoProblemaStats();
                break;
            case 'riesgo-anual':
                loadRiesgoAnualStats();
                break;
            case 'responsable-cargo':
                loadResponsableCargoStats();
                break;
            case 'lider-solucion':
                loadLiderSolucionStats();
                break;
            case 'zona-riesgo':
                loadZonaRiesgoStats();
                break;
            case 'tipo-reporte':
                loadTipoReporteStats();
                break;
            case 'mensual':
                loadMensualStats();
                break;
        }
    }

    // Función para cargar estadísticas de riesgo/problema
    function loadRiesgoProblemaStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderTarjetasStats(result.data, result.summary);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getTarjetasStats(); // Esta es tu función existente
    }

    // Función para cargar estadísticas de responsable por cargo
    function loadResponsableCargoStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderResponsableCargoStats(result.data);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getResponsableCargoStats();
    }

    // Función para cargar estadísticas de líder de solución
    function loadLiderSolucionStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderLiderSolucionStats(result.data);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getLiderSolucionStats();
    }

    function renderResponsableCargoStats(data) {
        const tableBody = document.getElementById('statsTableBody');

        if (!tableBody) return;

        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: #1f2937; color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.responsable || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor};">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    function renderLiderSolucionStats(data) {
        const tableBody = document.getElementById('statsTableBody');

        if (!tableBody) return;

        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: #1f2937; color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.lider || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor};">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    function exportCurrentTabStats() {
        const activeTab = document.querySelector('.stats-tab.active');
        if (!activeTab) return;

        const tabName = activeTab.dataset.tab;
        let functionName = '';

        switch (tabName) {
            case 'riesgo-problema':
                functionName = 'exportTarjetasStatsToCSV';
                break;
            case 'riesgo-anual':
                functionName = 'exportRiesgoAnualStatsToCSV';
                break;
            case 'responsable-cargo':
                functionName = 'exportResponsableCargoStatsToCSV';
                break;
            case 'lider-solucion':
                functionName = 'exportLiderSolucionStatsToCSV';
                break;
            // Agrega los casos para las otras pestañas
            default:
                showAlert('info', 'Exportación', 'Función de exportación no implementada para esta pestaña');
                return;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    // Crear archivo CSV
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        const date = new Date().toISOString().split('T')[0];
                        const fileName = `estadisticas_${tabName}_${date}.csv`;

                        link.setAttribute("href", url);
                        link.setAttribute("download", fileName);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })[functionName]();
    }

    function createRippleEffect(element) {
        const ripple = document.createElement('span');
        ripple.classList.add('stats-tab-ripple');

        const rect = element.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event ? event.clientX - rect.left - size / 2 : size / 2;
        const y = event ? event.clientY - rect.top - size / 2 : size / 2;

        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;

        element.appendChild(ripple);

        setTimeout(() => {
            ripple.remove();
        }, 600);
    }

    // Inicializar el indicador cuando se carga el modal
    function initTabIndicator() {
        const activeTab = document.querySelector('.stats-tab.active');
        if (activeTab) {
            const indicator = document.getElementById('tabIndicator');
            if (!indicator) return;

            const tabRect = activeTab.getBoundingClientRect();
            const containerRect = document.getElementById('statsTabs').getBoundingClientRect();

            indicator.style.width = `${tabRect.width}px`;
            indicator.style.left = `${tabRect.left - containerRect.left}px`;
            indicator.style.height = '3px';
            indicator.style.background = 'linear-gradient(90deg, #0f307f 0%, #3b82f6 100%)';
            indicator.style.position = 'absolute';
            indicator.style.bottom = '-3px';
            indicator.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            indicator.style.zIndex = '4';
            indicator.style.borderRadius = '3px 3px 0 0';
        }
    }

    // Función para cargar pestaña de Zona de Riesgo
    function loadZonaRiesgoTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-map-marker-alt" style="margin-right: 10px;"></i> Gestión por Zona de Riesgo
            </h3>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Tabla Dinámica
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadZonaRiesgoStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportZonaRiesgoStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Zona de Riesgo</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 12px; color: #1e40af;">
                    <i class="fa-solid fa-info-circle" style="font-size: 18px;"></i>
                    <div>
                        <strong>Nota:</strong> Distribución de tarjetas por área geográfica o zona funcional
                    </div>
                </div>
            </div>
        </div>
    `;

        loadZonaRiesgoStats();
    }

    // Función para cargar pestaña de Tipo de Reporte
    function loadTipoReporteTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-file-alt" style="margin-right: 10px;"></i> Gestión por Tipo de Reporte
            </h3>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Tabla Dinámica
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadTipoReporteStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportTipoReporteStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Tipo de Reporte</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 12px; color: #1e40af;">
                    <i class="fa-solid fa-info-circle" style="font-size: 18px;"></i>
                    <div>
                        <strong>Nota:</strong> Análisis por origen o método de reporte de las tarjetas
                    </div>
                </div>
            </div>
        </div>
    `;

        loadTipoReporteStats();
    }

    // Función para cargar pestaña Mensual
    function loadMensualTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">
                <i class="fa-solid fa-calendar-alt" style="margin-right: 10px;"></i> Gestión Mensual
            </h3>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #374151; font-size: 16px;">
                    <i class="fa-solid fa-table"></i> Evolución Temporal
                </h4>
                <div style="display: flex; gap: 12px;">
                    <button onclick="loadMensualStats()" style="
                        padding: 8px 16px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-rotate"></i> Actualizar
                    </button>
                    <button onclick="exportMensualStats()" style="
                        padding: 8px 16px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    ">
                        <i class="fa-solid fa-file-export"></i> Exportar CSV
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <table id="statsTable" style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                ">
                    <thead style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Año</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Mes</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <tr>
                            <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                                </div>
                                Cargando estadísticas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 12px; color: #1e40af;">
                    <i class="fa-solid fa-info-circle" style="font-size: 18px;"></i>
                    <div>
                        <strong>Nota:</strong> Evolución mensual del desempeño en la gestión de tarjetas
                    </div>
                </div>
            </div>
        </div>
    `;

        loadMensualStats();
    }

    // Función para cargar estadísticas de zona de riesgo
    function loadZonaRiesgoStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderZonaRiesgoStats(result.data);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getZonaRiesgoStats();
    }

    // Función para cargar estadísticas de tipo de reporte
    function loadTipoReporteStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderTipoReporteStats(result.data);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getTipoReporteStats();
    }

    // Función para cargar estadísticas mensuales
    function loadMensualStats() {
        const tableBody = document.getElementById('statsTableBody');

        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    Cargando estadísticas...
                </td>
            </tr>
        `;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderMensualStats(result.data);
                } else {
                    showErrorInStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas:', error);
                showErrorInStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getMensualStats();
    }

    // Función de renderizado para Zona de Riesgo
    function renderZonaRiesgoStats(data) {
        const tableBody = document.getElementById('statsTableBody');

        if (!tableBody) return;

        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.zonaRiesgo || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor}; font-weight: bold;">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    // Función de renderizado para Tipo de Reporte
    function renderTipoReporteStats(data) {
        const tableBody = document.getElementById('statsTableBody');

        if (!tableBody) return;

        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.tipoReporte || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor}; font-weight: bold;">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    // Función de renderizado para Mensual
    function renderMensualStats(data) {
        const tableBody = document.getElementById('statsTableBody');

        if (!tableBody) return;

        if (!data || data.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                    <div style="margin-bottom: 12px;">
                        <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                    </div>
                    No hay datos disponibles
                </td>
            </tr>
        `;
            return;
        }

        let html = '';
        let currentYear = '';

        data.forEach((row, index) => {
            const isYearTotal = row.isYearTotal;
            const isGlobalTotal = row.isGlobalTotal;

            let rowStyle = '';
            let cellStyle = '';

            if (isGlobalTotal) {
                rowStyle = 'background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; font-weight: 700;';
                cellStyle = 'font-weight: 700;';
            } else if (isYearTotal) {
                rowStyle = 'background: #374151; color: white; font-weight: 600;';
                cellStyle = 'font-weight: 600;';
            } else if (index % 2 === 0) {
                rowStyle = 'background: #f9fafb;';
            }

            // Determinar color para porcentaje
            let porcentajeColor = '#374151';
            if (row.porcentaje) {
                const porcentajeNum = parseFloat(row.porcentaje);
                if (porcentajeNum >= 80) porcentajeColor = '#10b981';
                else if (porcentajeNum >= 50) porcentajeColor = '#f59e0b';
                else porcentajeColor = '#ef4444';
            }

            // Mostrar año solo cuando cambia
            const yearCell = (row.ano && row.ano !== currentYear) ? row.ano : '';
            if (row.ano && row.ano !== currentYear) {
                currentYear = row.ano;
            }

            html += `
            <tr style="${rowStyle}">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${yearCell}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; ${cellStyle}">
                    ${row.mes || ''}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.abierta || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.cerrada || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}">
                    ${row.total || 0}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; ${cellStyle}; color: ${porcentajeColor}; font-weight: bold;">
                    ${row.porcentaje || '0.00%'}
                </td>
            </tr>
        `;
        });

        tableBody.innerHTML = html;
    }

    // Función de exportación para Zona de Riesgo
    function exportZonaRiesgoStats() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `estadisticas_zona_riesgo_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })
            .exportZonaRiesgoStatsToCSV();
    }

    // Función de exportación para Tipo de Reporte
    function exportTipoReporteStats() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `estadisticas_tipo_reporte_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })
            .exportTipoReporteStatsToCSV();
    }

    // Función de exportación para Mensual
    function exportMensualStats() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `estadisticas_mensual_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })
            .exportMensualStatsToCSV();
    }

    function loadRiesgoAnualTab() {
        const tabContent = document.getElementById('tabContent');

        tabContent.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="style="margin: 0 0 16px 0; color: #374151; font-size: 18px;"">
                <i class="fa-solid fa-calendar-check" style="color: #0f307f; margin-right: 10px;"></i>
                <span>Gestión por Riesgo y Problema por Año</span>
            </h3>
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 16px; gap: 12px;">
                <button onclick="loadRiesgoAnualStats()" style="
                    padding: 8px 16px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <i class="fa-solid fa-rotate"></i> Actualizar
                </button>
                <button onclick="exportRiesgoAnualStats()" style="
                    padding: 8px 16px;
                    background: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <i class="fa-solid fa-file-export"></i> Exportar CSV
                </button>
            </div>
            
            <div id="annualStatsContent">
                <!-- Aquí se cargarán las tablas organizadas por año -->
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="margin-bottom: 16px;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
                    </div>
                    <div>Cargando estadísticas por año...</div>
                </div>
            </div>
        </div>
    `;

        loadRiesgoAnualStats();
    }

    // Función para cargar las estadísticas anuales
    function loadRiesgoAnualStats() {
        const annualStatsContent = document.getElementById('annualStatsContent');

        if (!annualStatsContent) return;

        annualStatsContent.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="margin-bottom: 16px;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
            </div>
            <div>Cargando estadísticas por año...</div>
        </div>
    `;

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    renderRiesgoAnualStats(result.data, result.summary);
                } else {
                    showErrorInAnnualStats(result.message);
                }
            })
            .withFailureHandler(function (error) {
                console.error('Error cargando estadísticas anuales:', error);
                showErrorInAnnualStats('Error al cargar las estadísticas: ' + error.message);
            })
            .getRiesgoAnualStats('todos');
    }

    // Función modificada para renderizar las estadísticas anuales
    function renderRiesgoAnualStats(data, summary) {
        const annualStatsContent = document.getElementById('annualStatsContent');

        if (!annualStatsContent) return;

        if (!data || data.length === 0) {
            annualStatsContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="margin-bottom: 16px;">
                    <i class="fa-solid fa-database" style="font-size: 24px;"></i>
                </div>
                <div>No hay datos disponibles</div>
            </div>
        `;
            return;
        }

        // Estructuras de datos para ambas tablas
        const dataByTipoRiesgo = {}; // Para tabla 1: % Gestión
        const dataByTipoYProblema = {}; // Para tabla 2: Detalle por problema y año
        let globalTotalAbierta = 0;
        let globalTotalCerrada = 0;
        let globalTotalGeneral = 0;

        // Procesar los datos
        data.forEach(row => {
            const ano = row.ano || 'Sin año';
            const tipoRiesgo = row.tipoRiesgo;
            const problema = row.problema || 'Sin problema';

            // Para la tabla de % Gestión (primera tabla)
            if (!row.isGlobalTotal && !row.isYearTotal && row.isRiesgoTotal) {
                if (!dataByTipoRiesgo[tipoRiesgo]) {
                    dataByTipoRiesgo[tipoRiesgo] = {
                        anos: {},
                        totalAbierta: 0,
                        totalCerrada: 0,
                        totalGeneral: 0
                    };
                }

                if (!dataByTipoRiesgo[tipoRiesgo].anos[ano]) {
                    dataByTipoRiesgo[tipoRiesgo].anos[ano] = {
                        abierta: 0,
                        cerrada: 0,
                        total: 0
                    };
                }

                dataByTipoRiesgo[tipoRiesgo].anos[ano].abierta = row.abierta;
                dataByTipoRiesgo[tipoRiesgo].anos[ano].cerrada = row.cerrada;
                dataByTipoRiesgo[tipoRiesgo].anos[ano].total = row.total;

                dataByTipoRiesgo[tipoRiesgo].totalAbierta += row.abierta;
                dataByTipoRiesgo[tipoRiesgo].totalCerrada += row.cerrada;
                dataByTipoRiesgo[tipoRiesgo].totalGeneral += row.total;
            }

            // <CHANGE> Para la tabla detallada - estructura: Tipo → Problemas con años (no anidados)
            if (!row.isGlobalTotal && !row.isYearTotal && !row.isRiesgoTotal) {
                if (!dataByTipoYProblema[tipoRiesgo]) {
                    dataByTipoYProblema[tipoRiesgo] = {
                        detalles: [],
                        totalAbierta: 0,
                        totalCerrada: 0,
                        totalGeneral: 0
                    };
                }

                dataByTipoYProblema[tipoRiesgo].detalles.push({
                    problema: problema,
                    ano: ano,
                    abierta: row.abierta,
                    cerrada: row.cerrada,
                    total: row.total
                });

                dataByTipoYProblema[tipoRiesgo].totalAbierta += row.abierta;
                dataByTipoYProblema[tipoRiesgo].totalCerrada += row.cerrada;
                dataByTipoYProblema[tipoRiesgo].totalGeneral += row.total;
            }

            // Calcular totales globales
            if (row.isGlobalTotal) {
                globalTotalAbierta = row.abierta;
                globalTotalCerrada = row.cerrada;
                globalTotalGeneral = row.total;
            }
        });

        let html = '';

        // PRIMERA TABLA: % Gestión por Riesgo
        html += `
        <div style="margin-bottom: 32px;">
            <div style="
                background: #1d4ed8;
                color: white;
                padding: 16px 20px;
                border-radius: 8px 8px 0 0;
                box-shadow: 0 4px 6px rgba(15, 48, 127, 0.2);
            ">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-percentage" style="font-size: 20px;"></i>
                    <h4 style="margin: 0; font-size: 18px; font-weight: 600;">% Gestión por Riesgo</h4>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 40px;"></th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Tipo_Riesgo</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Año</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 120px;">Suma total</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 120px;">% Gestión</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

        // Ordenar tipos de riesgo
        const tiposRiesgoOrdenados = Object.keys(dataByTipoRiesgo).sort();
        let totalSumaAbierta = 0;
        let totalSumaCerrada = 0;
        let totalSumaTotal = 0;

        tiposRiesgoOrdenados.forEach((tipoRiesgo, index) => {
            const tipoData = dataByTipoRiesgo[tipoRiesgo];
            const rowId = `riesgo-tipo-${index}`;
            const rowStyle = index % 2 === 0 ? 'background: #ffffff;' : 'background: #f9fafb;';

            // Calcular porcentaje total del tipo de riesgo
            const porcentajeTipo = tipoData.totalGeneral > 0 ?
                ((tipoData.totalCerrada / tipoData.totalGeneral) * 100).toFixed(2) : '0.00';

            let porcentajeBgColor = '#ef4444';
            const porcentajeNum = parseFloat(porcentajeTipo);
            if (porcentajeNum >= 80) {
                porcentajeBgColor = '#10b981';
            } else if (porcentajeNum >= 50) {
                porcentajeBgColor = '#f59e0b';
            } else if (porcentajeNum > 0) {
                porcentajeBgColor = '#ef4444';
            }

            // Fila principal del tipo de riesgo (expandible)
            html += `
            <tr style="${rowStyle} cursor: pointer;" onclick="toggleRiesgoDetalle('${rowId}')">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                    <i id="icon-${rowId}" class="fa-solid fa-caret-right" style="color: #6b7280; transition: transform 0.2s;"></i>
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">${tipoRiesgo}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalAbierta}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalCerrada}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalGeneral}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${porcentajeBgColor};">${porcentajeTipo}%</td>
            </tr>
        `;

            // Filas expandibles con detalles por año
            const years = Object.keys(tipoData.anos).sort((a, b) => {
                if (a === 'Sin año') return 1;
                if (b === 'Sin año') return -1;
                return parseInt(a) - parseInt(b);
            });

            years.forEach(ano => {
                const anoData = tipoData.anos[ano];
                const porcentajeAno = anoData.total > 0 ?
                    ((anoData.cerrada / anoData.total) * 100).toFixed(2) : '0.00';

                let porcentajeAnoBgColor = '#ef4444';
                const porcentajeAnoNum = parseFloat(porcentajeAno);
                if (porcentajeAnoNum >= 80) {
                    porcentajeAnoBgColor = '#10b981';
                } else if (porcentajeAnoNum >= 50) {
                    porcentajeAnoBgColor = '#f59e0b';
                } else if (porcentajeAnoNum > 0) {
                    porcentajeAnoBgColor = '#ef4444';
                }

                html += `
                <tr id="${rowId}-${ano}" style="display: none; ${rowStyle}">
                    <td style="padding: 12px 12px 12px 40px; border-bottom: 1px solid #e5e7eb;"></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #6b7280;"></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 500;">${ano}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${anoData.abierta}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${anoData.cerrada}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${anoData.total}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: ${porcentajeAnoBgColor};">${porcentajeAno}%</td>
                </tr>
            `;
            });

            // Fila de total por tipo de riesgo
            html += `
            <tr style="background: #e5e7eb;">
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; font-weight: 700; color: #1f2937;">Total ${tipoRiesgo}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalAbierta}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalCerrada}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalGeneral}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700; color: ${porcentajeBgColor};">${porcentajeTipo}%</td>
            </tr>
        `;

            totalSumaAbierta += tipoData.totalAbierta;
            totalSumaCerrada += tipoData.totalCerrada;
            totalSumaTotal += tipoData.totalGeneral;
        });

        // Fila de suma total
        const porcentajeGlobal = totalSumaTotal > 0 ?
            ((totalSumaCerrada / totalSumaTotal) * 100).toFixed(2) : '0.00';

        let porcentajeGlobalBgColor = '#ef4444';
        const porcentajeGlobalNum = parseFloat(porcentajeGlobal);
        if (porcentajeGlobalNum >= 80) {
            porcentajeGlobalBgColor = '#10b981';
        } else if (porcentajeGlobalNum >= 50) {
            porcentajeGlobalBgColor = '#f59e0b';
        } else if (porcentajeGlobalNum > 0) {
            porcentajeGlobalBgColor = '#ef4444';
        }

        html += `
                        <tr style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); color: white;">
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;">Suma total</td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${totalSumaAbierta}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${totalSumaCerrada}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${totalSumaTotal}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; color: ${porcentajeGlobalBgColor}; border-top: 2px solid #4b5563;">${porcentajeGlobal}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

        // <CHANGE> SEGUNDA TABLA: COUNTA de Tipo_Riesgo (año fijo, problema expandible)
        html += `
        <div style="margin-bottom: 32px;">
            <div style="
                background: #1d4ed8;
                color: white;
                padding: 16px 20px;
                border-radius: 8px 8px 0 0;
                box-shadow: 0 4px 6px rgba(15, 48, 127, 0.2);
            ">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-list-check" style="font-size: 20px;"></i>
                    <h4 style="margin: 0; font-size: 18px; font-weight: 600;">COUNTA de Tipo_Riesgo</h4>
                </div>
            </div>
            
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 40px;"></th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Tipo_Riesgo</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 40px;"></th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Problema_asociado</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Año</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Abierta</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Cerrada</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 120px;">Suma total</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

        // <CHANGE> Ordenar tipos de riesgo para la segunda tabla - estructura plana con año visible
        const tiposRiesgoOrdenados2 = Object.keys(dataByTipoYProblema).sort();

        tiposRiesgoOrdenados2.forEach((tipoRiesgo, tipoIndex) => {
            const tipoData = dataByTipoYProblema[tipoRiesgo];
            const rowIdTipo = `detalle-tipo-${tipoIndex}`;
            const rowStyle = tipoIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f9fafb;';

            // Ordenar detalles por problema y año
            const detallesOrdenados = tipoData.detalles.sort((a, b) => {
                if (a.problema !== b.problema) {
                    return a.problema.localeCompare(b.problema);
                }
                if (a.ano === 'Sin año') return 1;
                if (b.ano === 'Sin año') return -1;
                return parseInt(a.ano) - parseInt(b.ano);
            });

            // Fila principal del tipo de riesgo (expandible)
            html += `
            <tr style="${rowStyle} cursor: pointer;" onclick="toggleDetalleTipo('${rowIdTipo}')">
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                    <i id="icon-${rowIdTipo}" class="fa-solid fa-caret-right" style="color: #6b7280; transition: transform 0.2s;"></i>
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">${tipoRiesgo}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalAbierta}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalCerrada}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${tipoData.totalGeneral}</td>
            </tr>
        `;

            // <CHANGE> Filas de problemas asociados con años visibles (no anidadas)
            detallesOrdenados.forEach((detalle, detalleIndex) => {
                html += `
                <tr id="${rowIdTipo}-${detalleIndex}" style="display: none; ${rowStyle}">
                    <td style="padding: 12px 12px 12px 40px; border-bottom: 1px solid #e5e7eb;"></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                        <i class="fa-solid fa-circle" style="color: #6b7280; font-size: 6px;"></i>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 500; color: #374151;">${detalle.problema}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; color: #4b5563;">${detalle.ano}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${detalle.abierta}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${detalle.cerrada}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${detalle.total}</td>
                </tr>
            `;
            });

            // Fila de total por tipo de riesgo
            html += `
            <tr style="background: #e5e7eb;">
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; font-weight: 700; color: #1f2937;">Total ${tipoRiesgo}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db;"></td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalAbierta}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalCerrada}</td>
                <td style="padding: 12px; border-bottom: 1px solid #d1d5db; text-align: center; font-weight: 700;">${tipoData.totalGeneral}</td>
            </tr>
        `;
        });

        // Fila de suma total global
        html += `
                        <tr style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); color: white;">
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;">Suma total</td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; font-weight: 700; border-top: 2px solid #4b5563;"></td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${globalTotalAbierta}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${globalTotalCerrada}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 700; border-top: 2px solid #4b5563;">${globalTotalGeneral}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

        annualStatsContent.innerHTML = html;
    }

    // Función para expandir/colapsar años en la tabla de % Gestión
    function toggleRiesgoDetalle(rowId) {
        const icon = document.getElementById('icon-' + rowId);
        const allRows = document.querySelectorAll('[id^="' + rowId + '-"]');
        const directChildren = Array.from(allRows).filter(row => {
            const id = row.id;
            const afterPrefix = id.substring(rowId.length + 1);
            return !afterPrefix.includes('-');
        });

        if (icon.classList.contains('fa-caret-right')) {
            icon.classList.remove('fa-caret-right');
            icon.classList.add('fa-caret-down');
            icon.style.transform = 'rotate(90deg)';
            directChildren.forEach(row => row.style.display = '');
        } else {
            icon.classList.add('fa-caret-right');
            icon.classList.remove('fa-caret-down');
            icon.style.transform = 'rotate(0deg)';
            directChildren.forEach(row => row.style.display = 'none');
        }
    }

    // <CHANGE> Función simplificada para expandir/colapsar tipo de riesgo (un solo nivel)
    function toggleDetalleTipo(rowId) {
        const icon = document.getElementById('icon-' + rowId);
        const allRows = document.querySelectorAll('[id^="' + rowId + '-"]');

        if (icon.classList.contains('fa-caret-right')) {
            icon.classList.remove('fa-caret-right');
            icon.classList.add('fa-caret-down');
            icon.style.transform = 'rotate(90deg)';
            allRows.forEach(row => row.style.display = '');
        } else {
            icon.classList.add('fa-caret-right');
            icon.classList.remove('fa-caret-down');
            icon.style.transform = 'rotate(0deg)';
            allRows.forEach(row => row.style.display = 'none');
        }
    }

    // Función para mostrar errores en el tab anual
    function showErrorInAnnualStats(message) {
        const annualStatsContent = document.getElementById('annualStatsContent');

        if (!annualStatsContent) return;

        annualStatsContent.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #ef4444;">
            <div style="margin-bottom: 16px;">
                <i class="fa-solid fa-exclamation-triangle" style="font-size: 24px;"></i>
            </div>
            <div style="margin-bottom: 16px; font-weight: 600;">${message || 'Error al cargar las estadísticas'}</div>
            <button onclick="loadRiesgoAnualStats()" style="
                padding: 8px 24px;
                background: linear-gradient(135deg, #0f307f 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            ">
                <i class="fa-solid fa-rotate"></i> Reintentar
            </button>
        </div>
    `;
    }

    // Función para exportar estadísticas anuales
    function exportRiesgoAnualStats() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    const csvContent = result.csv;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `estadisticas_riesgo_anual_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    showAlert('success', 'Exportado', 'Estadísticas exportadas correctamente');
                } else {
                    showAlert('error', 'Error', 'No se pudo exportar las estadísticas');
                }
            })
            .withFailureHandler(function (error) {
                showAlert('error', 'Error', 'Error al exportar: ' + error.message);
            })
            .exportRiesgoAnualStatsToCSV('todos');
    }

</script>