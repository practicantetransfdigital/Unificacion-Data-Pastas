<script>

  // Form submission
  function submitN2Form(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('.submit-btn');
    buttonStateManager.bloquear(submitBtn, 'Enviar Reporte');

    const selectedCedula = document.getElementById('selectedLeaderCedula').value;
    if (!selectedCedula) {
      alert('Por favor seleccione un lÃ­der responsable de la lista');
      buttonStateManager.desbloquear(submitBtn);
      return;
    }

    let zonaProceso = "";
    const zonaProcesoInput = document.getElementById('zonaProceso');
    if (zonaProcesoInput) {
      zonaProceso = zonaProcesoInput.value;
    }

    const otroInput = document.getElementById('otroProceso');
    if (otroInput && otroInput.value.trim() !== "") {
      zonaProceso = otroInput.value.trim();
    }

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const hour = String(now.getHours()).padStart(2, "0");
    const minute = String(now.getMinutes()).padStart(2, "0");
    const fechaLocal = `${year}-${month}-${day} ${hour}:${minute}`;

    const formData = {
      liderResponsable: selectedCedula,
      proceso: document.getElementById('proceso').value,
      zonaProceso: zonaProceso,
      anormalidad: document.getElementById('anormalidad').value,
      procesoResponsable: document.getElementById('procesoResponsable').value,
      fechaSolucion: document.getElementById('fechaSolucion').value,
      tipoReporte: 'N2',
      fecha: fechaLocal,
      nombreCedula: document.getElementById('nombreCedula').value,
      fotos: selectedFilesN2 || [] // âœ… Esto ya es Base64 igual que tarjetas
    };

    console.log("ðŸ“¸ Fotos a enviar N2 (Base64):", formData.fotos.length);
    if (formData.fotos.length > 0) {
      console.log("ðŸ“¸ Primera foto (primeros 100 chars):", formData.fotos[0].substring(0, 100));
    }

    showAlert('info', 'Enviando...', 'Procesando su reporte, por favor espere', 3000);

    google.script.run
      .withSuccessHandler(function (response) {
        buttonStateManager.desbloquear(submitBtn);
        handleSubmitSuccess(response);
      })
      .withFailureHandler(function (error) {
        buttonStateManager.desbloquear(submitBtn);
        handleError(error);
      })
      .submitN2Report(formData);
  }

  // CAMPOS DINAMICOS DEL FORM DE N2

  const zonaProceso = document.getElementById("zonaProceso");
  const otroProceso = document.getElementById("otroProceso");
  const proceso = document.getElementById("proceso");

  // Opciones dinÃ¡micas por proceso
  const opcionesPorProceso = {
    Pastificio: [
      "LÃ­nea A", "LÃ­nea B", "LÃ­nea C", "LÃ­nea D",
      "SIRCEM", "Girapasta"
    ],
    Empaque: [
      "MÃ¡quina 02", "MÃ¡quina 03", "MÃ¡quina 04", "MÃ¡quina 05", "MÃ¡quina 06",
      "MÃ¡quina 17", "MÃ¡quina 18", "MÃ¡quina 19", "MÃ¡quina 20", "MÃ¡quina 21",
      "Encartonadora PL", "Encartonadora PC", "Empaque Fideo Nestle",
      "Tolvas de Verduras", "Vaso", "Celdas RobÃ³ticas", "CEMPA"
    ],
    Molino: [
      "Dechinadora", "Sortex", "Plansifter", "Bancos Molienda",
      "Sasores", "BÃ¡sculas"
    ],
    CEDI: [
      "Racks", "Pasillos", "Muelles", "RecepciÃ³n", "Cuarto de Cargue BaterÃ­as"
    ],
    Mantenimiento: [
      "Red contraincendios", "Taller", "Cuarto de lubricantes", "Caldera", "Compresores y Bomba de vacio",
      "Torres de enfriamiento", "Contenedores", "Aire ambiente Pastificio", "Oficinas"
    ],
    Almacenes: [
      "Racks", "Pasillos", "Muelles", "RecepciÃ³n", "Cuarto de Cargue BaterÃ­as"
    ]
  };

  // Cuando cambia el proceso, actualizar las zonas
  proceso.addEventListener("change", () => {
    const seleccionado = proceso.value;
    zonaProceso.innerHTML = '<option value="">Selecciona zona</option>'; // reset

    if (opcionesPorProceso[seleccionado]) {
      opcionesPorProceso[seleccionado].forEach(op => {
        const option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        zonaProceso.appendChild(option);
      });
    }

    // Habilitar ambos otra vez
    zonaProceso.disabled = false;
    otroProceso.disabled = false;
  });

  // LÃ³gica: solo uno se puede llenar
  zonaProceso.addEventListener("change", () => {
    if (zonaProceso.value) {
      otroProceso.disabled = true;
      otroProceso.value = "";
    } else {
      otroProceso.disabled = false;
    }
  });

  otroProceso.addEventListener("input", () => {
    if (otroProceso.value.trim() !== "") {
      zonaProceso.disabled = true;
      zonaProceso.value = "";
    } else {
      zonaProceso.disabled = false;
    }
  });

</script>