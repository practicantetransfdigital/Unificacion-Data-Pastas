<script>

    /**
     * Recarga los datos de mÃ¡quinas manteniendo los filtros aplicados (igual que N2)
     */
    function reloadMaquinasKeepFilters() {
        const currentFilters = {
            proceso: document.getElementById('maquinasProcesoFilter').value,
            area: document.getElementById('maquinasAreaFilter').value,
            areaProc: document.getElementById('maquinasAreaprocFilter').value,
            search: document.getElementById('maquinasSearchByName').value
        };

        showMaquinasLoadingSpinner();

        // Recargar datos del servidor
        google.script.run
            .withSuccessHandler((reports) => {
                maquinasReports = reports;
                // Re-aplicar filtros inmediatamente despuÃ©s de recibir datos
                document.getElementById('maquinasProcesoFilter').value = currentFilters.proceso;
                document.getElementById('maquinasAreaFilter').value = currentFilters.area;
                document.getElementById('maquinasAreaprocFilter').value = currentFilters.areaProc;
                document.getElementById('maquinasSearchByName').value = currentFilters.search;

                applyMaquinasFilters();
                loadMaquinasCommentsCount();
            })
            .withFailureHandler((err) => {
                console.error('Error al recargar mÃ¡quinas:', err);
                handleMaquinasError(err);
            })
            .getMaquinasReports();
    }

    /**
     * Aplica filtros combinados al tablero de mÃ¡quinas
     */
    function applyMaquinasFilters() {
        const selectedProceso = document.getElementById('maquinasProcesoFilter').value;
        const selectedArea = document.getElementById('maquinasAreaFilter').value;
        const selectedAreaProc = document.getElementById('maquinasAreaprocFilter').value;
        const searchQuery = document.getElementById('maquinasSearchByName').value.toLowerCase();

        if (!Array.isArray(maquinasReports) || maquinasReports.length === 0) return;

        // ðŸ”¹ Empezamos filtrando desde los datos base (IGUAL QUE N2)
        let filteredReports = [...maquinasReports];

        // 1ï¸âƒ£ FILTRO: Proceso
        if (selectedProceso !== 'all') {
            filteredReports = filteredReports.filter(r =>
                r.proceso && r.proceso.trim() === selectedProceso
            );
        }

        // 2ï¸âƒ£ FILTRO: Ãrea Responsable
        if (selectedArea !== 'all') {
            filteredReports = filteredReports.filter(r =>
                r.areaResponsable && r.areaResponsable.trim() === selectedArea
            );
        }

        // 3ï¸âƒ£ FILTRO: Ãrea del Proceso
        if (selectedAreaProc !== 'all') {
            filteredReports = filteredReports.filter(r =>
                r.areaProceso && r.areaProceso.trim() === selectedAreaProc
            );
        }

        // 4ï¸âƒ£ FILTRO: BÃºsqueda por nombre del mecÃ¡nico
        if (searchQuery) {
            filteredReports = filteredReports.filter(r =>
                (r.mecanicoResponsable && r.mecanicoResponsable.toLowerCase().includes(searchQuery))
            );
        }

        console.log(`âœ… ${filteredReports.length} reportes de mÃ¡quinas tras filtros`);

        // ðŸ”¹ CORRECIÃ“N: Usar funciÃ³n que no sobreescribe maquinasReports (IGUAL QUE N2)
        updateVisibleMaquinasReportsWithDOM(filteredReports);
        loadMaquinasCommentsCount();
    }


</script>