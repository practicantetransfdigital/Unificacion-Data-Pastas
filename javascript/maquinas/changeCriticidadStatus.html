<script>

    // <CHANGE> Nueva función para cambiar criticidad desde el tablero
    function changeMaquinaCriticidad(reportId, event) {
        event.stopPropagation(); // Evitar que se active otro evento

        const criticidadOptions = [
            { value: 'Alta', label: 'Alta', color: '#dc3545' },
            { value: 'Media', label: 'Media', color: '#ffc107' },
            { value: 'Baja', label: 'Baja', color: '#28a745' }
        ];

        const existingModal = document.getElementById('maquinaCriticidadModal');
        if (existingModal) existingModal.remove();

        const overlay = document.createElement('div');
        overlay.id = 'maquinaCriticidadModal';
        overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

        const modal = document.createElement('div');
        modal.style.cssText = `
        background: #fff; padding: 1.5rem;
        border-radius: 16px; width: 90%; max-width: 400px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    `;

        modal.innerHTML = `
        <h2 style="margin-bottom: 1rem; font-size: 18px; font-weight: 600; color: #1e293b; text-align:center">
            Cambiar Criticidad
        </h2>
        <div id="maquinaCriticidadOptionsContainer" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button id="maquinaCriticidadCancelBtn" style="padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer;">Cancelar</button>
            <button id="maquinaCriticidadConfirmBtn" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: #fff; border-radius: 8px; cursor: pointer;" disabled>Confirmar</button>
        </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const container = modal.querySelector('#maquinaCriticidadOptionsContainer');
        criticidadOptions.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'criticidad-option';
            div.dataset.criticidad = opt.value;
            div.style.cssText = `
            padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
        `;
            div.innerHTML = `
            <div style="width:12px; height:12px; border-radius:50%; background:${opt.color};"></div>
            <span>${opt.label}</span>
        `;
            container.appendChild(div);
        });

        let selectedCriticidad = null;

        container.querySelectorAll('.criticidad-option').forEach(option => {
            option.addEventListener('click', () => {
                container.querySelectorAll('.criticidad-option').forEach(o => {
                    o.style.borderColor = '#e2e8f0';
                    o.style.background = '#fff';
                });
                option.style.borderColor = '#3b82f6';
                option.style.background = 'rgba(59,130,246,0.05)';
                selectedCriticidad = option.dataset.criticidad;
                modal.querySelector('#maquinaCriticidadConfirmBtn').disabled = false;
            });
        });

        modal.querySelector('#maquinaCriticidadCancelBtn').addEventListener('click', () => overlay.remove());

        modal.querySelector('#maquinaCriticidadConfirmBtn').addEventListener('click', () => {
            if (!selectedCriticidad) return;
            overlay.remove();

            showAlert('info', 'Actualizando...', 'Cambiando criticidad del reporte', 2000);

            google.script.run
                .withSuccessHandler(() => {
                    showAlert('success', 'Éxito', `Criticidad cambiada a "${selectedCriticidad}"`);
                    reloadMaquinasKeepFilters();
                })
                .withFailureHandler(err => {
                    console.error('Error:', err);
                    showAlert('error', 'Error', 'No se pudo actualizar la criticidad');
                })
                .updateMaquinaCriticidad(reportId, selectedCriticidad);
        });

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.remove();
        });
    }

</script>